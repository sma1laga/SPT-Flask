{% extends "base.html" %}
{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/inverse_z.css') }}">
{% endblock %}
{% block content %}
<div class="inverse-z-container">
  <div class="page-header text-center mb-5">
    <h1 class="text-2xl font-semibold" style="text-align:center;">Inverse z-Transform</h1>
    <p class="text-gray-600" style="text-align:center;">Enter a discrete system function \(H(z)\) to obtain the corresponding impulse response \(h[k]\).<br>
      The expression \(az^2+bz+c\) can be expressed as either <code>[a, b, c]</code> or <code>az^2+bz+c</code>.</p>
  </div>

    <form method="POST">
    <fieldset>
      <legend class="font-medium mb-2">System Function \(H(z)\)</legend>
      <label for="numerator">Numerator
        <input type="text" id="numerator" name="numerator" value="{{ default_num }}" placeholder="[1, 0]" title="Polynomial coefficients or expression in z" required>
      </label>
      <label for="denominator" style="margin-top:1rem;">Denominator
        <input type="text" id="denominator" name="denominator" value="{{ default_den }}" placeholder="[1]" title="Polynomial coefficients or expression in z" required>
      </label>
      <div class="examples" style="font-size:1.2rem;">
        <button type="button" class="example-btn" data-num="[1]" data-den="[1, -0.5]">\(\frac{1}{1-0.5z^{-1}}\)</button>
        <button type="button" class="example-btn" data-num="[1, 0]" data-den="[1, -1.5, 0.5]">\(\frac{1+0\,z^{-1}}{1-1.5z^{-1}+0.5z^{-2}}\)</button>
        <button type="button" class="example-btn" data-num="[1, -0.5]" data-den="[1, -0.2]">\(\frac{1-0.5z^{-1}}{1-0.2z^{-1}}\)</button>
      </div>
    </fieldset>

    <fieldset class="radio-group">
      <legend class="font-medium mb-2">Output Type</legend>
      <label><input type="radio" name="roc_type" value="causal" {% if roc_type == 'causal' %}checked{% endif %}> causal (|z| &gt; R)</label>
      <label><input type="radio" name="roc_type" value="anticausal" {% if roc_type == 'anticausal' %}checked{% endif %}> anticausal (|z| &lt; R)</label>
    </fieldset>

    <button type="submit" class="compute-btn">Compute</button>
    {% if error %}
      <div class="text-red-600 mt-2">{{ error }}</div>
    {% endif %}
  </form>


  {% if sf_latex %}
    <div style="text-align:center;">
      <h2>System Function</h2>
      <p>$$
        {% if sf_parts_latex %}
          \begin{align}
          H(z) &= {{ sf_latex|safe }}\\
          &= {{ sf_parts_latex|safe }}
          \end{align}
        {% else %}
          H(z) = {{ sf_latex|safe }}
        {% endif %}
      $$</p>
      {% if roc_latex %}
        <p style="margin-top:1rem;">$$ \mathrm{ROC}:\ {{ roc_latex|safe }} $$</p>
      {% endif %}
    </div>
  {% endif %}

  {% if hk_latex %}
    <div class="result">
      <h2>Impulse Response</h2>
      <p>$$ h[k] = {{ hk_latex|safe }} $$</p>
    </div>
  {% endif %}

  {% if seq_data %}
    <div class="result">
      <h3>{{ seq_title|safe }}</h3>
      <div id="hk_plot"></div>
    </div>
    <script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
    <script>
      const data = {{ seq_data|tojson }};
      const stem = (x, y, color) => ({
        x: [].concat(...x.map(xi => [xi, xi, xi])),
        y: [].concat(...y.map(yi => [0, yi, null])),
        mode: "lines",
        line: {color: color, width: 2},
        showlegend: false,
      });
      const traces = [
        stem(data.k, data.re, "#1f77b4"),
        {x: data.k, y: data.re, mode: "markers", name: "Re{h[k]}", marker: {color: "#1f77b4"}}
      ];
      if (data.im.some(v => Math.abs(v) > 1e-12)) {
        traces.push(stem(data.k, data.im, "#d62728"));
        traces.push({x: data.k, y: data.im, mode: "markers", name: "Im{h[k]}", marker: {color: "#d62728"}});
      }
      Plotly.newPlot('hk_plot', traces, {
        margin: {t: 30},
        xaxis: {title: {text: 'k'}},
        yaxis: {title: {text: 'h[k]'}},
      }, {responsive: true});
    </script>
  {% endif %}
</div>
<script>
  document.querySelectorAll('.example-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('numerator').value = btn.dataset.num;
      document.getElementById('denominator').value = btn.dataset.den;
    });
  });
</script>
{% endblock %}