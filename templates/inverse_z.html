{% extends "base.html" %}
{% block content %}
<div class="page-header" style="text-align:center;margin-bottom:20px;">
  <h1 style="font-size:2.2em;">Inverse z-Transform</h1>
  <p style="color:var(--subtext-color);">Enter a discrete system function \(H(z)\) to obtain the corresponding impulse response \(h[k]\).<br>
    The expression \(az^2+bz+c\) can be expressed as either <code>[a, b, c]</code> or <code>az^2+bz+c</code>.</p>
</div>

<form method="POST" style="max-width:500px;margin:0 auto;">
  <label for="numerator">Numerator:</label>
  <input type="text" id="numerator" name="numerator" value="{{ default_num }}" required>
  <label for="denominator" style="margin-top:10px;">Denominator:</label>

  <input type="text" id="denominator" name="denominator" value="{{ default_den }}" required>

  <label>Signal type:</label>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="roc_type" id="roc_gt" value="causal" {% if roc_type == 'causal' %}checked{% endif %}>
    <label class="form-check-label" for="roc_gt">causal (|z| &gt; R)</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="roc_type" id="roc_lt" value="anticausal" {% if roc_type == 'anticausal' %}checked{% endif %}>
    <label class="form-check-label" for="roc_lt">anticausal (|z| &lt; R)</label>
  </div>
  <button type="submit" style="margin-top:10px;">Compute</button>

</form>
{% if error %}
  <p style="color:red; text-align:center;">{{ error }}</p>
{% endif %}

{% if sf_latex %}
  <div style="text-align:center;margin-top:25px;">
    <h2>System Function</h2>
    {% if sf_parts_latex %}
      <p>$$ \begin{align}
      H(z) &= {{ sf_latex|safe }}\\
      &= {{ sf_parts_latex|safe }}
      \end{align}
      $$</p>
    {% else %}
      <p>$$ H(z) = {{ sf_latex|safe }} $$</p>
    {% endif %}

    {% if roc_latex %}
      <p style="text-align:center;margin-top:25px;">
        $$ \mathrm{ROC}:\ {{ roc_latex|safe }} $$
      </p>
    {% endif %}
  </div>
{% endif %}

{% if hk_latex %}
  <div style="text-align:center;margin-top:25px;">
    <p>$$ h[k] = {{ hk_latex|safe }} $$</p>
  </div>
{% endif %}
{% if seq_data %}

  <div style="text-align:center;margin-top:20px;">
    <h3>{{ seq_title|safe }}</h3>
    <div id="hk_plot" style="max-width:600px;height:300px;margin:0 auto;"></div>
  </div>
  <script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
  <script>
    const d = {{ seq_data|tojson }};
    const stem = (x, y, color) => ({
      x: [].concat(...x.map(xi => [xi, xi, xi])),
      y: [].concat(...y.map(yi => [0, yi, null])),
      mode: "lines",
      line: {color: color, width: 2},
      showlegend: false,
    });
    const traces = [
      stem(d.k, d.re, "#1f77b4"),
      {x: d.k, y: d.re, mode: "markers", name: "Re{h[k]}", marker: {color: "#1f77b4"}}
    ];
    if (d.im.some(v => Math.abs(v) > 1e-12)) {
      traces.push(stem(d.k, d.im, "#d62728"));
      traces.push({x: d.k, y: d.im, mode: "markers", name: "Im{h[k]}", marker: {color: "#d62728"}});
    }
    Plotly.newPlot('hk_plot', traces, {
      margin: {t: 30},
      xaxis: {title: {text: 'k'}},
      yaxis: {title: {text: 'h[k]'}},
    });
  </script>
{% endif %}
{% endblock %}