{% extends "base.html" %}
{% block content %}
  <script>document.title = "Convolution Step-by-Step Visualization – Dynamic Explorer";</script>
  <div class="page-header" style="margin-bottom: 24px; text-align: center;">
    <h1 style="font-size: 2.2em; margin-bottom: 8px;">Convolution Step-by-Step Visualization</h1>
    <p class="conv-steps">Flip/shift \(h(t-\tau)\) → Multiply \(x(\tau)h(t-\tau)\) → Integrate \(y(t)\)</p>
    <p style="font-size: 1.06em; color: var(--subtext-color); max-width: 620px; margin: 0 auto;">
      Slide \(t\) to see how the overlap between \(x(\tau)\) and \(h(t-\tau)\) produces the convolved output
      $$ y(t)=\int_{-\infty}^{\infty}x(\tau)h(t-\tau)\,\mathrm d\tau $$
    </p>
  </div>

  <div id="dynamic-form" style="max-width: 760px; margin: 0 auto; text-align: center;">
    <div class="inputs" style="display:flex; flex-wrap:wrap; justify-content:center; gap:16px; margin-bottom:14px;">
      <div>
        <label for="func1" style="font-weight:bold;">\(x(t)\):</label><br>
        <select id="func1">
          {% for label, val in functions %}
            <option value="{{ val }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="func2" style="font-weight:bold;">\(h(t)\):</label><br>
        <select id="func2">
          {% for label, val in functions %}
            <option value="{{ val }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="tauSlider" style="font-weight:bold;">Shift \(t\):</label><br>
        <input type="range" id="tauSlider" min="-3.5" max="3.5" step="0.1" value="0">
        <span id="tauValue" style="display:inline-block; width:42px; font-weight:bold;">0.0</span>
      </div>
    </div>

    <div class="controls-row">
      <button id="playPauseBtn" type="button" class="conv-action-btn" aria-label="Play animation">Play</button>
      <select id="speedSelect" aria-label="Animation speed">
        <option value="0.5">0.5×</option>
        <option value="1" selected>1×</option>
        <option value="2">2×</option>
        <option value="4">4×</option>
      </select>
      <button id="resetBtn" type="button" class="conv-secondary-btn" aria-label="Reset slider">Reset</button>
      <div id="currentValueCard" class="value-card">\(t=0.0,\;y(t)=0\)</div>
    </div>

  </div>

  <div id="dynamic-plot-wrapper" style="max-width: 700px; margin: auto;">
    <div class="trace-toggles">
      <label><input type="checkbox" id="showX" checked> x</label>
      <label><input type="checkbox" id="showShifted" checked> shifted h</label>
      <label><input type="checkbox" id="showProduct" checked> product shading</label>
    </div>
    <div id="topChart" style="height:240px; width:100%; display:block; border:1px solid #ccd0d5; border-radius:4px;"></div>
    <p class="plot-caption">Area under \(x(\tau)h(t-\tau)\) equals \(y(t)\).</p>
    <div id="inline-slider-wrapper" style="display:flex; justify-content:center; align-items:center; margin:0.35em 0;">
      <input type="range" id="tauSliderInline" min="-3.5" max="3.5" step="0.1" value="0" style="width:65%; max-width:350px; height:4px;">
    </div>
    <div id="bottomChart" style="height:220px; width:100%; margin-top:1em; display:block; border:1px solid #ccd0d5; border-radius:4px;"></div>
  </div>
  <section class="learning-section" aria-label="Convolution definition and properties">
    <h2>Convolution: definition &amp; properties</h2>

    <div class="learning-card">
      <h3>Definition</h3>
      <p class="math-line">\(y(t)=\int_{-\infty}^{\infty} x(\tau)h(t-\tau)\,d\tau\)</p>
      <p>Graphically: reverse/shift \(h\), multiply with \(x\), then integrate the overlap to get one output sample \(y(t)\).</p>
      <p>Moving the slider changes overlap, so the output curve is traced point by point.</p>
    </div>

    <div class="learning-card">
      <h3>Key properties</h3>
      <ul>
        <li><strong>Commutative:</strong> \(x*h=h*x\) — swapping inputs gives the same output.</li>
        <li><strong>Shift (delta):</strong> \(x*\delta(t-T)=x(t-T)\) — a shifted impulse shifts the signal.</li>
        <li><strong>Identity:</strong> \(x*\delta=x\) — the impulse acts like a neutral element.</li>
        <li><strong>Support hint:</strong> \(\operatorname{supp}(y)\approx\operatorname{supp}(x)+\operatorname{supp}(h)\).</li>
      </ul>
    </div>

    <div class="learning-card">
      <h3>Try it</h3>
      <div class="try-buttons">
        <button type="button" class="conv-secondary-btn mini-try-btn" id="tryIdentityBtn">Identity (delta)</button>
        <button type="button" class="conv-secondary-btn mini-try-btn" id="tryShiftBtn">Shift with delta</button>
        <button type="button" class="conv-secondary-btn mini-try-btn" id="trySwapBtn">Commutative (swap x,h)</button>
      </div>
    </div>
  </section>

  <section class="next-steps-card" aria-label="Next steps">
    <h2>Next steps</h2>
    <p>This demo visualizes graphical convolution. Use the Calculator for arbitrary signals or Training for guided exercises.</p>
    <div class="next-step-links">
      <a href="{{ url_for('convolution.convolution') }}" class="conv-action-btn">Compute full convolution (Calculator)</a>
      <a href="{{ url_for('training_convolution.training_convolution') }}" class="conv-secondary-btn">Need practice &amp; examples? See Convolution Training</a>
    </div>
  </section>

  <script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
  <script>
    let tData = [];
    let y1Data = [];
    let y2Data = [];
    let yConvData = [];
    let topChart, bottomChart;
    let rafId = null;
    let lastTs = 0;
    let animatedTau = 0;
    let hasData = false;

    const tauSlider = document.getElementById('tauSlider');
    const tauSliderInline = document.getElementById('tauSliderInline');
    const sliderMin = Number(tauSlider.min);
    const sliderMax = Number(tauSlider.max);

    function initCharts() {
      topChart = document.getElementById('topChart');
      bottomChart = document.getElementById('bottomChart');

      Plotly.newPlot(topChart, [
        { x: tData, y: y1Data, type: 'scatter', mode: 'lines', name: 'x(τ)', line: { color: 'blue', width: 2 } },
        { x: tData, y: [], type: 'scatter', mode: 'lines', name: 'h(t−τ)', line: { color: 'orange', width: 2 } },
        { x: tData, y: [], type: 'scatter', mode: 'lines', name: 'x(τ)·h(t−τ)', fill: 'tozeroy', fillcolor: 'rgba(255,0,0,0.45)', line: { color: 'red', width: 1 } }
      ], {
        margin: { t: 20, b: 40, l: 50, r: 10 },
        xaxis: { range: [-3.5, 3.5], title: 'τ' },
        yaxis: { range: [-2.1, 2.1] },
        paper_bgcolor: '#f6f7fb',
        plot_bgcolor: '#f6f7fb',
        showlegend: true
      }, {displayModeBar: false, responsive: true});

      Plotly.newPlot(bottomChart, [
        { x: tData, y: yConvData, type: 'scatter', mode: 'lines', name: 'y(t)', line: { color: 'darkblue', width: 2 } },
        { x: [], y: [], type: 'scatter', mode: 'markers', name: 'Current Output', marker: { color: 'red', size: 8 } }
      ], {
        margin: { t: 20, b: 40, l: 50, r: 10 },
        xaxis: { range: [-3.5, 3.5], title: 't' },
        paper_bgcolor: '#f6f7fb',
        plot_bgcolor: '#f6f7fb',
        showlegend: true
      }, {displayModeBar: false, responsive: true});
    }

    function fetchData() {
      fetch("{{ url_for('dynamic_convolution.dynamic_data') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          func1: document.getElementById('func1').value,
          func2: document.getElementById('func2').value
        })
      })
      .then(r => r.json().then(d => r.ok ? d : Promise.reject(d.error)))
      .then(d => {
        tData = d.t || [];
        y1Data = d.y1 || [];
        y2Data = d.y2 || [];
        yConvData = d.y_conv || [];
        hasData = tData.length > 0;
        if (!hasData) {
          setPlayButtonState(false, true);
          return;
        }
        initCharts();
        updatePlots();
        setPlayButtonState(false, false);
      })
      .catch(e => alert('Error: ' + e));
    }

    function updatePlots() {
      if (!topChart || !bottomChart || !tData.length) return;

      const tau = Number(tauSlider.value);
      document.getElementById('tauValue').textContent = tau.toFixed(1);

      const N = tData.length;
      const dt = tData[1] - tData[0];
      const y2shift = new Array(N);
      for (let i = 0; i < N; i++) {
        const want = tau - tData[i];
        const idx = (want - tData[0]) / dt;
        const lo = Math.floor(idx);
        const hi = Math.ceil(idx);
        y2shift[i] = (lo < 0 || hi >= N) ? 0 : y2Data[lo] * (1 - (idx - lo)) + y2Data[hi] * (idx - lo);
      }
      const product = y1Data.map((v, i) => v * y2shift[i]);
      Plotly.restyle(topChart, {
        y: [y1Data],
        visible: [document.getElementById('showX').checked]
      }, [0]);
      Plotly.restyle(topChart, {
        y: [y2shift],
        visible: [document.getElementById('showShifted').checked]
      }, [1]);
      Plotly.restyle(topChart, {
        y: [product],
        visible: [document.getElementById('showProduct').checked]
      }, [2]);

      const idx = (tau - tData[0]) / dt;
      let convAt = 0;
      if (idx >= 0 && idx <= N - 1) {
        const lo = Math.floor(idx), hi = Math.ceil(idx), w = idx - lo;
        convAt = yConvData[lo] * (1 - w) + yConvData[hi] * w;
      }
      Plotly.restyle(bottomChart, { x: [[tau]], y: [[convAt]] }, [1]);
      const card = document.getElementById('currentValueCard');
      card.innerHTML = `\\(t=${tau.toFixed(1)},\;y(t)=${convAt.toFixed(4)}\\)`;
      if (window.MathJax?.typesetPromise) window.MathJax.typesetPromise([card]);
    }

    function syncTau(value, origin, skipUpdate = false) {
      if (origin !== tauSlider) tauSlider.value = value;
      if (origin !== tauSliderInline) tauSliderInline.value = value;
      if (!skipUpdate) updatePlots();
    }
    function setPlayButtonState(isPlaying, disabled = false) {
      const btn = document.getElementById('playPauseBtn');
      btn.disabled = disabled;
      btn.textContent = isPlaying ? 'Pause' : 'Play';
      btn.setAttribute('aria-label', isPlaying ? 'Pause animation' : 'Play animation');
      btn.dataset.playing = isPlaying ? 'true' : 'false';
    }

    function stopAnimation() {
      if (rafId !== null) cancelAnimationFrame(rafId);
      rafId = null;
      lastTs = 0;
      animatedTau = Number(tauSlider.value);
      setPlayButtonState(false, !hasData);
    }

    function animate(ts) {
      if (!tData.length) {
        stopAnimation();
        return;
      }
      if (!lastTs) lastTs = ts;
      const elapsed = ts - lastTs;
      if (elapsed >= 20) {
        const speed = Number(document.getElementById('speedSelect').value);
        const baseRangePerSecond = (sliderMax - sliderMin) / 10;
        animatedTau += ((elapsed / 1000) * baseRangePerSecond * speed);
        const next = animatedTau;
        if (next >= sliderMax) {
          animatedTau = sliderMax;
          syncTau(sliderMax, null);
          stopAnimation();
          return;
        }
        syncTau(next, null);
        lastTs = ts;
      }
      rafId = requestAnimationFrame(animate);
    }

    function toggleAnimation() {
      if (!hasData) return;
      if (rafId !== null) {
        stopAnimation();
        return;
      }
      if (Number(tauSlider.value) >= sliderMax) syncTau(sliderMin, null);
      animatedTau = Number(tauSlider.value);
      setPlayButtonState(true, false);
      rafId = requestAnimationFrame(animate);
    }
    function applyExample({ func1, func2, tau }) {
      stopAnimation();
      if (func1 !== undefined) document.getElementById('func1').value = func1;
      if (func2 !== undefined) document.getElementById('func2').value = func2;
      syncTau(tau ?? 0, null, true);
      fetchData();
    }

    document.getElementById('func1').onchange = fetchData;
    document.getElementById('func2').onchange = fetchData;
    tauSlider.oninput = (e) => { stopAnimation(); syncTau(e.target.value, tauSlider); };
    tauSliderInline.oninput = (e) => { stopAnimation(); syncTau(e.target.value, tauSliderInline); };

    document.getElementById('playPauseBtn').onclick = toggleAnimation;
    document.getElementById('resetBtn').onclick = () => { stopAnimation(); syncTau(sliderMin, null); };
    document.getElementById('tryIdentityBtn').onclick = () => applyExample({ func2: 'delta(t)', tau: 0 });
    document.getElementById('tryShiftBtn').onclick = () => applyExample({ func2: 'delta(t)', tau: 1 });
    document.getElementById('trySwapBtn').onclick = () => {
      const func1 = document.getElementById('func1').value;
      const func2 = document.getElementById('func2').value;
      applyExample({ func1: func2, func2: func1, tau: 0 });
    };
    document.getElementById('showX').onchange = updatePlots;
    document.getElementById('showShifted').onchange = updatePlots;
    document.getElementById('showProduct').onchange = updatePlots;

    [tauSlider, tauSliderInline].forEach(slider => slider.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') stopAnimation();
    }));

    document.getElementById('func1').value = 'rect(t)';
    document.getElementById('func2').value = 'rect(t)';
    tauSlider.value = 0;
    tauSliderInline.value = 0;
    fetchData();
  </script>

  <style>
    .page-header h1 { font-weight: bold; }
    .page-header p { line-height: 1.4; }

    #dynamic-form select,
    #dynamic-form input[type="range"],
    #speedSelect {
      padding: 6px;
      border: 1px solid #ccd0d5;
      border-radius: 4px;
      font-size: 1em;
    }

    .conv-steps {
      margin: 0 auto 10px;
      max-width: 680px;
      color: var(--subtext-color);
      font-weight: 600;
      font-size: 0.98em;
    }

    .conv-action-btn,
    .conv-secondary-btn {
      border-radius: 8px;
      padding: 7px 13px;
      cursor: pointer;
      font-size: 0.96em;
      font-weight: 600;
      margin-right: 0;
    }

    .conv-action-btn {
      background: linear-gradient(135deg, #1565c0, #1e88e5);
      border: 1px solid #1565c0;
      color: #fff;
      min-width: 76px;
    }

    .conv-secondary-btn {
      border: 1px solid #b8c1ce;
      background: #eef2f7;
      color: #1f2937;
    }

    .conv-action-btn:hover,
    .conv-secondary-btn:hover {
      transform: translateY(-1px);
      filter: brightness(0.98);
    }

    .conv-action-btn:disabled,
    .conv-secondary-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .controls-row { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; align-items:center; margin-bottom:6px; }
    .value-card {
      border: 1px solid #ccd0d5;
      border-radius: 4px;
      padding: 6px 10px;
      min-width: 190px;
      text-align: center;
      font-weight: 500;
    }

    .trace-toggles { display:flex; flex-wrap:wrap; gap:14px; margin: 2px 0 8px; font-weight: 600; }
    .plot-caption { margin: 0.45em 0; font-size: 0.95em; color: var(--subtext-color); text-align:center; }
    #dynamic-form select {
      min-width: 190px;
      width: auto;
      color: #111827;
      background-color: #fff;
    }

    #speedSelect { min-width: 92px; width: auto; }

    #dynamic-plot-wrapper #topChart,
    #dynamic-plot-wrapper #bottomChart { background: #f6f7fb; }
    .learning-section,
    .next-steps-card {
      max-width: 760px;
      margin: 20px auto 0;
      padding: 14px;
      border: 1px solid #d7dce5;
      border-radius: 10px;
      background: #fafbfe;
    }

    .learning-section h2,
    .next-steps-card h2 {
      text-align: center;
      margin: 0 0 12px;
      font-size: 1.3rem;
    }

    .learning-card {
      border: 1px solid #e1e6ef;
      background: #fff;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 10px;
    }
    .learning-card h3 { margin: 0 0 6px; font-size: 1.02rem; }
    .learning-card p { margin: 4px 0; color: var(--subtext-color); }
    .math-line { font-weight: 600; color: inherit; }
    .learning-card ul { margin: 0; padding-left: 18px; }
    .learning-card li { margin: 4px 0; }
    .try-buttons { display: flex; flex-wrap: wrap; gap: 8px; }
    .mini-try-btn { font-size: 0.88em; padding: 6px 10px; }

    .next-steps-card { text-align: center; margin-top: 14px; }
    .next-steps-card p { margin: 0 0 10px; color: var(--subtext-color); }
    .next-step-links { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }

    @media (max-width: 720px) {
      .controls-row { flex-direction: column; }
      .value-card { width: 100%; max-width: 270px; }
      .try-buttons,
      .next-step-links { flex-direction: column; align-items: stretch; }
    }
  </style>
{% endblock %}
