{% extends "base.html" %}
{% block content %}
  <!-- Page Header -->
  <div class="page-header" style="margin-bottom: 30px; text-align: center;">
    <h1 style="font-size: 2.5em; margin-bottom: 10px;">Dynamic Convolution Explorer</h1>
    <p style="font-size: 1.1em; color: var(--subtext-color); max-width: 640px; margin: 0 auto;">
      Enter \(x(t)\) and \(h(t)\), press compute, and then slide \(t\) to see how the overlap between
      \(x(\tau)\) and \(h(t-\tau)\) produces the convolved output
      $$ y(t)=\int_{-\infty}^{\infty} x(\tau)h(t-\tau)\mathrm d\tau $$
    </p>
  </div>
  <p id="errorMsg" style="max-width: 760px; margin: 0 auto 16px auto; color: #d00; text-align: center; font-weight: bold;"></p>

  <!-- Controls -->
  <div id="dynamic-form" style="max-width: 900px; margin: 0 auto; text-align: center;">
    <div class="inputs" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 16px;">
      <input
        type="text"
        id="func1"
        placeholder="x(t)"
        onfocus="setActiveField(this)"
        style="width: 45%; padding: 8px; border: 1px solid #ccd0d5; border-radius: 4px; font-size: 1em;"
        value="rect(t)"
      >
      <span style="font-size: 1.5em; font-weight: bold; position: relative; top: -2px;">*</span>
      <input
        type="text"
        id="func2"
        placeholder="h(t)"
        onfocus="setActiveField(this)"
        style="width: 45%; padding: 8px; border: 1px solid #ccd0d5; border-radius: 4px; font-size: 1em;"
        value="tri(t)"
      >
    </div>

    <div class="quick-buttons functions" style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-bottom: 8px;">
      <button type="button" onclick="insertOperand('rect(t)')">\(\mathrm{rect}\)</button>
      <button type="button" onclick="insertOperand('tri(t)')">\(\mathrm{tri}\)</button>
      <button type="button" onclick="insertOperand('sin(t)')">\(\sin\)</button>
      <button type="button" onclick="insertOperand('cos(t)')">\(\cos\)</button>
      <button type="button" onclick="insertOperand('delta(t)')">\(\delta\)</button>
      <button type="button" onclick="insertOperand('step(t)')">\(\mathrm{step}\)</button>
      <button type="button" onclick="insertOperand('sign(t)')">\(\mathrm{sign}\)</button>
      <button type="button" onclick="insertOperand('exp_iwt(t)')">\(\mathrm{e}^{\mathrm{j}\omega t}\)</button>
      <button type="button" onclick="insertOperand('exp(t)*step(-t)')">\(\mathrm{e}^t\)</button>
      <button type="button" onclick="insertOperand('exp(-t)*step(t)')">\(\mathrm{e}^{-t}\)</button>
      <button type="button" onclick="insertOperand('inv_t(t)')">\(\frac{1}{t}\)</button>
      <button type="button" onclick="insertOperand('si(pi*t)')">\(\mathrm{si}\)</button>
      <button type="button" onclick="insertOperand('si(pi*t)**2')">\(\mathrm{si}^2\)</button>
    </div>

    <div class="quick-buttons operators" style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-bottom: 16px;">
      <button type="button" onclick="insertOperand('+')">\(+\)</button>
      <button type="button" onclick="insertOperand('-')">\(-\)</button>
      <button type="button" onclick="insertOperand('*')">\(\cdot\)</button>
      <button type="button" onclick="insertOperand('/')">\(/\)</button>
    </div>

    <div style="margin-bottom: 22px;">
      <button type="button" id="computeBtn" class="action-btn">Compute</button>
      <button type="button" id="clearBtn" class="action-btn">Clear</button>
    </div>

    <div class="inputs" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 20px; align-items: center;">
      <div>
        <label for="tauSlider" style="font-weight: bold;">Shift \(t\):</label><br>
        <input type="range" id="tauSlider" min="-3.5" max="3.5" step="0.1" value="0">
        <span id="tauValue" style="display: inline-block; width: 40px;">0.0</span>
      </div>
    </div>
  </div>

  <!-- Plots -->
  <div id="dynamic-plot-wrapper" style="max-width: 650px; margin: auto;">
    <canvas id="topChart" height="150" style="width: 100%; display: block; border: 1px solid #ccd0d5; border-radius: 4px;"></canvas>
    <div id="inline-slider-wrapper" style="display: flex; justify-content: center; align-items: center; margin: 0.35em 0;">
      <input
        type="range"
        id="tauSliderInline"
        min="-3.5"
        max="3.5"
        step="0.1"
        value="0"
        style="width: 65%; max-width: 350px; height: 4px;"
      >
    </div>
    <canvas id="bottomChart" height="150" style="width: 100%; margin-top: 1em; display: block; border: 1px solid #ccd0d5; border-radius: 4px;"></canvas>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let tData, y1Data, y2Data, yConvData;
    let topChart, bottomChart;
    let hasData = false;
    const errorMsg = document.getElementById("errorMsg");
    const func1 = document.getElementById("func1");
    const func2 = document.getElementById("func2");
    let activeField = func1;

    function setActiveField(f) { activeField = f; }

    function clearErrors(){
      [func1, func2].forEach(el => el.classList.remove('input-error'));
      if(errorMsg) errorMsg.textContent = "";
    }

    function insertOperand(op) {
      if (!activeField) return alert("Click in an input field first.");
      const s = activeField.selectionStart, e = activeField.selectionEnd, v = activeField.value;
      activeField.value = v.slice(0, s) + op + v.slice(e);
      activeField.selectionStart = activeField.selectionEnd = s + op.length;
      activeField.focus();
    }
    function buildDefaultAxis(){
      const min = -3.5, max = 3.5, step = 0.1;
      const n = Math.round((max - min) / step);
      return Array.from({ length: n + 1 }, (_, i) => parseFloat((min + i * step).toFixed(1)));
    }

    function setDefaultState(){
      tData = buildDefaultAxis();
      y1Data = [];
      y2Data = [];
      yConvData = [];
      hasData = false;
      initCharts();
      syncTau(0);
    }


    function fetchData(){
      clearErrors();
      const f1 = func1.value;
      const f2 = func2.value;
      fetch("{{ url_for('dynamic_convolution.dynamic_data') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ func1: f1, func2: f2 })
      })
      .then(r => r.json().then(d => r.ok ? d : Promise.reject(d.error)))
      .then(d => {
        tData     = d.t;
        y1Data    = d.y1;
        y2Data    = d.y2;
        yConvData = d.y_conv;
        hasData   = true;
        initCharts();
        updatePlots();
      })
      .catch(e => {
        if(errorMsg) errorMsg.textContent = e;
        if(/Function 1/.test(e)) func1.classList.add('input-error');
        if(/Function 2/.test(e)) func2.classList.add('input-error');
        console.error(e);
      });
    }

    function initCharts(){
      const topCtx    = document.getElementById("topChart").getContext("2d");
      const bottomCtx = document.getElementById("bottomChart").getContext("2d");

      if(topChart)    topChart.destroy();
      if(bottomChart) bottomChart.destroy();

      topChart = new Chart(topCtx, {
        type: 'line',
        data: {
          labels: tData ?? buildDefaultAxis(),
          datasets: [
            { label: "x(τ)", data: hasData ? y1Data : [], borderColor: 'blue', fill:false, pointRadius:0 },
            { label: "h(t−τ)", data: hasData ? [] : [], borderColor: '#f2a50c', fill:false, pointRadius:0 },
            { label: "x(τ)·h(t−τ)", data: hasData ? [] : [], borderColor: 'red', fill:true, backgroundColor:'rgba(255,0,0,0.2)', borderWidth:2, pointRadius:0 }
          ]
        },
        options: { animation:false, scales:{
          x:{ type:'linear', min:-3.5, max:3.5, title:{ display:true, text:'τ' } },
          y:{ min:-2.1, max:2.1 }
        } }
      });

      bottomChart = new Chart(bottomCtx, {
        type: 'line',
        data: {
          labels: tData ?? buildDefaultAxis(),
          datasets: [
            { label: "y(t)", data: hasData ? yConvData : [], borderColor: 'darkblue', fill:false, pointRadius:0 },
            { label: "Current Output", data: [], pointRadius:5, showLine:false, borderColor:'red' }
          ]
        },
        options: { animation:false, scales:{ x:{ type:'linear', min:-3.5, max:3.5, title:{ display:true, text:'t' } } } }
      });
    }

    function updatePlots(){

      const τ = parseFloat(document.getElementById("tauSlider").value);
      document.getElementById("tauValue").textContent = τ.toFixed(1);
      if(!hasData || !tData || !y1Data || !y2Data || !yConvData || tData.length === 0) return;


      const N  = tData.length;
      const dt = tData[1] - tData[0];
      let y2shift = Array(N);
      for(let i=0;i<N;i++){
        const want = τ - tData[i];
        const idx  = (want - tData[0]) / dt;
        const lo   = Math.floor(idx), hi = Math.ceil(idx);
        y2shift[i] = (lo<0||hi>=N) ? 0 : y2Data[lo]*(1-(idx-lo)) + y2Data[hi]*(idx-lo);
      }
      topChart.data.datasets[1].data = y2shift;
      topChart.data.datasets[2].data = y1Data.map((v,i) => v*y2shift[i]);
      topChart.update();

      const idx = (τ - tData[0]) / dt;
      let convAt = 0;
      if(idx>=0 && idx<=N-1){ const lo=Math.floor(idx), hi=Math.ceil(idx), w=idx-lo; convAt = yConvData[lo]*(1-w)+yConvData[hi]*w; }
      bottomChart.data.datasets[1].data = [{ x: τ, y: convAt }];
      bottomChart.update();
    }

    const tauSlider        = document.getElementById("tauSlider");
    const tauSliderInline  = document.getElementById("tauSliderInline");

    function syncTau(value, origin){
      if(origin !== tauSlider)       tauSlider.value = value;
      if(origin !== tauSliderInline) tauSliderInline.value = value;
      updatePlots();
    }

    document.getElementById("computeBtn").addEventListener("click", fetchData);
    document.getElementById("clearBtn").addEventListener("click", () => {
      func1.value = "";
      func2.value = "";
      clearErrors();
      setDefaultState();

    });

    const form = document.getElementById("dynamic-form");
    if(form){
      form.addEventListener("keydown", (event) => {
        if(event.key === "Enter"){
          event.preventDefault();
          fetchData();
        }
      });
    }

    func1.addEventListener("focus", e => activeField = e.target);
    func2.addEventListener("focus", e => activeField = e.target);
    tauSlider.oninput       = (e) => syncTau(e.target.value, tauSlider);
    tauSliderInline.oninput = (e) => syncTau(e.target.value, tauSliderInline);

    setDefaultState();
  </script>

  <!-- Styles -->
  <style>
    .page-header h1 { font-weight: bold; }
    .page-header p { line-height: 1.4; }

    #dynamic-form input[type="range"] {
      padding: 6px;
      border: 1px solid #ccd0d5;
      border-radius: 4px;
      font-size: 1em;
      accent-color: #4b6be5;
    }
    #tauValue { font-weight: bold; }

    #dynamic-plot-wrapper { position: relative; }

    /* light backgrounds for better contrast in darkmode */
    #dynamic-plot-wrapper canvas {
      background: #f6f7fb;
    }

    .quick-buttons.functions button,
    .quick-buttons.operators button {
      padding: 8px 12px;
      font-size: 0.9em;
      min-width: 60px;
      border-radius: 4px;
      background-color: #007acc;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    .quick-buttons.functions button:hover,
    .quick-buttons.operators button:hover {
      background-color: #005fa3;
    }

    .action-btn {
      padding: 8px 20px;
      font-size: 0.9em;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    #computeBtn {
      background-color: #28a745;
      color: #fff;
      margin-right: 6px;
    }
    #computeBtn:hover { background-color: #218838; }
    #clearBtn {
      background-color: #dc3545;
      color: #fff;
    }
    #clearBtn:hover { background-color: #c82333; }

    input.input-error { border-color: #d00; }
  </style>
{% endblock %}
