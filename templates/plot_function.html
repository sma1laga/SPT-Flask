{% extends "base.html" %}
{% block title %}Function Plotter{% endblock %}
{% block content %}

<div class="page-header" style="text-align:center;margin-bottom:28px;">
  <h1 style="font-size:2.5em;">Interactive Function Plotter</h1>
</div>

<p id="errorMsg" style="max-width:960px;margin:0 auto 16px auto;color:#d00;text-align:center;font-weight:bold;"></p>

<p style="max-width:960px;margin:0 auto 26px auto;text-align:center;">
  Enter Python expressions using <code>t</code> as the time variable. The
  <code>numpy</code> module is available via <code>np</code> so expressions like <code>np.abs</code> can be used. Built-in
  helpers include the constants <code>pi</code> and <code>e</code>, as well as the signals <code>rect</code>, <code>tri</code>, <code>step</code>,
  <code>delta</code>, <code>sign</code>, <code>sin</code>, <code>cos</code>, <code>exp</code>,
  <code>exp_iwt</code>, <code>inv_t</code>, <code>si</code> and additional
  functions (<code>arcsin</code>, <code>arccos</code>, <code>arctan</code>,
  <code>sinh</code>, <code>cosh</code>, <code>tanh</code>, <code>gauss</code>). Two
  expressions can be plotted simultaneously and separately adjusted with the sliders.
</p>

<p style="max-width:960px;margin:0 auto 24px auto;text-align:center;">
  The sliders apply the transformation \(a \cdot f(\frac 1 w \cdot (t - s))\).
  The <strong>shift</strong> \(s\) applies a time-shift.
  The <strong>amplitude</strong> \(a\) scales the output signal while the <strong>width</strong> \(w\) scales the time axis to stretch or compress the function.
</p>
<p style="max-width:960px;margin:0 auto 24px auto;text-align:center;">
  The rectangle and triangle functions are defined as:
  $$\mathrm{rect}(t) = \begin{cases}
    1,& |t| < \frac 1 2 \\
    0,& \text{else}
  \end{cases}$$
  $$\mathrm{tri}(t) = \begin{cases}
    1 - |t|,& |t| < 1 \\
    0,& \text{else}
  \end{cases}$$
</p>

<form id="plotForm" style="max-width:960px;margin:0 auto;text-align:center;">
  <!-- INPUT ROW --------------------------------------------------- -->
  <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:20px;">
    <input id="func1" type="text" placeholder="f₁(t) e.g. rect(t/2)*sign(t)"
           onfocus="setActiveField(this)" style="flex:1 1 300px;padding:8px;"/>
    <input id="func2" type="text" placeholder="f₂(t) (optional)"
           onfocus="setActiveField(this)" style="flex:1 1 300px;padding:8px;"/>
  </div>
  <p id="inlineError" style="color:#d00;text-align:center;font-weight:bold;margin-top:-12px;margin-bottom:12px;"></p>

  <!-- QUICK BUTTONS ---------------------------------------------- -->
  <div class="quick-buttons" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:10px;">
    <button type="button" onclick="insertOperand('rect(t)')">\(\mathrm{rect}\)</button>
    <button type="button" onclick="insertOperand('tri(t)')">\(\mathrm{tri}\)</button>
    <button type="button" onclick="insertOperand('sin(t)')">\(\sin\)</button>
    <button type="button" onclick="insertOperand('cos(t)')">\(\cos\)</button>
    <button type="button" onclick="insertOperand('step(t)')">\(\mathrm{step}\)</button>
    <button type="button" onclick="insertOperand('delta(t)')">\(\delta\)</button>
    <button type="button" onclick="insertOperand('sign(t)')">\(\mathrm{sign}\)</button>
    <button type="button" onclick="insertOperand('exp_iwt(t)')">\(\mathrm{e}^{\mathrm{j}\omega t}\)</button>
    <button type="button" onclick="insertOperand('exp(t)')">\(\mathrm{e}^{t}\)</button>
    <button type="button" onclick="insertOperand('si(pi*t)')">\(\mathrm{si}\)</button>
    <button type="button" onclick="insertOperand('si(pi*t)**2')">\(\mathrm{si}^2\)</button>
    <button type="button" onclick="insertOperand('inv_t(t)')">\(\frac 1 t\)</button> <!-- \frac not rendering in loop -->
  </div>
  <!-- Operator-Buttons in der nächsten Zeile -->
  <div class="quick-buttons operators" style="display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin-bottom:20px;">
    <button type="button" onclick="insertOperand('+')">\(+\)</button>
    <button type="button" onclick="insertOperand('-')">\(-\)</button>
    <button type="button" onclick="insertOperand('*')">\(\cdot\)</button>
    <button type="button" onclick="insertOperand('/')">\(/\)</button>
  </div>

  <!-- SPECIAL FUNCTIONS DROPDOWN -->
  <div style="text-align:center;margin-bottom:24px;">
    <select id="specialDropdown" style="padding:6px 10px;font-size:0.9em;">
      <option value="">Special functions…</option>
      <optgroup label="Trigonometric">
        <option value="arcsin(t)">arcsin</option>
        <option value="arccos(t)">arccos</option>
        <option value="arctan(t)">arctan</option>
      </optgroup>
      <optgroup label="Hyperbolic">
        <option value="sinh(t)">sinh</option>
        <option value="cosh(t)">cosh</option>
        <option value="tanh(t)">tanh</option>
      </optgroup>
      <optgroup label="Misc">
        <option value="gauss(t)">gauss</option>
      </optgroup>
    </select>
  </div>
  <!-- ACTION BUTTONS --------------------------------------------- -->
  <div style="margin-top:24px;margin-bottom:28px;">
    <button id="computeBtn" type="button" class="action-btn green">Compute</button>
    <button id="clearBtn"   type="button" class="action-btn red">Clear</button>
  </div>

  <!-- TWO GROUPS OF SLIDERS -------------------------------------- -->
  <div class="transform-wrapper">
    <!-- f₁ controls -->
    <fieldset class="transform-box">
      <button type="button" class="reset-transform" data-group="1"
              title="Reset f₁ controls" aria-label="Reset f₁ controls">↺</button>
      <legend style="color:#1f77b4;">\(f_1\)</legend>
      <div class="slider-row"><label>Shift</label><input id="shift1" type="range" min="-10" max="10" step="0.1" value="0"><span></span></div>
      <div class="slider-row"><label>Amplitude</label><input id="amp1"   type="range" min="0.1" max="5"  step="0.1" value="1"><span></span></div>
      <div class="slider-row"><label>Width</label><input id="width1" type="range" min="0.1" max="5"  step="0.1" value="1"><span></span></div>
    </fieldset>

    <!-- f₂ controls -->
    <fieldset class="transform-box">
      <button type="button" class="reset-transform" data-group="2"
              title="Reset f₂ controls" aria-label="Reset f₂ controls">↺</button>
      <legend style="color:#ff7f0e;">\(f_2\)</legend>
      <div class="slider-row"><label>Shift</label><input id="shift2" type="range" min="-10" max="10" step="0.1" value="0"><span></span></div>
      <div class="slider-row"><label>Amplitude</label><input id="amp2"   type="range" min="0.1" max="5"  step="0.1" value="1"><span></span></div>
      <div class="slider-row"><label>Width</label><input id="width2" type="range" min="0.1" max="5"  step="0.1" value="1"><span></span></div>
    </fieldset>
  </div>

</form>

<!-- PLOT ---------------------------------------------------------- -->
<div id="plotly-container" style="max-width:1200px;margin:0 auto;">
  <div id="plot" style="height:460px;"></div>
</div>

<!-- SCRIPTS ------------------------------------------------------- -->
<script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
<script>
  /* active-field logic */
  let activeField = document.getElementById("func1");
  function setActiveField(f){ activeField = f; }
  const errorMsg = document.getElementById("errorMsg");
  const inlineError = document.getElementById("inlineError");
  const inputs = [document.getElementById("func1"), document.getElementById("func2")];

  function clearErrors(){
    inputs.forEach(inp=>inp.classList.remove('input-error'));
    if(errorMsg) errorMsg.textContent = "";
    if(inlineError) inlineError.textContent = "";
  }

  function markError(pos){
    const field = activeField;
    if(!field) return;
    field.classList.add('input-error');
    if(pos !== null && pos !== undefined){
      field.focus();
      field.setSelectionRange(pos,pos);
    }
  }

  function insertOperand(op){
    if(!activeField) return;
    const s = activeField.selectionStart, e = activeField.selectionEnd, v = activeField.value;
    activeField.value = v.slice(0,s)+op+v.slice(e);
    activeField.selectionStart = activeField.selectionEnd = s + op.length;
    activeField.focus();
  }
  // dropdown for special functions
  const specialDropdown = document.getElementById("specialDropdown");
  if(specialDropdown){
    specialDropdown.addEventListener("change", ()=>{
      const val = specialDropdown.value;
      if(val){
        insertOperand(val);
        specialDropdown.selectedIndex = 0;
      }
    });
  }

  /* slider wiring ------------------------------------------------ */
  const sliderIds = ["shift1","amp1","width1","shift2","amp2","width2"];
  sliderIds.forEach(id=>{
    const slider = document.getElementById(id);
    const label  = slider.nextElementSibling; // <span>
    slider.dataset.default = slider.value;
    label.textContent = parseFloat(slider.value).toFixed(1);
    slider.addEventListener("input", ()=>{
      label.textContent = parseFloat(slider.value).toFixed(1);
      updateData();
    });
  });
  document.querySelectorAll('.reset-transform').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const group = btn.dataset.group;
      ['shift','amp','width'].forEach(prefix=>{
        const id = `${prefix}${group}`;
        const slider = document.getElementById(id);
        if(!slider) return;
        const defaultVal = slider.dataset.default ?? slider.getAttribute('value') ?? ((prefix === 'amp' || prefix === 'width') ? '1' : '0');
        slider.value = defaultVal;
        slider.nextElementSibling.textContent = parseFloat(defaultVal).toFixed(1);
      });
      updateData();
    });
  });

  function collectData(){
    const d = {};
    ["func1","func2"].forEach(id => d[id] = document.getElementById(id).value);
    sliderIds.forEach(id => d[id] = document.getElementById(id).value);
    return d;
  }

  /* update only data */
  function updateData(){
    clearErrors();
    fetch("{{ url_for('plot_function.plot_function_update') }}",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(collectData())
    })
    .then(r=>r.json())
    .then(data=>{
      if(data.error){
        if(errorMsg) errorMsg.textContent = data.error;
        if(inlineError) inlineError.textContent = data.error;
        markError(data.pos);
        console.error(data.error);
        return;
      }
      let trace_idx = 0;
      function updateTrace(t, y){
        if (!y) return;
        let update = {};
        if (Array.isArray(y)){
          update = {x: [t], y: [y]};
          Plotly.restyle("plot", update, [trace_idx]);
        }else if(y.real && y.imag){
          update = {x: [t], y: [y.real]};
          Plotly.restyle("plot", update, [trace_idx]);
          const hasImag = y.imag.some(v=>Math.abs(v)>1e-12);
          if(hasImag){
            update = {x: [t], y: [y.imag]};
            trace_idx += 1;
            Plotly.restyle("plot", update, [trace_idx]);
          }
        }
        trace_idx += 1;
      }

      updateTrace(data.t1, data.y1);
      updateTrace(data.t2, data.y2);
    })
    .catch(console.error);
  }
  /* fetch + draw ------------------------------------------------- */
  function updatePlots(){
    clearErrors();
    fetch("{{ url_for('plot_function.plot_function_update') }}",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(collectData())
    })
    .then(r=>r.json())
    .then(data=>{
      if(data.error){
        if(errorMsg) errorMsg.textContent = data.error;
        if(inlineError) inlineError.textContent = data.error;
        markError(data.pos);
        console.error(data.error);
        return;
      }
      const traces = [];

      function addTraces(t, y, name, color){
        if(!y) return;
        if(Array.isArray(y)){
          traces.push({x:t, y:y, name:name, mode:"lines",
                       line:{width:3,color:color}});
        } else if(y.real && y.imag){
          traces.push({x:t, y:y.real, name:`Re{${name}}`, mode:"lines",
                       line:{width:3,color:color}});
          const hasImag = y.imag.some(v=>Math.abs(v)>1e-12);
          if(hasImag){
            traces.push({x:t, y:y.imag, name:`Im{${name}}`, mode:"lines",
                         line:{width:3,color:color, dash:"dot"}});
          }
        }
      }
      addTraces(data.t1, data.y1, "f₁(t)", "#1f77b4");
      if(data.t2) addTraces(data.t2, data.y2, "f₂(t)", "#ff7f0e");

      const xrange = data.xrange || [-5, 5];
      Plotly.react("plot", traces,
        {margin:{t:30}, showlegend:true,
         xaxis:{title:{text:"t"}, range:xrange}, yaxis:{title:{text:"Amplitude"}}});
    })
    .catch(console.error);
  }

  /* buttons */
  document.getElementById("computeBtn").addEventListener("click", updatePlots);
  const plotForm = document.getElementById("plotForm");
  if (plotForm) {
    plotForm.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        updatePlots();
      }
    });
  }
  document.getElementById("clearBtn").addEventListener("click", ()=>{
    ["func1","func2"].forEach(id=>document.getElementById(id).value="");
    sliderIds.forEach(id=>{
      const s=document.getElementById(id); s.value=(id.includes("amp")||id.includes("width"))?1:0;
      s.nextElementSibling.textContent=parseFloat(s.value).toFixed(1);
    });
    Plotly.purge("plot");
    clearErrors();
    if(inlineError) inlineError.textContent="";
  });
</script>

<!-- STYLES ------------------------------------------------------- -->
<style>
  .quick-buttons button{
    padding:8px 12px;font-size:0.9em;border-radius:4px;background:#007acc;
    color:#fff;border:none;cursor:pointer;transition:background-color .15s;
  }
  .quick-buttons button:hover{ background:#005fa3; }

  .action-btn{ padding:8px 22px;font-size:0.9em;border-radius:4px;border:none;cursor:pointer; }
  .green{ background:#28a745;color:#fff; } .green:hover{ background:#218838; }
  .red  { background:#dc3545;color:#fff; } .red:hover  { background:#c82333; }

  .transform-wrapper{
    display:flex;flex-wrap:wrap;gap:18px;justify-content:center;
  }
  .transform-box{
    border:1px solid #d9dee3;border-radius:8px;padding:16px 22px;min-width:260px;
    background:#f8fafc;position:relative;
  }
  .reset-transform{
    position:absolute;top:-5px;right:22px;width:22px;height:22px;border:none;
    border-radius:50%;background:#2563eb;color:#fff;font-size:12px;line-height:1;
    display:flex;align-items:center;justify-content:center;cursor:pointer;
    opacity:0.75;transition:opacity .15s,background-color .15s;
  }
  .reset-transform:hover{opacity:1;background:#1d4ed8;}
  .slider-row{display:flex;align-items:center;gap:10px;margin-top:8px;}
  .slider-row label{width:90px;text-align:right;font-weight:600;}
  .slider-row span{
    width:46px;text-align:center;border:1px solid #ccd0d5;border-radius:4px;
    background:#fff;font-variant-numeric:tabular-nums;
  }
  input[type=range]{
    flex:1;appearance:none;height:4px;border-radius:2px;background:#007acc;cursor:pointer;
  }
  input[type=range]::-webkit-slider-thumb{
    appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #007acc;
  }
  
  /* Dark mode adjustments */
  body.dark-mode input[type="text"]{
    background:#2a2a2a;
    color:#f5f5f5;
    border-color:#555;
  }
  body.dark-mode .transform-box{
    background:#1f1f1f;
    border-color:#444;
  }
  body.dark-mode .reset-transform{
    background:#3b82f6;
    color:#e8edff;
  }
  body.dark-mode .reset-transform:hover{background:#2563eb;}
  body.dark-mode .slider-row span{
    background:#333;
    border-color:#555;
    color:#f5f5f5;
  }
  input.input-error{border-color:#d00;}
</style>
{% endblock %}
