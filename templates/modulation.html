{# templates/modulation.html #}
{% extends "base.html" %}

{% block title %}Modulation Lab{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Modulation Lab</h1>
  <p class="text-muted">Analog (AM/FM/PM) exploration with SNR control, spectra and presets.</p>
</div>
<div class="card intro-card">
  <h2 class="section-title">What is happening here?</h2>
  <p>
    Modulation shapes a high-frequency carrier \(c(t)=A_c \cos(2\pi f_c t)\) with a message \(m(t)\) so it can be
    transmitted or analyzed efficiently. In this lab you can explore how different analog schemes affect the
    resulting waveform and how noisy channels distort them.
  </p>
  <ul class="section-list">
    <li><strong>Amplitude Modulation (AM):</strong> \(s_{AM}(t) = A_c\bigl[1 + m(t)\bigr]\cos(2\pi f_c t)\)</li>
    <li><strong>Frequency Modulation (FM):</strong> \(s_{FM}(t) = A_c \cos\bigl(2\pi f_c t + \beta \sin(2\pi f_m t)\bigr)\)</li>
    <li><strong>Phase Modulation (PM):</strong> \(s_{PM}(t) = A_c \cos\bigl(2\pi f_c t + k_p m(t)\bigr)\)</li>
  </ul>
  <p class="section-subtitle">
    Try different presets, tweak the modulation parameters and observe the spectra and demodulated signal below.
  </p>
</div>

<style>
  /* Shared module layout */
  .module-wrap { display: grid; grid-template-columns: 1fr; gap: 16px; }
  .card        { border: 1px solid var(--border-color, #ddd); border-radius: 10px; padding: 12px; background: var(--surface, #fff); }
  .intro-card  { margin-bottom: 8px; }
  .section-title { margin: 0 0 8px; font-size: 1.15rem; font-weight: 600; color: var(--text-strong, #222); }
  .section-list { margin: 0; padding-left: 20px; }
  .section-subtitle { margin: 8px 0 0; color: var(--text-muted, #666); font-size: 0.9rem; }
  .h          { font-weight: 700; margin: 8px 0; }
  .muted      { color: #666; font-size: .9rem; }
  .pad        { padding: 4px 0; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; color: #666; }
  .row        { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; align-items: end; }
  .plots      { display: grid; grid-template-columns: 1fr; gap: 16px; }
  .plots.is-wide { grid-template-columns: repeat(auto-fit, minmax(480px, 1fr)); }
  .plot-block { display: flex; flex-direction: column; }
  .plot-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--text-strong, #222); }
  .plot       { min-height: 340px; }
  .snr-card { border-top: 1px solid var(--border-color, #ddd); margin-top: 12px; padding-top: 12px; }
  .snr-summary table { width: 100%; border-collapse: collapse; font-size: 0.85rem; color: var(--text, #333); }
  .snr-summary th, .snr-summary td { border-top: 1px solid var(--border-color, #e0e0e0); padding: 6px 4px; text-align: left; vertical-align: top; }
  .snr-summary tr:first-child th, .snr-summary tr:first-child td { border-top: none; }
  .snr-summary .active { background: rgba(0, 128, 255, 0.08); color: var(--text-strong, #111); }
  label { display:flex; flex-direction: column; gap: 4px; font-size: 0.9rem; }
  select,
  input[type="range"] { font-size: 0.9rem; }
  select { padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border-color, #ccc); max-width: 220px; }
  input[type="range"] { width: 100%; height: 22px; }
  .row small { font-size: 0.75rem; }
  #facts { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
  #facts .fact-text { font-size: 0.9rem; color: var(--text-muted, #666); }
  .fact-badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; background: rgba(14, 165, 233, 0.12); color: #0369a1; font-weight: 600; font-size: 0.75rem; white-space: nowrap; }
  @media (max-width: 768px) {
    .row { grid-template-columns: 1fr 1fr; }
    select { max-width: 100%; }
  }
  @media (max-width: 540px) {
    .row { grid-template-columns: 1fr; }
  }
</style>

<div class="module-wrap">

  <!-- CONTROLS -->
  <div class="card">
    <div class="h">Modulation controls</div>

    <div class="row">
      <label>Preset:
        <select id="preset">
          <option value="">— choose preset —</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label>Type (mod):
        <select id="mod_type">
          <option>AM</option><option>FM</option><option>PM</option><option>QAM</option>
        </select>
      </label>
      <label>Type (demod):
        <select id="demod_type">
          <option>AM</option><option>FM</option><option>PM</option><option>QAM</option>
        </select>
      </label>
    </div>
    <div id="qam_controls" style="display:none" class="card">
      <div class="h">QAM</div>
      <div class="row">
        <label>fc
          <input id="qam_fc" type="range" min="20" max="3000" step="10" value="500">
          <div><small id="qam_fc_val">500</small></div>
        </label>
        <label>fm
          <input id="qam_fm" type="range" min="1" max="50" step="1" value="5">
          <div><small id="qam_fm_val">5</small></div>
        </label>
      </div>
      <div class="row">
        <label>I amplitude
          <input id="qam_i_amp" type="range" min="0" max="1.5" step="0.05" value="0.8">
          <div><small id="qam_i_amp_val">0.8</small></div>
        </label>
        <label>Q amplitude
          <input id="qam_q_amp" type="range" min="0" max="1.5" step="0.05" value="0.8">
          <div><small id="qam_q_amp_val">0.8</small></div>
        </label>
      </div>
      <div class="row">
        <label>Phase error [deg]
          <input id="qam_phase_error" type="range" min="-90" max="90" step="1" value="0">
          <div><small id="qam_phase_error_val">0</small></div>
        </label>
      </div>
      <label class="pad"><input type="checkbox" id="qam_show_mixers"> Show mixers (cos/sin)</label>
    </div>
    <div class="row">
      <label>fs [Hz]
        <input id="fs" type="range" min="500" max="20000" step="100" value="4000">
        <div><small id="fs_val">4000</small></div>
      </label>
      <label>Duration [s]
        <input id="t_end" type="range" min="0.2" max="3.0" step="0.1" value="1.0">
        <div><small id="t_end_val">1.0</small></div>
      </label>
    </div>

    <div id="am_controls" style="display:none" class="card">
      <div class="h">AM</div>
      <div class="row">
        <label>fc
          <input id="am_fc" type="range" min="20" max="2000" step="10" value="300">
          <div><small id="am_fc_val">300</small></div>
        </label>
        <label>fm
          <input id="am_fm" type="range" min="1" max="50" step="1" value="5">
          <div><small id="am_fm_val">5</small></div>
        </label>
      </div>
      <div class="row">
        <label>AM mode
          <select id="am_carrier">
            <option value="with" selected>with carrier</option>
            <option value="without">without carrier (ZSB / DSB-SC)</option>
            <option value="ssb_regel">single-sideband EM (Regellage)</option>
            <option value="ssb_kehr">single-sideband EM (Kehrlage)</option>
          </select>
        </label>
      </div>
      <label>m (mod depth)
        <input id="am_m" type="range" min="0" max="1.2" step="0.05" value="0.5">
        <div><small id="am_m_val">0.5</small></div>
      </label>
    </div>

    <div id="fm_controls" style="display:none" class="card">
      <div class="h" id="fm_header">FM</div>
      <div class="row">
        <label>fc
          <input id="fm_fc" type="range" min="20" max="3000" step="10" value="500">
          <div><small id="fm_fc_val">500</small></div>
        </label>
        <label>fm
          <input id="fm_fm" type="range" min="1" max="50" step="1" value="5">
          <div><small id="fm_fm_val">5</small></div>
        </label>
      </div>
      <label id="beta_label">β (mod index):
        <input id="fm_beta" type="range" min="0" max="5" step="0.1" value="1.5">
        <div><small id="fm_beta_val">1.5</small></div>
      </label>
    </div>

    <div class="card">
      <div class="h">Noise &amp; Spectrum</div>
      <div class="row">
        <label><input type="checkbox" id="snr_toggle" checked> Add AWGN</label>
        <label>SNR [dB]
          <input id="snr_db" type="range" min="0" max="50" step="1" value="30">
          <div><small id="snr_db_val">30</small></div>
        </label>
      </div>
      <label class="pad"><input type="checkbox" id="show_spectrum" checked> Show Spectra</label>
    </div>

    <div class="muted" id="facts"></div>
  </div>

  <!-- PLOTS -->
  <div class="card">
    <div class="plots" id="plots_grid">
      <div class="plot-block">
        <div class="plot-title">Modulation &mdash; time domain</div>
        <div id="mod_plot" class="plot"></div>
      </div>
      <div class="plot-block">
        <div class="plot-title">Demodulation &mdash; time domain</div>
        <div id="demod_plot" class="plot"></div>
      </div>
      <div class="plot-block">
        <div class="plot-title">Modulation spectrum</div>
        <div id="spec_plot" class="plot"></div>
      </div>
      <div class="plot-block">
        <div class="plot-title">Demodulation spectrum</div>
        <div id="spec_demod_plot" class="plot"></div>
      </div>
    </div>
    <div id="snr_card" class="snr-card">
      <div class="plot-title" style="margin-top:12px;">NF &amp; SNR efficiency</div>
      <div class="muted" style="margin-bottom:8px;">Theoretical baseband SNR and efficiency for common AM variants.</div>
      <div id="snr_summary" class="snr-summary muted"></div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
  <script>
    (function () {
      const root = "{{ request.script_root }}"; 
      window.MOD_URLS = {
        presets:  root + "/modulation/api/presets",
        modulate: root + "/modulation/api/modulate",
        demod:    root + "/modulation/api/demodulate"
      };
    })();
  </script>

  <script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/modulation.js') }}"></script>
{% endblock %}

