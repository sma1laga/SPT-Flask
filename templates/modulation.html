{# templates/modulation.html #}
{% extends "base.html" %}

{% block title %}Modulation Lab{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Modulation Lab</h1>
  <p class="text-muted">Analog (AM/FM/PM) &amp; Pulse (PAM/PWM/PPM/PCM) with SNR, spectra, presets — plus a digital mini-lab.</p>
</div>

<style>
  /* Stacked layout: controls above plots, one under another */
  .mod-wrap { display: grid; grid-template-columns: 1fr; gap: 16px; }
  .card     { border: 1px solid var(--border-color, #ddd); border-radius: 10px; padding: 12px; background: var(--surface, #fff); }
  .h        { font-weight: 700; margin: 8px 0; }
  .muted    { color: #666; font-size: .9rem; }
  .pad      { padding: 4px 0; }
  .row      { display: grid; grid-template-columns: 1fr; gap: 10px; }
  .plots    { display: grid; grid-template-columns: 1fr; gap: 12px; }
  .plot     { min-height: 340px; }
  label { display:block; }
  input[type="range"] { width: 100%; }
</style>

<div class="mod-wrap">

  <!-- CONTROLS -->
  <div class="card">
    <div class="h">Modulation controls</div>

    <div class="row">
      <label>Preset:
        <select id="preset">
          <option value="">— choose preset —</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label>Type (mod):
        <select id="mod_type">
          <option>AM</option><option>FM</option><option>PM</option>
          <option>PAM</option><option>PWM</option><option>PPM</option><option>PCM</option>
        </select>
      </label>
      <label>Type (demod):
        <select id="demod_type">
          <option>AM</option><option>FM</option><option>PM</option>
          <option>PAM</option><option>PWM</option><option>PPM</option><option>PCM</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label>fs [Hz]
        <input id="fs" type="range" min="500" max="20000" step="100" value="4000">
        <div><small id="fs_val">4000</small></div>
      </label>
      <label>Duration [s]
        <input id="t_end" type="range" min="0.2" max="3.0" step="0.1" value="1.0">
        <div><small id="t_end_val">1.0</small></div>
      </label>
    </div>

    <div id="am_controls" style="display:none" class="card">
      <div class="h">AM</div>
      <div class="row">
        <label>fc
          <input id="am_fc" type="range" min="20" max="2000" step="10" value="300">
          <div><small id="am_fc_val">300</small></div>
        </label>
        <label>fm
          <input id="am_fm" type="range" min="1" max="50" step="1" value="5">
          <div><small id="am_fm_val">5</small></div>
        </label>
      </div>
      <label>m (mod depth)
        <input id="am_m" type="range" min="0" max="1.2" step="0.05" value="0.5">
        <div><small id="am_m_val">0.5</small></div>
      </label>
    </div>

    <div id="fm_controls" style="display:none" class="card">
      <div class="h" id="fm_header">FM</div>
      <div class="row">
        <label>fc
          <input id="fm_fc" type="range" min="20" max="3000" step="10" value="500">
          <div><small id="fm_fc_val">500</small></div>
        </label>
        <label>fm
          <input id="fm_fm" type="range" min="1" max="50" step="1" value="5">
          <div><small id="fm_fm_val">5</small></div>
        </label>
      </div>
      <label id="beta_label">β (mod index):
        <input id="fm_beta" type="range" min="0" max="5" step="0.1" value="1.5">
        <div><small id="fm_beta_val">1.5</small></div>
      </label>
    </div>

    <div id="pulse_controls" style="display:none" class="card">
      <div class="h" id="pulse_header">Pulse</div>
      <div class="row">
        <label>PRF
          <input id="pm_prf" type="range" min="5" max="200" step="1" value="40">
          <div><small id="pm_prf_val">40</small></div>
        </label>
        <label>fm
          <input id="pm_fm" type="range" min="1" max="50" step="1" value="4">
          <div><small id="pm_fm_val">4</small></div>
        </label>
      </div>
      <div id="pcm_levels_group">
        <label>PCM levels
          <input id="pm_levels" type="range" min="2" max="64" step="1" value="8">
          <div><small id="pm_levels_val">8</small></div>
        </label>
      </div>
    </div>

    <div class="card">
      <div class="h">Noise &amp; Spectrum</div>
      <div class="row">
        <label><input type="checkbox" id="snr_toggle" checked> Add AWGN</label>
        <label>SNR [dB]
          <input id="snr_db" type="range" min="0" max="50" step="1" value="30">
          <div><small id="snr_db_val">30</small></div>
        </label>
      </div>
      <label class="pad"><input type="checkbox" id="show_spectrum" checked> Show Spectra</label>
    </div>

    <div class="muted" id="facts"></div>
  </div>

  <!-- PLOTS -->
  <div class="card">
    <div class="plots">
      <div id="mod_plot" class="plot"></div>
      <div id="demod_plot" class="plot"></div>
      <div id="spec_plot" class="plot"></div>
      <div id="spec_demod_plot" class="plot"></div>
    </div>
  </div>

  <!-- digital mini lab -->
  <div class="card">
    <div class="h">Digital mini-lab (ASK/PSK/FSK)</div>

    <div class="row">
      <label>Scheme
        <select id="dig_type">
          <option>ASK</option><option>PSK</option><option>FSK</option>
        </select>
      </label>
      <label>Demod view
        <select id="dig_demod">
          <option>ASK</option><option>PSK</option><option>FSK</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label>fc
        <input id="dig_fc" type="range" min="20" max="2000" step="10" value="300">
        <div><small id="dig_fc_val">300</small></div>
      </label>
      <label>bit rate
        <input id="dig_br" type="range" min="2" max="100" step="1" value="20">
        <div><small id="dig_br_val">20</small></div>
      </label>
    </div>

    <div id="dev_group">
      <label>FSK deviation
        <input id="dig_dev" type="range" min="2" max="200" step="1" value="40">
        <div><small id="dig_dev_val">40</small></div>
      </label>
    </div>

    <div class="plots" style="margin-top:12px">
      <div id="dig_plot" class="plot"></div>
      <div id="dig_demod_plot" class="plot"></div>
      <div id="dig_constellation" class="pad"></div>
      <div id="dig_constellation_plot" class="plot" style="height:300px"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script>
    (function () {
      const root = "{{ request.script_root }}"; 
      window.MOD_URLS = {
        presets:  root + "/modulation/api/presets",
        modulate: root + "/modulation/api/modulate",
        demod:    root + "/modulation/api/demodulate"
      };
    })();
  </script>

  <script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/modulation.js') }}"></script>
  <script src="{{ url_for('static', filename='js/digital_modulation.js') }}"></script>
{% endblock %}

