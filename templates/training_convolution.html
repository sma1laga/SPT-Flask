{% extends "base.html" %}
{% block content %}
  <!-- Page Header -->
  <div class="page-header" style="margin-bottom: 30px; text-align: center;">
    <h1 style="font-size: 2.5em; margin-bottom: 10px;">Convolution Training</h1>
    <p style="font-size: 1.1em; color: var(--subtext-color); max-width: 600px; margin: 0 auto;">
      Practice computing convolutions with customizable difficulty. Generate problems, inspect the plot, and select the correct answer.</p>
  </div>

  <!-- Controls -->
  <div class="controls" style="max-width: 700px; margin: 0 auto 30px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px; text-align: center;">
    <div class="radio-group">
      <label class="radio-label"><input type="radio" name="difficulty" value="EASY" checked> Easy</label>
      <label class="radio-label"><input type="radio" name="difficulty" value="MEDIUM"> Medium</label>
      <label class="radio-label"><input type="radio" name="difficulty" value="HARD"> Hard</label>
    </div>
    <button id="generateBtn" class="action-btn">Generate Problem</button>
  </div>

  <!-- Plot Container -->
  <div class="plot-container" style="text-align: center; margin-bottom: 20px;">
    <img id="conv_plot_image" src="" alt="Training Convolution Plot" style="display:none; max-width:100%; border:1px solid #ccd0d5; border-radius:4px;">
  </div>

  <!-- Answer Options -->
  <div class="options" style="max-width: 700px; margin: 0 auto 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
    <button class="option-btn action-btn" data-index="0">\(y_1(t)\)</button>
    <button class="option-btn action-btn" data-index="1">\(y_2(t)\)</button>
    <button class="option-btn action-btn" data-index="2">\(y_3(t)\)</button>
    <button class="option-btn action-btn" data-index="3">\(y_4(t)\)</button>
    <button id="nextBtn" class="action-btn" style="display:none;">Next Problem</button>
  </div>

  <!-- Feedback -->
  <div id="feedback" class="feedback" style="text-align: center; font-size: 1.1em; color: var(--text-color); min-height: 1.2em;"></div>

  <!-- Exam Link -->
  <p style="text-align: center; margin-top: 30px;">
    Want a 10-question exam? <a href="{{ url_for('exam_convolution.start_exam') }}" class="link-btn">Take the Convolution Exam</a>
  </p>

  <!-- Scripts -->
<script>
  // --- State ---
  let correctIndex = null;

  // Prefetch pipeline state
  let cachedProblem = null;     // { plot_data, correctIndex,...}
  let cachedDiff = null;        // difficulty string this cache was created for
  let prefetchCtrl = null;      // abbortController for in-flight prefetch
  let prefetchInFlight = false; // flag to avoid duplicate prefetches
  let answeredThisRound = false;// to trigger prefetch only once per problem

  // --- Hooks ---
  document.getElementById('generateBtn').addEventListener('click', () => {
    destroyPrefetch();          // user chose something else -> drop cached
    generateProblem();
  });

  document.querySelectorAll('.option-btn').forEach(btn => {
    btn.addEventListener('click', () => checkAnswer(parseInt(btn.dataset.index)));
  });

  document.getElementById('nextBtn').addEventListener('click', onNextProblemClick);

  // Destroy cache when difficulty changes (user did something else)
  document.querySelectorAll('input[name="difficulty"]').forEach(radio => {
    radio.addEventListener('change', () => {
      destroyPrefetch();
      hidePlot();
      document.getElementById('nextBtn').style.display = 'none';
      showFeedback('Difficulty changed. Generate a problem.');
    });
  });

  // --- Helpers ---
  function getDifficulty() {
    return document.querySelector('input[name="difficulty"]:checked').value;
  }

  function req(url, payload, signal) {
    return fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload),
      signal
    }).then(r => r.json());
  }

  function renderProblemFromData(data) {
    if (data.error) {
      showFeedback('Error: ' + data.error);
      return;
    }
    const img = document.getElementById('conv_plot_image');
    img.src = 'data:image/png;base64,' + data.plot_data;
    img.style.display = 'block';
    correctIndex = data.correctIndex;

    // Reset UI for anorger diff.
    const optBtns = document.querySelectorAll('.option-btn');
    optBtns.forEach(b => {
      b.classList.remove('correct', 'incorrect');
      b.disabled = false;
    });
    document.getElementById('nextBtn').style.display = 'inline-block';
    showFeedback('Problem generated. Select the correct option.');

    //  at a fresh round
    answeredThisRound = false;
  }

  function hidePlot() {
    const img = document.getElementById('conv_plot_image');
    img.style.display = 'none';
    img.removeAttribute('src');
  }

  // Main flows 
  function generateProblem() {
    const diff = getDifficulty();
    if (!diff) return showFeedback('Please select a difficulty first!');
    // Render fresh problem from server
    req("{{ url_for('training_convolution.generate_problem') }}", { difficulty: diff })
      .then(data => renderProblemFromData(data))
      .catch(() => showFeedback('Error generating problem.'));
  }

  function onNextProblemClick() {
    const diff = getDifficulty();

    // If we have a warm problem for this difficulty -> instant render
    if (cachedProblem && cachedDiff === diff) {
      const warm = cachedProblem;
      cachedProblem = null; // consume cache
      renderProblemFromData(warm);
      // Immediately start prefetch for the next problem
      prefetchNextProblem();
    } else {
      // No cache available -> normal generation
      generateProblem();
    }
  }

  function checkAnswer(selected) {
    if (correctIndex === null) return showFeedback('Please generate a problem first!');
    req("{{ url_for('training_convolution.check_answer') }}", {
      selectedIndex: selected, correctIndex: correctIndex
    })
    .then(data => {
      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach(b => b.disabled = true);
      buttons[correctIndex].classList.add('correct');
      if (selected !== correctIndex) buttons[selected].classList.add('incorrect');
      showFeedback(data.feedback || '');

      // Kick off background prefetch ONCE per round
      if (!answeredThisRound) {
        answeredThisRound = true;
        prefetchNextProblem();
      }
    })
    .catch(() => showFeedback('Error checking answer.'));
  }

  // --- Prefetch pipeline ---
  function prefetchNextProblem() {
    const diff = getDifficulty();

    // If something is in-flight or we already have a warm one for this diff, skip
    if (prefetchInFlight) return;
    if (cachedProblem && cachedDiff === diff) return;

    // Abort any old prefetch
    destroyPrefetch(false);

    prefetchCtrl = new AbortController();
    prefetchInFlight = true;
    cachedProblem = null;
    cachedDiff = diff;

    req("{{ url_for('training_convolution.generate_problem') }}", { difficulty: diff }, prefetchCtrl.signal)
      .then(data => {
        // Only keep it if difficulty still matches current selection
        if (getDifficulty() === diff) {
          cachedProblem = data;
          cachedDiff = diff;
        }
      })
      .catch(() => { /* aborted or failed -> ignore */ })
      .finally(() => { prefetchInFlight = false; });
  }

  function destroyPrefetch(abort = true) {
    if (abort && prefetchCtrl) {
      try { prefetchCtrl.abort(); } catch(_) {}
    }
    prefetchCtrl = null;
    prefetchInFlight = false;
    cachedProblem = null;
    cachedDiff = null;
  }

  function showFeedback(msg) {
    document.getElementById('feedback').innerText = msg;
  }
</script>


  <!-- Styles -->
  <style>
    .radio-group { display: flex; gap: 15px; }
    .radio-label { font-size: 1em; }
    .radio-label input { margin-right: 6px; }
    .action-btn {
      padding: 10px 20px;
      background-color: #007acc;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.2s ease;
    }
    .action-btn:hover { background-color: #005fa3; }
    #nextBtn {
      background-color: #3CB371;
    }
    #nextBtn:hover { background-color: #2E8B57; }
    .feedback { min-height: 1.4em; margin-top: 10px; }
    .link-btn {
      color: #007acc;
      text-decoration: none;
      font-weight: bold;
    }
    .link-btn:hover { text-decoration: underline; }
    .option-btn.correct { background-color: #28a745; }
    .option-btn.incorrect { background-color: #c0392b; }
  </style>
{% endblock %}