{% extends "base.html" %}
{% block title %}Discrete Fourier Transform Plotter{% endblock %}

{% block content %}
<div class="page-header" style="text-align:center;margin-bottom:28px;">
  <h1 style="font-size:2.4em;">Discrete Fourier Transform</h1>
<p style="max-width:720px;margin:8px auto 0;text-align: left;color:var(--subtext-color);font-size:1em;">
  <strong>1 — Size:</strong> Pick a sequence length \(L\) and DFT length \(M\).<br>
  <strong>2 — Input:</strong> Type any Python-style expression to define \(x[k]\), e.g., <code>sin[2*pi*k/L]</code> or <code>0.8**k * step[k]</code>.<br>
  <strong>3 — Sliders:</strong> Shift circularly (\(s\)), rescale (\(a\)), or stretch (\(w\)) the input signal, resulting in $$a\cdot x[\frac 1 w ((k-s)\mod L)].$$<br>
  <strong>4 — Compute:</strong> On clicking <b>Compute</b>, the page plots \(x[k]\) as well as the DFT magnitude \(|X[\mu]|\) and phase \(\varphi (X[\mu])\).
</p>
<p style="max-width:720px;margin:8px auto 0;color:var(--subtext-color);font-size:1em;">
  The DFT of length \(M\) is defined as
  $$ \mathrm{DFT}_M\{x[k]\} = X[\mu] = \sum_{k=0}^{M-1} x[k] \omega_M^{\mu k},\quad \omega_M=\mathrm e^{-\mathrm j\frac{2\pi}{M}},\quad \mu=0,\dots,M-1,$$
  with twiddle factor \(\omega_M\) and discrete frequency \(\mu\).
  <!-- The DFT can be computed efficiently using the
  <a href="{{ url_for('fft.fft') }}">Fast Fourier Transform (FFT)</a>. -->
</p>
  <a href="{{ url_for('static', filename='docs/dft.pdf') }}" target="_blank" class="subtle-btn">DFT Correspondence Table</a>

</div>
<!-- TODO under revision
<div style="text-align:center;margin-bottom:20px;">
  <a href="{{ url_for('fft.fft') }}" class="action-btn green">Fast Fourier Transform Demo</a>
</div> -->


<form id="dftForm" style="max-width:960px;margin:0 auto;text-align:center;">
  <!-- BASIC INPUTS ------------------------------------------------ -->
  <div style="display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-bottom:18px;">
    <label><b>Signal length L:</b></label>
    <input id="L" type="number" min="1" max="256" value="8" style="width:80px;">
    <label><b>DFT length M:</b></label>
    <input id="M" type="number" min="1" max="256" value="8" style="width:80px;">
  </div>

  <div style="margin-bottom:16px;">
    <input id="func" type="text" placeholder="x[k]  e.g.  sin[2*pi*k/L]"
           onfocus="activeField=this" style="width:90%;padding:8px;">
  </div>

  <!-- QUICK BUTTONS ---------------------------------------------- -->
  <div class="quick-buttons" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:24px;">
    {% for lbl, ltx in [
      ('rect_L/2[k]', '\mathrm{rect}_{L/2}'),
      ('tri_L/2[k-L/2]', '\mathrm{tri}_{L/2}'),
      ('delta[k]', '\mathrm{delta}'),
      ('sign[k-L/2]', '\mathrm{sign}'),
      ('sin[2*pi*k/L]', '\sin'),
      ('cos[2*pi*k/L]', '\cos'),
      ('si[(k-L/2)/2]', '\mathrm{si}'),
      ('exp[j*2*pi/L*k]*step[k]', '\mathrm{exp}'),
      ('0.5**k * step[k]', '0.5^k'),
      ] %}
      <button type="button" onclick="insertOperand('{{ lbl }}')">
        \( {{ ltx }} \)
      </button>
    {% endfor %}
    <button type="button" onclick="insertOperand('+')">\(+\)</button>
    <button type="button" onclick="insertOperand('-')">\(-\)</button>
    <button type="button" onclick="insertOperand('*')">\(\cdot\)</button>
    <button type="button" onclick="insertOperand('/')">\(/\)</button>
  </div>
  <!-- ACTION BUTTONS --------------------------------------------- -->
  <div style="display:flex;gap:10px;justify-content:center;margin-bottom:26px;">
    <button id="computeBtn" type="button" class="action-btn green">Compute</button>
    <button id="clearBtn"   type="button" class="action-btn red">Clear</button>
  </div>

  <!-- 3 SHIFTERS -------------------------------------------------- -->
  <fieldset class="transform-box" style="margin-bottom:24px;">
    <button type="button" class="reset-transform" data-group=""
            title="Reset transform controls" aria-label="Reset transform controls">↺</button>
    <legend style="font-weight:600;">Transform Controls</legend>
    <div class="slider-row">
      <label>Shift (←/→)</label>
      <input id="shift" type="range" min="-32" max="32" step="1" value="0"><span></span>
    </div>
    <div class="slider-row">
      <label>Amplitude ↕</label>
      <input id="amp" type="range" min="0.1" max="5" step="0.1" value="1"><span></span>
    </div>
    <div class="slider-row">
      <label>Width ↔</label>
      <input id="width" type="range" min="0.1" max="10" step="0.1" value="1"><span></span>
    </div>
  </fieldset>

</form>

<!-- PLOTLY PANELS ------------------------------------------------ -->
<div id="plots" style="max-width:100%;margin:0 auto;">
  <div id="timePlot"  style="height:220px;"></div>
  <div id="magPlot"   style="height:220px;"></div>
  <div id="phasePlot" style="height:220px;margin-top: -20px;"></div>
</div>

<!-- SCRIPTS ------------------------------------------------------ -->
<script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
<script>
/* active-field & quick buttons ---------------------------------- */
let activeField = document.getElementById("func");
function insertOperand(op){
  if(!activeField) return;
  const s = activeField.selectionStart, e = activeField.selectionEnd,
        v = activeField.value;
  activeField.value = v.slice(0,s)+op+v.slice(e);
  activeField.selectionStart = activeField.selectionEnd = s+op.length;
  activeField.focus();
}

/* slider wiring ------------------------------------------------- */
["shift","amp","width"].forEach(id=>{
  const s   = document.getElementById(id);
  const val = s.nextElementSibling;
  s.dataset.default = s.value;
  val.textContent = parseFloat(s.value).toFixed(1);
  s.addEventListener("input", ()=>{ val.textContent = parseFloat(s.value).toFixed(1); updatePlots(); });
});
document.querySelectorAll('.reset-transform').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const group = btn.dataset.group || '';
    ['shift','amp','width'].forEach(prefix=>{
      const id = `${prefix}${group}`;
      const slider = document.getElementById(id);
      if(!slider) return;
      const defaultVal = slider.dataset.default ?? slider.getAttribute('value') ?? ((prefix === 'amp' || prefix === 'width') ? '1' : '0');
      slider.value = defaultVal;
      slider.nextElementSibling.textContent = parseFloat(slider.value).toFixed(1);
    });
    updatePlots();
  });
});

/* helpers ------------------------------------------------------- */
function params(){
  return {
    L: L.value, M: M.value, func: func.value,
    shift: shift.value, amp: amp.value, width: width.value
  };
}

/* fetch + plot -------------------------------------------------- */
function updatePlots(){
  fetch("{{ url_for('discrete_fourier.update_dft') }}", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(params())
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.error){ console.error(d.error); return; }

    const lc = {margin:{t:30}};
    const stem = (x,y,color)=>({
      x:[].concat(...x.map(xi=>[xi,xi,xi])),
      y:[].concat(...y.map(yi=>[0,yi,null])),
      mode:"lines", line:{color,width:2}, showlegend:false,
    });

    Plotly.newPlot("timePlot", [
      stem(d.k, d.x_real, "#1f77b4"),
      {x:d.k, y:d.x_real, mode:"markers", name:"Re{x[k]}", marker:{color:"#1f77b4"}},
      stem(d.k, d.x_imag, "#ff7f0e"),
      {x:d.k, y:d.x_imag, mode:"markers", name:"Im{x[k]}", marker:{symbol:"square",color:"#ff7f0e"}}
    ], {...lc,title:{text:"Time-Domain"},xaxis:{title:{text:"k"}},yaxis:{title:{text:"x[k]"}}});

    Plotly.newPlot("magPlot", [
      stem(d.mu, d.mag, "#1f77b4"),
      {x:d.mu, y:d.mag, mode:"markers", name:"|X[\u03bc]|", marker:{color:"#1f77b4"}}
    ], {...lc,showlegend:false,title:{text:"DFT-Domain"},xaxis:{title:{text:"\u03bc"}},yaxis:{title:{text:"|X[\u03bc]|"}}});

    Plotly.newPlot("phasePlot", [
      stem(d.mu, d.phase, "#ff7f0e"),
      {x:d.mu, y:d.phase, mode:"markers", name:"\u03c6(X[\u03bc])", marker:{color:"#ff7f0e"}}
    ], {...lc,showlegend:false,xaxis:{title:{text:"\u03bc"}},
      yaxis:{
        title:{text:"\u03c6(X[\u03bc])"},
        range:[-Math.PI-.1,Math.PI+.1],
        tickvals:[-Math.PI,-Math.PI/2,0,Math.PI/2,Math.PI],
        ticktext:["-π","-π/2","0","π/2","π"]
      },
    });

    dftLabel.textContent = d.label;
  })
  .catch(console.error);
}

/* buttons ------------------------------------------------------- */
computeBtn.onclick = updatePlots;
clearBtn.onclick = ()=>{
  func.value=""; L.value=8; M.value=8;
  ["shift","amp","width"].forEach(id=>{
    const s=document.getElementById(id);
    s.value=(id==="amp"||id==="width")?1:0;
    s.nextElementSibling.textContent=parseFloat(s.value).toFixed(1);
  });
  Plotly.purge("timePlot"); Plotly.purge("magPlot"); Plotly.purge("phasePlot");
  dftLabel.textContent="";
};

/* live-update on typing ----------------------------------------- */
["L","M","func"].forEach(id=>{
  document.getElementById(id).addEventListener("input", ()=>{ clearTimeout(window._tu); window._tu=setTimeout(updatePlots,300); });
});

/* initial render ------------------------------------------------ */
document.addEventListener("DOMContentLoaded", updatePlots);
</script>

<!-- STYLES ------------------------------------------------------- -->
<style>
  .subtle-btn {
    display:inline-block;
    margin-top:10px;
    padding:6px 12px;
    font-size:0.9em;
    border-radius:4px;
    border:1px solid var(--primary-color);
    color:var(--primary-color);
    background-color:rgba(0,122,204,0.08);
    text-decoration:none;
    transition:background-color 0.2s ease,color 0.2s ease;
  }
  .subtle-btn:hover {
    background-color:var(--primary-color);
    color:#fff;
  }
  .quick-buttons button{
    padding:8px 12px;font-size:0.9em;border-radius:4px;background:#007acc;
    color:#fff;border:none;cursor:pointer;transition:background-color .15s;
  }
  .quick-buttons button:hover{ background:#005fa3; }
  .action-btn{
    padding:8px 22px;font-size:0.9em;border:none;border-radius:4px;
    cursor:pointer;display:inline-block;text-decoration:none;
  }  .green{ background:#28a745;color:#fff; } .green:hover{ background:#218838; }
  .red  { background:#dc3545;color:#fff; } .red:hover  { background:#c82333; }
  .transform-box{
    border:1px solid #d9dee3;border-radius:8px;padding:16px 22px;background:#f8fafc;
    position:relative;max-width:420px;margin:0 auto;
  }
  .reset-transform{
    position:absolute;top:-5px;right:22px;width:22px;height:22px;border:none;
    border-radius:50%;background:#2563eb;color:#fff;font-size:12px;line-height:1;
    display:flex;align-items:center;justify-content:center;cursor:pointer;
    opacity:0.75;transition:opacity .15s,background-color .15s;
  }
  .reset-transform:hover{opacity:1;background:#1d4ed8;}
  .slider-row{ display:flex;align-items:center;gap:10px;margin-top:8px; }
  .slider-row label{ width:100px;text-align:right;font-weight:600; }
  .slider-row span{ width:46px;text-align:center;border:1px solid #ccd0d5;border-radius:4px;background:#fff; }
  input[type=range]{ flex:1;appearance:none;height:4px;border-radius:2px;background:#007acc;cursor:pointer; }
  input[type=range]::-webkit-slider-thumb{ appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #007acc; }

  /* Dark mode adjustments */
  body.dark-mode input[type="text"],
  body.dark-mode input[type="number"]{
    background:#2a2a2a;
    color:#f5f5f5;
    border-color:#555;
  }
  body.dark-mode .transform-box{
    background:#1f1f1f;
    border-color:#444;
  }
  body.dark-mode .reset-transform{
    background:#3b82f6;
    color:#e8edff;
  }
  body.dark-mode .reset-transform:hover{background:#2563eb;}
  body.dark-mode .slider-row span{
    background:#333;
    border-color:#555;
    color:#f5f5f5;
  }
</style>
{% endblock %}
