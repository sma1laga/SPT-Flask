{% extends "base.html" %}
{% block title %}Discrete Autocorrelation Calculator{% endblock %}

{% block content %}
<div class="page-header" style="margin-bottom:30px;text-align:center;">
  <h1 style="font-size:2.5em;">Discrete Autocorrelation Calculator</h1>
  <p style="font-size:1.1em;color:var(--subtext-color);max-width:640px;margin:0 auto;">
    Enter an energy signal \(x[k]\) and click <b>Compute</b> to display the sequence
    and its discrete autocorrelation, calculated as
    $$ \varphi_{xx}^\mathrm{E}[\kappa]=\sum_{k=-\infty}^{\infty} x[k+\kappa]x^\ast[k]. $$
  </p>
  </div>

  <p id="errorMsg" style="max-width:700px;margin:0 auto 16px auto;color:#d00;text-align:center;font-weight:bold;"></p>

  <form id="acorrForm" style="max-width:820px;margin:0 auto;text-align:center;">
  <div class="function-group" style="display:flex;justify-content:center;align-items:center;gap:8px;margin-bottom:20px;">
    <input id="func" placeholder="x[k]" onfocus="setActiveField(this)"
           style="width:90%;padding:8px;border:1px solid #ccd0d5;border-radius:4px;font-size:1em;">
  </div>

  <div class="quick-buttons" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:10px;">
    <button type="button" onclick="insertOperand('rect_4[k]')">\(\mathrm{rect}_4\)</button>
    <button type="button" onclick="insertOperand('tri_3[k]')">\(\mathrm{tri}_3\)</button>
    <button type="button" onclick="insertOperand('sin[pi/4*k]*rect_33[k+16]')">\(\sin\)</button>
    <button type="button" onclick="insertOperand('cos[pi/4*k]*rect_33[k+16]')">\(\cos\)</button>
    <button type="button" onclick="insertOperand('delta[k]')">\(\delta\)</button>
    <button type="button" onclick="insertOperand('sign[k]*rect_11[k+5]')">\(\mathrm{sign}\)</button>
    <button type="button" onclick="insertOperand('exp[k]*step[-k]')">\(\mathrm{e}^{k}\)</button>
    <button type="button" onclick="insertOperand('exp[-k]*step[k]')">\(\mathrm{e}^{-k}\)</button>
    <button type="button" onclick="insertOperand('0.5**k*step[k]')">\(\left(\frac{1}{2}\right)^{k}\)</button>
    <button type="button" onclick="insertOperand('(-0.5)**k*step[k]')">\(\left(-\frac{1}{2}\right)^{k}\)</button>
    <button type="button" onclick="insertOperand('si[pi/2*k]')">\(\mathrm{si}\)</button>
    <button type="button" onclick="insertOperand('si[pi/2*k]**2')">\(\mathrm{si}^2\)</button>
  </div>
  <div class="quick-buttons" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:20px;">
    <button type="button" onclick="insertOperand('+')">\(+\)</button>
    <button type="button" onclick="insertOperand('-')">\(-\)</button>
    <button type="button" onclick="insertOperand('*')">\(\cdot\)</button>
    <button type="button" onclick="insertOperand('/')">\(/\)</button>
  </div>
  <div style="margin-bottom:30px;">
    <button id="computeBtn" type="button" class="action-btn green">Compute</button>
    <button id="clearBtn"   type="button" class="action-btn red">Clear</button>
  </div>
</form>

<div id="plotly-container" style="max-width:1200px;margin:0 auto;">
  <div id="plot1" style="height:320px;"></div>
  <div id="plotAuto" style="height:350px;margin-top:22px;"></div>
</div>

<script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
<script>
let activeField = document.getElementById('func');
const errorMsg = document.getElementById('errorMsg');
const funcInput = document.getElementById('func');
function setActiveField(f){ activeField = f; }
document.getElementById('func').addEventListener('focus',e=>activeField=e.target);
function clearErrors(){
  funcInput.classList.remove('input-error');
  if(errorMsg) errorMsg.textContent = '';
}
function insertOperand(op){
  if(!activeField) return alert('Click in an input field first.');
  const s=activeField.selectionStart, e=activeField.selectionEnd, v=activeField.value;
  activeField.value = v.slice(0,s)+op+v.slice(e);
  activeField.selectionStart = activeField.selectionEnd = s+op.length;
  activeField.focus();
}
function values(){
  return { func: func.value };
}
function updatePlots(){
  clearErrors();

  fetch("{{ url_for('discrete_autocorrelation.discrete_autocorrelation_update') }}",{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(values())
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.error){
      if(errorMsg) errorMsg.textContent = d.error;
      funcInput.classList.add('input-error');
      console.error(d.error);
      return;
    }
    const lc = {margin:{t:30},showlegend:false};
    const stem = (x,y,color)=>({
        x:[].concat(...x.map(xi=>[xi,xi,xi])),
        y:[].concat(...y.map(yi=>[0,yi,null])),
        mode:'lines', line:{color,width:2}
    });
    Plotly.newPlot('plot1', [
      stem(d.k, d.y1,'#1f77b4'),
      {x:d.k, y:d.y1, mode:'markers', marker:{color:'#1f77b4',size:6}}
    ], {...lc, title:{text:'Input Sequence  x[k]'},
        xaxis:{title:{text:'k'}}, yaxis:{title:{text:'x[k]'}}});    Plotly.newPlot('plotAuto', [
      stem(d.k_conv, d.y_conv,'#2ca02c'),
      {x:d.k_conv, y:d.y_conv, mode:'markers', marker:{color:'#2ca02c',size:6}}
    ], {...lc, title:{text:'Autocorrelation  φ_xx[κ]'},
        xaxis:{title:{text:'κ'}}, yaxis:{title:{text:'φ_xx[κ]'}}});  })
  .catch(console.error);
}
computeBtn.onclick = updatePlots;
const acorrForm = document.getElementById("acorrForm");
if (acorrForm) {
  acorrForm.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      updatePlots();
    }
  });
}
clearBtn.onclick = ()=>{
  func.value='';
  ['plot1','plotAuto'].forEach(id=>Plotly.purge(id));
  clearErrors();
};
</script>
<style>
  .quick-buttons button{
    padding:8px 12px;font-size:0.9em;border-radius:4px;background:#007acc;
    color:#fff;border:none;cursor:pointer;transition:background-color .15s;
  }
  .quick-buttons button:hover{ background:#005fa3; }
  .action-btn{ padding:8px 22px;font-size:0.9em;border:none;border-radius:4px;cursor:pointer; }
  .green{ background:#28a745;color:#fff; } .green:hover{ background:#218838; }
  .red  { background:#dc3545;color:#fff; } .red:hover  { background:#c82333; }
  input.input-error{border-color:#d00;}
  </style>
  {% endblock %}