{% extends "base.html" %}
{% block title %}Discrete Convolution Calculator{% endblock %}

{% block content %}
<div class="page-header" style="margin-bottom:30px;text-align:center;">
  <h1 style="font-size:2.5em;">Discrete Convolution Calculator</h1>
  <p style="color:var(--subtext-color);max-width:640px;margin:0 auto;">
    Enter two sequences \(x[k]\) and \(h[k]\) (as functions of the time index \(k\)),
    and click <b>Compute</b> to display
    both sequences and their discrete convolution.
  </p>
  <p style="font-size:1.1em;color:var(--subtext-color);max-width:600px;margin:8px auto 0;">
    The discrete convolution of \(x[k]\) with \(h[k]\) is defined as
    $$ y[k] = x[k]*h[k] = \sum_{\kappa=-\infty}^{\infty} x[\kappa]h[k-\kappa] $$
  </p>
</div>

<p id="errorMsg" style="max-width:700px;margin:0 auto 16px auto;color:#d00;text-align:center;font-weight:bold;"></p>

<form id="convForm" style="max-width:820px;margin:0 auto;text-align:center;">
  <!-- input boxes -->
  <div class="function-group"
       style="display:flex;justify-content:center;align-items:center;gap:8px;margin-bottom:20px;">
    <input id="func1" placeholder="x[k]" onfocus="setActiveField(this)"
           style="width:45%;padding:8px;border:1px solid #ccd0d5;border-radius:4px;font-size:1em;">
    <span style="font-size:1.5em;font-weight:bold;position:relative;top:-4px;">*</span>
    <input id="func2" placeholder="h[k]" onfocus="setActiveField(this)"
           style="width:45%;padding:8px;border:1px solid #ccd0d5;border-radius:4px;font-size:1em;">
  </div>

  <!-- quick buttons -->
  <div class="quick-buttons"
       style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:10px;">
    <button type="button" onclick="insertOperand('rect_4[k]')">\(\mathrm{rect}_4\)</button>
    <button type="button" onclick="insertOperand('tri_3[k]')">\(\mathrm{tri}_3\)</button>
    <button type="button" onclick="insertOperand('sin[pi/4*k]')">\(\sin\)</button>
    <button type="button" onclick="insertOperand('cos[pi/4*k]')">\(\cos\)</button>
    <button type="button" onclick="insertOperand('delta[k]')">\(\delta\)</button>
    <button type="button" onclick="insertOperand('step[k]')">\(\mathrm{step}\)</button>
    <button type="button" onclick="insertOperand('sign[k]')">\(\mathrm{sign}\)</button>
    <button type="button" onclick="insertOperand('exp[k]*step[-k]')">\(\mathrm{e}^k\)</button>
    <button type="button" onclick="insertOperand('exp[-k]*step[k]')">\(\mathrm{e}^{-k}\)</button>
    <button type="button" onclick="insertOperand('0.5**k*step[k]')">\(\left(\frac{1}{2}\right)^{k}\)</button>
    <button type="button" onclick="insertOperand('(-0.5)**k*step[k]')"> \(\left(-\frac{1}{2}\right)^{k}\)</button>
    <button type="button" onclick="insertOperand('inv_k[k]')">\(\frac{1}{k}\)</button>
    <button type="button" onclick="insertOperand('si[pi/2*k]')">\(\mathrm{si}\)</button>
    <button type="button" onclick="insertOperand('si[pi/2*k]**2')">\(\mathrm{si}^2\)</button>
  </div>
  <div class="quick-buttons"
       style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:20px;">
    <button type="button" onclick="insertOperand('+')">\(+\)</button>
    <button type="button" onclick="insertOperand('-')">\(-\)</button>
    <button type="button" onclick="insertOperand('*')">\(\cdot\)</button>
    <button type="button" onclick="insertOperand('/')">\(/\)</button>
  </div>

  <!-- action buttons --------------------------------------------- -->
  <div style="margin-bottom:30px;">
    <button id="computeBtn" type="button" class="action-btn green">Compute</button>
    <button id="clearBtn"   type="button" class="action-btn red">Clear</button>
  </div>
</form>

<!-- plotly panels ------------------------------------------------ -->
<div id="plotly-container" style="max-width:1200px;margin:0 auto;">
  <div id="plot1"    style="height:220px;"></div>
  <div id="plot2"    style="height:220px;margin-top: -20px;"></div>
  <div id="plotConv" style="height:220px;margin-top: -20px;"></div>
</div>

<!-- scripts ------------------------------------------------------ -->
<script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
<script>
/* active field + operand insert --------------------------------- */
let activeField = document.getElementById("func1");

const errorMsg = document.getElementById("errorMsg");
const func1 = document.getElementById("func1");
const func2 = document.getElementById("func2");

function clearErrors(){
  [func1, func2].forEach(el=>el.classList.remove('input-error'));
  if(errorMsg) errorMsg.textContent = "";
}

function setActiveField(f){ activeField = f; }
["func1","func2"].forEach(id=>{
  document.getElementById(id).addEventListener("focus",e=>activeField=e.target);
});
function insertOperand(op){
  if(!activeField) return alert("Click in an input field first.");
  const s=activeField.selectionStart, e=activeField.selectionEnd, v=activeField.value;
  activeField.value = v.slice(0,s)+op+v.slice(e);
  activeField.selectionStart = activeField.selectionEnd = s+op.length;
  activeField.focus();
}

/* collect form data --------------------------------------------- */
function values(){
  return {
    func1: func1.value,
    func2: func2.value,
  };
}

/* fetch + plot --------------------------------------------------- */
function updatePlots(){
  clearErrors();
  fetch("{{ url_for('discrete_convolution.discrete_convolution_update') }}",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(values())
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.error){
      if(errorMsg) errorMsg.textContent = d.error;
      if(/sequence 1/i.test(d.error)) func1.classList.add('input-error');
      if(/sequence 2/i.test(d.error)) func2.classList.add('input-error');
      console.error(d.error);
      return;
    }
    const lc = {margin:{t:30},showlegend:false};
    const stem = (x,y,color)=> ({
        x:[].concat(...x.map((xi,i)=>[xi,xi,xi])),          // xi, xi
        y:[].concat(...y.map((yi,i)=>[0,yi,null])),         // 0 → yi (stem) → gap
        mode:"lines", line:{color,width:1}
    });

    Plotly.newPlot("plot1", [
      stem(d.k, d.y1,"#1f77b4"),
      {x:d.k, y:d.y1, mode:"markers", name:"x[k]", marker:{color:"#1f77b4",size:6}}
    ], {...lc, xaxis:{title:{text:"k"}}, yaxis:{title:{text:"x[k]"}}});

    Plotly.newPlot("plot2", [
      stem(d.k, d.y2,"#ff7f0e"),
      {x:d.k, y:d.y2, mode:"markers", name:"h[k]", marker:{color:"#ff7f0e",symbol:"square",size:6}}
    ], {...lc, xaxis:{title:{text:"k"}}, yaxis:{title:{text:"h[k]"}}});

    Plotly.newPlot("plotConv", [
      stem(d.k_conv, d.y_conv,"#2ca02c"),
      {x:d.k_conv, y:d.y_conv, mode:"markers", name:"y[k]", marker:{color:"#2ca02c",size:6}}
    ], {...lc, xaxis:{title:{text:"k"}}, yaxis:{title:{text:"y[k]"}}});

  })
  .catch(console.error);
}

/* buttons -------------------------------------------------------- */
computeBtn.onclick = updatePlots;
const convForm = document.getElementById("convForm");
if (convForm) {
  convForm.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      updatePlots();
    }
  });
}
clearBtn.onclick = ()=>{
  func1.value=func2.value="";
  clearErrors();

  ["plot1","plot2","plotConv"].forEach(id=>Plotly.purge(id));
};
</script>

<!-- styles ------------------------------------------------------- -->
<style>
  .quick-buttons button{
    padding: 8px 12px;
    font-size: 0.9em;
    border-radius: 4px;
    background: var(--primary-color);
    color: #fff;
    border: none;
    cursor: pointer;
    transition: background-color .15s;
  }
  .quick-buttons button:hover{
    background: var(--primary-color-darker);
  }
  .action-btn{
    padding: 8px 22px;
    font-size: 0.9em;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .green{
    background: var(--lms-green-darker);
    color: #fff;
  } .green:hover{
    background: var(--lms-green-dark);
  }
  .red  {
    background: var(--lms-red);
    color: #fff;
  } .red:hover  {
    background: var(--lms-red-darker);
  }
  input.input-error{
    border-color: var(--lms-red);
  }
</style>
{% endblock %}
