{% extends "base.html" %}
{% block content %}
<script>document.title = "Convolution Step-by-Step Visualization – Dynamic Explorer";</script>
<div class="page-header" style="margin-bottom: 24px; text-align: center;">
  <h1 style="font-size: 2.2em; margin-bottom: 8px;">Convolution Step-by-Step Visualization</h1>
  <p class="conv-steps">Reverse/shift \(h[k-n]\) → Multiply \(x[n]h[k-n]\) → Sum \(y[k]\)</p>
  <p style="font-size: 1.06em; color: var(--subtext-color); max-width: 620px; margin: 0 auto;">
    Slide \(k\) to see how the overlap between \(x[n]\) and \(h[k-n]\) produces the convolved output
    $$ y[k]=\sum_{n=-\infty}^{\infty}x[n]h[k-n] $$
  </p>
</div>

<div id="dynamic-form" style="max-width: 760px; margin: 0 auto;">
  <div class="inputs" style="display:flex; flex-wrap:wrap; gap:14px; align-items:end; justify-content:center; margin-bottom:12px;">
    <div>
      <label for="func1" style="font-weight:bold;">\(x[k]\):</label><br>
      <select id="func1">
        {% for label, val in functions %}
          <option value="{{ val }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="func2" style="font-weight:bold;">\(h[k]\):</label><br>
      <select id="func2">
        {% for label, val in functions %}
          <option value="{{ val }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="tauSlider" style="font-weight:bold;">Shift \(k\):</label><br>
      <input type="range" id="tauSlider" min="-10" max="10" step="1" value="0">
      <span id="tauValue" style="display:inline-block; width:32px; font-weight:bold;">0</span>
    </div>
  </div>

  <div class="controls-row">
    <button id="playPauseBtn" type="button" class="conv-action-btn" aria-label="Play animation">Play</button>
    <select id="speedSelect" aria-label="Animation speed">
      <option value="0.5">0.5×</option>
      <option value="1" selected>1×</option>
      <option value="2">2×</option>
      <option value="4">4×</option>
    </select>
    <button id="resetBtn" type="button" class="conv-secondary-btn" aria-label="Reset slider">Reset</button>
    <div id="currentValueCard" class="value-card">\(k=0,\;y[k]=0\)</div>
  </div>

</div>

<div id="dynamic-plot-wrapper" style="max-width: 700px; margin: auto;">
  <div class="trace-toggles">
    <label><input type="checkbox" id="showX" checked> x</label>
    <label><input type="checkbox" id="showShifted" checked> shifted h</label>
    <label><input type="checkbox" id="showProduct" checked> product shading</label>
  </div>
  <div id="topChart" style="height:240px; width:100%; border:1px solid #ccc; border-radius:4px;"></div>
  <p class="plot-caption">Sum of \(x[n]h[k-n]\) equals \(y[k]\).</p>
  <div id="inline-slider-wrapper" style="display:flex; justify-content:center; align-items:center; margin:0.35em 0;">
    <input type="range" id="tauSliderInline" min="-10" max="10" step="1" value="0" style="width:65%; max-width:350px; height:4px;">
  </div>
  <div id="bottomChart" style="height:220px; width:100%; margin-top:1em; border:1px solid #ccc; border-radius:4px;"></div>
</div>
<section class="learning-section" aria-label="Convolution definition and properties">
  <h2>Convolution: definition &amp; properties</h2>

  <div class="learning-card">
    <h3>Definition</h3>
    <p class="math-line">\(y[k]=\sum_{n=-\infty}^{\infty} x[n]h[k-n]\)</p>
    <p>Graphically: reverse/shift \(h\), multiply sample-by-sample with \(x\), then sum all products to get one output sample \(y[k]\).</p>
    <p>Changing \(k\) moves the overlap window and traces the output sequence.</p>
  </div>

  <div class="learning-card">
    <h3>Key properties</h3>
    <ul>
      <li><strong>Commutative:</strong> \(x*h=h*x\) — swapping inputs gives the same sequence.</li>
      <li><strong>Shift (delta):</strong> \(x[n]*\delta[n-k_0]=x[n-k_0]\) — a shifted impulse shifts the signal.</li>
      <li><strong>Identity:</strong> \(x[n]*\delta[n]=x[n]\) — the impulse is the neutral element.</li>
      <li><strong>Length hint:</strong> \(\mathrm{len}(y)=\mathrm{len}(x)+\mathrm{len}(h)-1\) for finite-length sequences.</li>
    </ul>
  </div>

  <div class="learning-card">
    <h3>Try it</h3>
    <div class="try-buttons">
      <button type="button" class="conv-secondary-btn mini-try-btn" id="tryIdentityBtn">Identity (delta)</button>
      <button type="button" class="conv-secondary-btn mini-try-btn" id="tryShiftBtn">Shift with delta</button>
      <button type="button" class="conv-secondary-btn mini-try-btn" id="trySwapBtn">Commutative (swap x,h)</button>
    </div>
  </div>
</section>

<section class="next-steps-card" aria-label="Next steps">
  <h2>Next steps</h2>
  <p>This demo visualizes graphical convolution. Use the Calculator for arbitrary signals or Training for guided exercises.</p>
  <div class="next-step-links">
    <a href="{{ url_for('convolution.convolution') }}" class="conv-action-btn">Compute full convolution (Calculator)</a>
    <a href="{{ url_for('training_convolution.training_convolution') }}" class="conv-secondary-btn">Need practice &amp; examples? See Convolution Training</a>
  </div>
</section>

<script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
<script>
let tData = [], y1Data = [], y2Data = [], yConvData = [];
let kExt = [], y2DataExt = [];
let topChart, bottomChart;
let playTimer = null;
let hasData = false;

const tauSlider = document.getElementById('tauSlider');
const tauSliderInline = document.getElementById('tauSliderInline');
const sliderMin = Number(tauSlider.min);
const sliderMax = Number(tauSlider.max);
function getPlotTheme(){
  const isDark = document.body.classList.contains('dark-mode');
  return isDark
    ? { paperBg: '#0f172a', plotBg: '#0f172a', axisColor: '#e2e8f0', gridColor: '#334155' }
    : { paperBg: '#f6f7fb', plotBg: '#f6f7fb', axisColor: '#1f2937', gridColor: '#d1d5db' };
}

function pairData(xArr, yArr){ return xArr.map((x,i)=>({ x:x, y:yArr[i] })); }

function initCharts(){
  topChart = document.getElementById('topChart');
  bottomChart = document.getElementById('bottomChart');
  const theme = getPlotTheme();

  Plotly.newPlot(topChart, [
    { x: tData, y: y1Data, type: 'scatter', mode: 'markers', name: 'x[n]', marker: { color: 'blue', size: 9 } },
    { x: tData, y: [], type: 'scatter', mode: 'markers', name: 'h[k−n]', marker: { color: 'orange', size: 9 } },
    { x: tData, y: [], type: 'scatter', mode: 'markers', name: 'x·h', marker: { color: 'rgba(255,0,0,0.6)', size: 11, line: { color: 'red', width: 1 } } }
  ], {
    margin: { t: 20, b: 40, l: 50, r: 10 },
    xaxis: { title: 'n', color: theme.axisColor, gridcolor: theme.gridColor },
    yaxis: { color: theme.axisColor, gridcolor: theme.gridColor },
    paper_bgcolor: theme.paperBg,
    plot_bgcolor: theme.plotBg,
    font: { color: theme.axisColor }
  }, {displayModeBar: false, responsive: true});

  Plotly.newPlot(bottomChart, [
    { x: tData, y: yConvData, type: 'scatter', mode: 'markers', name: 'y[k]', marker: { color: 'darkblue', size: 9 } },
    { x: [], y: [], type: 'scatter', mode: 'markers', name: 'Marker', marker: { color: 'red', size: 9 } }
  ], {
    margin: { t: 20, b: 40, l: 50, r: 10 },
    xaxis: { title: 'k', color: theme.axisColor, gridcolor: theme.gridColor },
    yaxis: { color: theme.axisColor, gridcolor: theme.gridColor },
    paper_bgcolor: theme.paperBg,
    plot_bgcolor: theme.plotBg,
    font: { color: theme.axisColor }
  }, {displayModeBar: false, responsive: true});
}

function fetchData(){
  fetch("{{ url_for('discrete_dynamic_convolution.data') }}", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      func1: document.getElementById('func1').value,
      func2: document.getElementById('func2').value
    })
  })
  .then(r => r.json().then(d => r.ok ? d : Promise.reject(d.error)))
  .then(d => {
    tData = d.k || [];
    kExt = d.k_ext || [];
    y1Data = d.y1 || [];
    y2Data = d.y2 || [];
    y2DataExt = d.y2_ext || [];
    yConvData = d.y_conv || [];
    hasData = tData.length > 0;
    if (!hasData) {
      setPlayButtonState(false, true);
      return;
    }
    window.y2Dict = Object.fromEntries(kExt.map((k,idx)=>[k, y2DataExt[idx]]));
    initCharts();
    updatePlots();
    setPlayButtonState(false, false);
  })
  .catch(e => alert('Error: ' + e));
}

function updatePlots(){
  if (!topChart || !bottomChart || !tData.length) return;

  const kVal = parseInt(tauSlider.value, 10);
  document.getElementById('tauValue').textContent = kVal;

  if(!window.y2Dict){
    window.y2Dict = Object.fromEntries(kExt.map((k,idx)=>[k, y2DataExt[idx]]));
  }
  const y2shift = tData.map(v => window.y2Dict[kVal - v] ?? 0);


  const yMul = y1Data.map((v,i) => v * y2shift[i]);
  Plotly.restyle(topChart, {
    x: [tData], y: [y1Data], visible: [document.getElementById('showX').checked]
  }, [0]);
  Plotly.restyle(topChart, {
    x: [tData], y: [y2shift], visible: [document.getElementById('showShifted').checked]
  }, [1]);
  Plotly.restyle(topChart, {
    x: [tData], y: [yMul], visible: [document.getElementById('showProduct').checked]
  }, [2]);

  const idx = tData.indexOf(kVal);
  const convVal = idx >= 0 ? yConvData[idx] : 0;
  Plotly.restyle(bottomChart, { x: [[kVal]], y: [[convVal]] }, [1]);

  const card = document.getElementById('currentValueCard');
  card.innerHTML = `\\(k=${kVal},\;y[k]=${convVal.toFixed(4)}\\)`;
  if(window.MathJax?.typesetPromise){ window.MathJax.typesetPromise([card]); }
}

function syncTau(value, origin, skipUpdate = false){
  if(origin !== tauSlider) tauSlider.value = value;
  if(origin !== tauSliderInline) tauSliderInline.value = value;
  if (!skipUpdate) updatePlots();
}
function setPlayButtonState(isPlaying, disabled = false){
  const btn = document.getElementById('playPauseBtn');
  btn.disabled = disabled;
  btn.textContent = isPlaying ? 'Pause' : 'Play';
  btn.setAttribute('aria-label', isPlaying ? 'Pause animation' : 'Play animation');
  btn.dataset.playing = isPlaying ? 'true' : 'false';
}

function stopPlay(){
  if(playTimer){ clearInterval(playTimer); playTimer = null; }
  setPlayButtonState(false, !hasData);
}

function togglePlay(){
  if (!hasData) return;
  if (playTimer){
    stopPlay();
    return;
  }

  if (Number(tauSlider.value) >= sliderMax) syncTau(sliderMin, null);
  setPlayButtonState(true, false);

  const speed = Number(document.getElementById('speedSelect').value);
  const range = sliderMax - sliderMin;
  const baseUnitsPerSecond = range / 10;
  let carry = 0;
  let prevTs = performance.now();

  const intervalMs = 20;
  playTimer = setInterval(() => {
    const now = performance.now();
    const dt = (now - prevTs) / 1000;
    prevTs = now;
    carry += dt * baseUnitsPerSecond * speed;
    const step = Math.floor(carry);
    if (step <= 0) return;
    carry -= step;

    const next = Number(tauSlider.value) + step;
    if (next > sliderMax){
      syncTau(sliderMax, null);
      stopPlay();
      return;
    }
    syncTau(next, null);
  }, intervalMs);
}
function applyExample({ func1, func2, tau }){
  stopPlay();
  if (func1 !== undefined) document.getElementById('func1').value = func1;
  if (func2 !== undefined) document.getElementById('func2').value = func2;
  syncTau(tau ?? 0, null, true);
  fetchData();
}

window.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('func1').onchange = fetchData;
  document.getElementById('func2').onchange = fetchData;
  tauSlider.oninput = (e) => { stopPlay(); syncTau(e.target.value, tauSlider); };
  tauSliderInline.oninput = (e) => { stopPlay(); syncTau(e.target.value, tauSliderInline); };
  document.getElementById('showX').onchange = updatePlots;
  document.getElementById('showShifted').onchange = updatePlots;
  document.getElementById('showProduct').onchange = updatePlots;
  document.getElementById('playPauseBtn').onclick = togglePlay;
  document.getElementById('resetBtn').onclick = () => { stopPlay(); syncTau(sliderMin, null); };
  document.getElementById('tryIdentityBtn').onclick = () => applyExample({ func2: 'delta(k)', tau: 0 });
  document.getElementById('tryShiftBtn').onclick = () => applyExample({ func2: 'delta(k)', tau: 2 });
  document.getElementById('trySwapBtn').onclick = () => {
    const func1 = document.getElementById('func1').value;
    const func2 = document.getElementById('func2').value;
    applyExample({ func1: func2, func2: func1, tau: 0 });
  };

  [tauSlider, tauSliderInline].forEach(slider => slider.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') stopPlay();
  }));


  document.getElementById('func1').value = 'rect_4(k)';
  document.getElementById('func2').value = 'rect_4(k)';
  tauSlider.value = 0;
  tauSliderInline.value = 0;
  fetchData();
});
</script>
<style>
  #dynamic-form select,
  #dynamic-form input[type="range"],
  #speedSelect {
    padding: 6px;
    border: 1px solid #ccd0d5;
    border-radius: 4px;
    font-size: 1em;
  }

  .conv-steps {
    margin: 0 auto 10px;
    max-width: 680px;
    color: var(--subtext-color);
    font-weight: 600;
    font-size: 0.98em;
  }


  .controls-row { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; align-items:center; margin-bottom:6px; }
  .conv-action-btn,
  .conv-secondary-btn {
    border-radius: 8px;
    padding: 7px 13px;
    cursor: pointer;
    font-size: 0.96em;
    font-weight: 600;
    margin-right: 0;
  }

  .conv-action-btn {
    background: linear-gradient(135deg, #1565c0, #1e88e5);
    border: 1px solid #1565c0;
    color: #fff;
    min-width: 76px;
  }

  .conv-secondary-btn {
    border: 1px solid #b8c1ce;
    background: #eef2f7;
    color: #1f2937;
  }

  .conv-action-btn:hover,
  .conv-secondary-btn:hover {
    transform: translateY(-1px);
    filter: brightness(0.98);
  }

  .conv-action-btn:disabled,
  .conv-secondary-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .value-card {
    border: 1px solid #ccd0d5;
    border-radius: 4px;
    padding: 6px 10px;
    min-width: 190px;
    text-align: center;
    font-weight: 500;
  }

  .trace-toggles { display:flex; flex-wrap:wrap; gap:14px; margin: 2px 0 8px; font-weight: 600; }
  .plot-caption { margin: 0.45em 0; font-size: 0.95em; color: var(--subtext-color); text-align:center; }
  #dynamic-form select {
    min-width: 190px;
    width: auto;
    color: var(--text-color);
    background-color: var(--card-bg);
  }

  #speedSelect { min-width: 92px; width: auto; }

  #dynamic-plot-wrapper #topChart,
  #dynamic-plot-wrapper #bottomChart { background: #f6f7fb; }
  .learning-section,
  .next-steps-card {
    max-width: 760px;
    margin: 20px auto 0;
    padding: 14px;
    border: 1px solid #d7dce5;
    border-radius: 10px;
    background: #fafbfe;
  }

  .learning-section h2,
  .next-steps-card h2 {
    text-align: center;
    margin: 0 0 12px;
    font-size: 1.3rem;
  }

  .learning-card {
    border: 1px solid #e1e6ef;
    background: #fff;
    border-radius: 8px;
    padding: 10px 12px;
    margin-bottom: 10px;
  }
  .learning-card h3 { margin: 0 0 6px; font-size: 1.02rem; }
  .learning-card p { margin: 4px 0; color: var(--subtext-color); }
  .math-line { font-weight: 600; color: inherit; }
  .learning-card ul { margin: 0; padding-left: 18px; }
  .learning-card li { margin: 4px 0; }
  .try-buttons { display: flex; flex-wrap: wrap; gap: 8px; }
  .mini-try-btn { font-size: 0.88em; padding: 6px 10px; }

  .next-steps-card { text-align: center; margin-top: 14px; }
  .next-steps-card p { margin: 0 0 10px; color: var(--subtext-color); }
  .next-step-links { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }

  @media (max-width: 720px) {
    .controls-row { flex-direction: column; }
    .value-card { width: 100%; max-width: 270px; }
    .try-buttons,
    .next-step-links { flex-direction: column; align-items: stretch; }
  }


  body.dark-mode #dynamic-form select,
  body.dark-mode #dynamic-form input[type="range"],
  body.dark-mode #speedSelect,
  body.dark-mode .value-card {
    background: #0f172a;
    border-color: #334155;
    color: #e2e8f0;
  }

  body.dark-mode #dynamic-plot-wrapper #topChart,
  body.dark-mode #dynamic-plot-wrapper #bottomChart {
    background: #0f172a;
    border-color: #334155;
  }

  body.dark-mode .learning-section,
  body.dark-mode .next-steps-card {
    background: #0b1220;
    border-color: #334155;
  }

  body.dark-mode .learning-card {
    background: #111827;
    border-color: #334155;
  }

  body.dark-mode .learning-card p,
  body.dark-mode .learning-card li,
  body.dark-mode .next-steps-card p,
  body.dark-mode .plot-caption,
  body.dark-mode .conv-steps {
    color: #cbd5e1;
  }

  body.dark-mode .conv-secondary-btn {
    background: #1e293b;
    border-color: #475569;
    color: #e2e8f0;
  }
</style>
{% endblock %}