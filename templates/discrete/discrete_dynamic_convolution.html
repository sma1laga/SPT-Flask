{% extends "base.html" %}
{% block content %}
<!-- Page Header -->
<div class="page-header" style="margin-bottom: 30px; text-align: center;">
  <h1 style="font-size: 2.5em; margin-bottom: 10px;">Dynamic Convolution Explorer</h1>
  <p style="font-size: 1.1em; color: var(--subtext-color); max-width: 600px; margin: 0 auto;">
    Slide \(k\) to see how the overlap between \(x[\kappa]\) and \(h[k - \kappa]\) produces the convolved output
    $$ y[k]=\sum_{\kappa=-\infty}^{\infty} x[\kappa] h[k - \kappa] $$    </p>
</div>

<div style="margin-bottom:1em;">
  <label>\(x[k]\):</label>
  <select id="func1">
    <option value="">-- none --</option>
    {% for label, val in functions %}
      <option value="{{ val }}">{{ label }}</option>
    {% endfor %}
  </select>

  <label>\(h[k]\):</label>
  <select id="func2">
    <option value="">-- none --</option>
    {% for label, val in functions %}
      <option value="{{ val }}">{{ label }}</option>
    {% endfor %}
  </select>
</div>

<div style="margin-bottom:1em;">
  <label>Shift \(k\):</label>
  <input type="range" id="tauSlider" min="-10" max="10" step="1" value="0">
  <span id="tauValue">0</span>
</div>

<div style="max-width: 650px; margin: auto;">
  <canvas id="topChart" height="200" style="width:100%; border:1px solid #ccc; border-radius:4px;"></canvas>
  <div id="inline-slider-wrapper" style="display:flex; justify-content:center; align-items:center; margin:0.35em 0;">
    <input
      type="range"
      id="tauSliderInline"
      min="-10"
      max="10"
      step="1"
      value="0"
      style="width:65%; max-width:350px; height:4px;"
    >
  </div>
  <canvas id="bottomChart" height="150" style="width:100%; margin-top:1em; border:1px solid #ccc; border-radius:4px;"></canvas>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let tData = [], y1Data = [], y2Data = [], yConvData = [];
let kExt = [], y1DataExt = [], y2DataExt = [];
let topChart, bottomChart;
function pairData(xArr, yArr){ return xArr.map((x,i)=>({ x:x, y:yArr[i] })); }

const tauSlider       = document.getElementById('tauSlider');
const tauSliderInline = document.getElementById('tauSliderInline');

function syncTau(value, origin){
  if(origin !== tauSlider)       tauSlider.value = value;
  if(origin !== tauSliderInline) tauSliderInline.value = value;
  updatePlots();
}

function initCharts(){
  if(topChart) topChart.destroy();
  if(bottomChart) bottomChart.destroy();
  const topCtx = document.getElementById("topChart").getContext("2d");
  const bottomCtx = document.getElementById("bottomChart").getContext("2d");

  topChart = new Chart(topCtx, {
    type: 'scatter',
    data: {
      datasets: [
        { label: 'x[κ]', data: pairData(tData, y1Data), borderColor: 'blue', backgroundColor: 'blue', showLine: false },
        { label: 'h[k−κ]', data: [], borderColor: 'orange', backgroundColor: 'orange', showLine: false },
        { label: 'x·h', data: [], borderColor: 'red', backgroundColor: 'rgba(255,0,0,0.5)', showLine: false, pointRadius: 6, pointBorderWidth: 2 }
      ]
    },
    options: { animation: false, scales: { x: { title: { display: true, text: 'κ' } } } }
  });

  bottomChart = new Chart(bottomCtx, {
    type: 'scatter',
    data: {
      datasets: [
        { label: 'y[k]', data: pairData(tData, yConvData), borderColor: 'darkblue', backgroundColor: 'darkblue', showLine: false },
        { label: 'Marker', data: [], pointRadius: 5, showLine: false, borderColor: 'red', backgroundColor: 'red' }
      ]
    },
    options: { animation: false, scales: { x: { title: { display: true, text: 'k' } } } }
  });
}

function fetchData(){
  fetch("{{ url_for('discrete_dynamic_convolution.data') }}", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      func1: document.getElementById('func1').value,
      func2: document.getElementById('func2').value
    })
  })
  .then(r => r.json().then(d => r.ok ? d : Promise.reject(d.error)))
      .then(d => {
        tData       = d.k;
        kExt        = d.k_ext;
      y1Data      = d.y1;
      y2Data      = d.y2;
      y1DataExt   = d.y1_ext;
      y2DataExt   = d.y2_ext;
        window.y2Dict = Object.fromEntries(kExt.map((k,idx)=>[k, y2DataExt[idx]]));
      yConvData   = d.y_conv;
      initCharts();
      updatePlots();
    })
  .catch(e => alert('Error: ' + e));
}

function updatePlots(){
  const τ = parseInt(tauSlider.value);
  document.getElementById('tauValue').textContent = τ;

  // Shifted h[k] lookup using extended domain to avoid edge truncation
    if(!window.y2Dict){
      window.y2Dict = Object.fromEntries(kExt.map((k,idx)=>[k, y2DataExt[idx]]));
  }
  const y2shift = tData.map(v => window.y2Dict[τ - v] ?? 0);
  topChart.data.datasets[1].data = pairData(tData, y2shift);

  // Pointwise product
  const yMul = y1Data.map((v,i) => v * y2shift[i]);
  topChart.data.datasets[2].data = pairData(tData, yMul);
  topChart.update();

  // Convolution marker
  const idx = tData.indexOf(τ);
  const convVal = idx >= 0 ? yConvData[idx] : 0;
  bottomChart.data.datasets[1].data = [{ x: τ, y: convVal }];
  bottomChart.update();
}

window.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('func1').onchange = fetchData;
  document.getElementById('func2').onchange = fetchData;
  tauSlider.oninput       = (e) => syncTau(e.target.value, tauSlider);
  tauSliderInline.oninput = (e) => syncTau(e.target.value, tauSliderInline);
  initCharts();
});
</script>
{% endblock %}