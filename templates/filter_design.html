{% extends "base.html" %}
{% block content %}
<style>
  .wizard-grid{display:grid;grid-template-columns:1fr;gap:16px;align-items:start;max-width:1200px;margin-inline:auto}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);transition:none}
  .card:hover{transform:none;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .card h3{margin:0;padding:14px 16px;border-bottom:1px solid #f3f4f6;font-size:1rem;font-weight:700}
  .card .body{padding:14px 16px}
  .field{margin-bottom:10px}
  .field label{display:block;font-weight:600;margin-bottom:4px}
  .field input,.field select{width:100%;padding:8px 10px;border:1px solid #d1d5db;border-radius:8px}
  .row{display:flex;gap:8px}
  .hint{color:#6b7280;font-size:.9rem;margin-top:4px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:.8rem;font-weight:600}
  .ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
  .warn{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
  .danger{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .btn{border:none;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;transition:none}
  .btn:hover{transform:none}
  .btn.primary{background:#1f6feb;color:#fff}
  .btn.primary:hover{background:#1f6feb}
  .btn.secondary{background:#10b981;color:#fff}
  .btn.secondary:hover{background:#10b981}
  .btn.ghost{background:#f3f4f6}
  .btn.ghost:hover{background:#f3f4f6}
  .plot{height:340px}
  .plots{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:1000px){.plots{grid-template-columns:1fr}}
</style>

<h2>Filter Wizard (Digital) — Design & Exploration</h2>
<p class="hint">Spec‑driven IIR design (Butterworth/Chebyshev I/II/Elliptic) with magnitude/phase, group delay, impulse & step response, and pole–zero map.
  You can still <em>Export</em> MATLAB/Python/Arduino and try the filter on an image.</p>

<div class="wizard-grid">
  <div class="card">
    <h3>Specifications</h3>
    <div class="body">
      <div class="field">
        <label>Design mode</label>
        <select id="mode">
          <option value="order">By order</option>
          <option value="specs">By specs (auto‑order)</option>
        </select>
      </div>

      <div class="row">
        <div class="field" style="flex:1">
          <label>Family</label>
          <select id="family">
            <option value="butter">Butterworth</option>
            <option value="cheby1">Chebyshev I</option>
            <option value="cheby2">Chebyshev II</option>
            <option value="ellip">Elliptic</option>
          </select>
        </div>
        <div class="field" style="flex:1">
          <label>Type</label>
          <select id="ftype">
            <option value="lowpass">Low‑pass</option>
            <option value="highpass">High‑pass</option>
            <option value="bandpass">Band‑pass</option>
            <option value="bandstop">Band‑stop</option>
          </select>
        </div>
      </div>

      <div class="row" id="orderRow">
        <div class="field" style="flex:1">
          <label>Order</label>
          <input id="order" type="number" min="1" max="12" value="6">
          <div class="hint">Used only in <b>By order</b> mode.</div>
        </div>
        <div class="field" style="flex:1">
          <label>Ripple / Atten (dB)</label>
          <div class="row">
            <input id="rp" type="number" step="0.1" value="1">
            <input id="rs" type="number" step="1" value="60">
          </div>
          <div class="hint">rp applies to Cheby I/Ellip; rs applies to Cheby II/Ellip.</div>
        </div>
      </div>

      <div class="card" style="border:none;background:transparent;padding:0">
        <div class="grid2">
          <div class="field">
            <label>fs (Hz)</label>
            <input id="fs" type="number" min="10" max="1000000" value="48000">
          </div>
          <div class="field">
            <label>Samples (time‑domain)</label>
            <input id="N" type="number" min="128" max="32768" value="4096">
          </div>
          <div class="field" id="cutSingle">
            <label>Cutoff fc (Hz)</label>
            <input id="fc" type="text" value="4000">
            <div class="hint">Comma‑separate for band filters, e.g. <code>1000, 6000</code></div>
          </div>
          <div id="specsBox" style="display:none">
            <div class="field">
              <label>Passband fp (Hz)</label>
              <input id="fp" type="text" value="4000">
            </div>
            <div class="field">
              <label>Stopband fs (Hz)</label>
              <input id="fsb" type="text" value="6000">
            </div>
            <div class="field">
              <label>g<sub>pass</sub> (dB)</label>
              <input id="gpass" type="number" step="0.1" value="1">
            </div>
            <div class="field">
              <label>g<sub>stop</sub> (dB)</label>
              <input id="gstop" type="number" step="1" value="60">
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn primary" id="designBtn">Design / Update</button>
        <span id="badge" class="badge warn">Ready</span>
        <select id="fmt">
          <option value="matlab">Export .M</option>
          <option value="python">Export .PY</option>
          <option value="arduino">Export .INO</option>
        </select>
        <button type="button" class="btn primary" id="dlBtn">⬇︎ Export</button>
        
      </div>
      <div class="hint">Info: Specify pass/stop bands and ripple/attenuation; the badge will tell you if specs are met.</div>
    </div>
  </div>

  <div class="card">
    <h3>Responses</h3>
    <div class="body">
      <div class="plots">
        <div id="magPlot" class="plot"></div>
        <div id="phasePlot" class="plot"></div>
        <div id="gdPlot" class="plot"></div>
        <div id="pzPlot" class="plot"></div>
        <div id="impPlot" class="plot"></div>
        <div id="stepPlot" class="plot"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.32.0.min.js" defer></script>
<script>
const $ = (id)=>document.getElementById(id);
const plotConfig={displayModeBar:true,responsive:true,scrollZoom:true};
const modeEl=$('mode'), famEl=$('family'), typeEl=$('ftype'), fsEl=$('fs'), orderEl=$('order'),
      rpEl=$('rp'), rsEl=$('rs'), NEl=$('N'), fcEl=$('fc'), fpEl=$('fp'), fsbEl=$('fsb'),
      gpassEl=$('gpass'), gstopEl=$('gstop');

function uiMode(){
  const specs=(modeEl.value==='specs');
  $('specsBox').style.display=specs?'block':'none';
  $('cutSingle').style.display=specs?'none':'block';
}
modeEl.addEventListener('change', uiMode); uiMode();

function params(){
  return {
    mode: modeEl.value,
    family: famEl.value,
    ftype: typeEl.value,
    fs: parseFloat(fsEl.value||48000),
    N: parseInt(NEl.value||4096),
    order: parseInt(orderEl.value||4),
    rp: parseFloat(rpEl.value||1),
    rs: parseFloat(rsEl.value||60),
    fc: fcEl.value,
    fp: fpEl.value,
    fsb: fsbEl.value,
    gpass: parseFloat(gpassEl.value||1),
    gstop: parseFloat(gstopEl.value||60)
  };
}

function layout(title,x,dby=false){
  return {title,margin:{l:50,r:10,t:28,b:40},xaxis:{title:x},yaxis:{title:dby?'Magnitude (dB)':'Amplitude'},height:340,hovermode:false};
}

function pzLayout(){
  return {title:'Pole–Zero Map',margin:{l:40,r:10,t:28,b:40},xaxis:{title:'Re',scaleanchor:'y',constrain:'domain'},yaxis:{title:'Im'},shapes:[{type:'circle',xref:'x',yref:'y',x0:-1,y0:-1,x1:1,y1:1,line:{dash:'dot'}}],height:340,hovermode:false};
}

async function design(){
  const badge=$('badge'); badge.textContent='Designing…'; badge.className='badge warn';
  const q=new URLSearchParams(params());
  const res=await fetch(`{{ url_for('filter_design.api') }}?`+q.toString());
  if(!res.ok){
    badge.textContent='Error'; badge.className='badge danger';
    const tx=await res.text(); alert(tx); return;
  }
  const d=await res.json();
  badge.textContent = (d.spec_ok? 'Meets specs' : 'Specs not met') + ` • N=${d.order} • ${d.family}`;
  badge.className = 'badge '+(d.spec_ok?'ok':'warn');

  Plotly.react('magPlot', [{x:d.f, y:d.H_db, mode:'lines', name:'|H| dB', hoverinfo:'skip'}], layout('Magnitude', 'Frequency (Hz)', true), plotConfig);
  Plotly.react('phasePlot', [{x:d.f, y:d.phase_deg, mode:'lines', name:'Phase (°)', hoverinfo:'skip'}], layout('Phase', 'Frequency (Hz)'), plotConfig);
  Plotly.react('gdPlot', [{x:d.f_gd, y:d.gd, mode:'lines', name:'τ (s)', hoverinfo:'skip'}], layout('Group delay', 'Frequency (Hz)'), plotConfig);
  Plotly.react('impPlot', [{x:d.t, y:d.h, mode:'lines', name:'h[n]', hoverinfo:'skip'}], layout('Impulse response', 'Time (s)'), plotConfig);
  Plotly.react('stepPlot', [{x:d.t, y:d.s, mode:'lines', name:'s[n]', hoverinfo:'skip'}], layout('Step response', 'Time (s)'), plotConfig);
  Plotly.react('pzPlot', [
    {x:d.z_re, y:d.z_im, mode:'markers', name:'zeros', marker:{symbol:'circle-open'}, hoverinfo:'skip'},
    {x:d.p_re, y:d.p_im, mode:'markers', name:'poles', marker:{symbol:'x', size:10}, hoverinfo:'skip'}
  ], pzLayout(), plotConfig);
}

$('designBtn').addEventListener('click', ev=>{ev.preventDefault(); design();});

$('dlBtn').addEventListener('click', ev=>{
  ev.preventDefault();
  const p=params();
  const qs = new URLSearchParams({fmt: $('fmt').value, filter_type: p.ftype, order: p.order, cutoff: (p.mode==='specs'? (p.fp): p.fc), sample_rate: p.fs});
  window.location = `{{ url_for('filter_design.export') }}?`+qs.toString();
});

// initial render
window.addEventListener('load', design);
window.addEventListener('resize', ()=>['magPlot','phasePlot','gdPlot','pzPlot','impPlot','stepPlot'].forEach(id=>{const el=$(id); if(el&&el.data) Plotly.Plots.resize(el);}));
</script>
{% endblock %}