{% extends "base.html" %}
{% block content %}
<h1>Chapter 2: Echo (Convolution)</h1>
<p>This demo shows the convolution of an input audio-signal with a Finite Impulse Response&nbsp;(FIR) Filter \(h[k]=\delta[k]+A\delta[k-\kappa]\) with attenuation \(A\) and delay \(\kappa\). Thus, the output signal is calculated as \(y[k] = x[k]+A\cdot x[k-\kappa]\).</p>

<style>
  .row{display:flex;gap:24px;align-items:flex-start;flex-wrap:wrap}
  .card{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;box-shadow:0 1px 5px rgba(0,0,0,.05);--sisy2-card-shadow:0 1px 5px rgba(0,0,0,.05)}
  label{display:block;margin-top:8px}
  input[type=range]{width:100%}
  img{max-width:100%}
</style>

<div class="row">
  <div style="margin-top:12px" class="card">
    <label>Input \(x[k]\)</label>
    <select id="x_type">
      {% for o in audio_options %}
        <option value="{{o}}" {% if o == defaults.x_type %}selected{% endif %}>{{o}}</option>
      {% endfor %}
    </select>

    <label>Delay \(\kappa\ [\mathrm s]\) : <span id="delay_val">{{defaults.delay}}</span></label>
    <input id="delay" type="range" min="0.0" max="1.0" step="0.05" value="{{defaults.delay}}">

    <label>Attenuation \(A\) : <span id="att_val">{{defaults.attenuation}}</span></label>
    <input id="attenuation" type="range" min="0.0" max="1.0" step="0.05" value="{{defaults.attenuation}}">

    <button id="run" style="margin-top:12px">Recompute</button>
  </div>

  <div class="card"><img id="plot" alt="plot"></div>

  <div class="card">
    <div><strong>Input \(x[k]\)</strong></div>
    <audio style="width:100%" id="x_audio" controls></audio>
    <div style="height:8px"></div>
    <div><strong>Output \(y[k]\)</strong></div>
    <audio style="width:100%" id="y_audio" controls></audio>
  </div>
</div>
<div class="card">
  <h3>Sources</h3>
  <ul>
    <li>Audio files:</li>
    <li>Elise: <a href="https://commons.wikimedia.org/wiki/File:Fur_Elise.ogg">https://commons.wikimedia.org/wiki/File/Fur_Elise.ogg</a></li>
    <li>Armstrong: <a href="https://commons.wikimedia.org/wiki/File:Neil_Armstrong_small_step.wav">https://commons.wikimedia.org/wiki/File:Neil_Armstrong_small_step.wav</a></li>
    <li>Snare: <a href="https://commons.wikimedia.org/wiki/File:Snare_drum_rim.ogg">https://commons.wikimedia.org/wiki/File:Snare_drum_rim.ogg</a></li>
  </ul>
</div>

<script>
  const $ = (id) => document.getElementById(id);
  function syncLabels(){
    $("delay_val").textContent = $("delay").value;
    $("att_val").textContent = $("attenuation").value;
  }
  async function recompute(){
    syncLabels();
    const body = {
      x_type: $("x_type").value,
      delay: parseFloat($("delay").value),
      attenuation: parseFloat($("attenuation").value),
    };
    const resp = await fetch("./compute", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(body)
    });
    if(!resp.ok){ alert("Error: " + await resp.text()); return; }
    const data = await resp.json();
    $("plot").src = data.image;
    $("x_audio").src = data.x_audio;
    $("y_audio").src = data.y_audio;
  }

  ["x_type","delay","attenuation"].forEach(id => $(id).addEventListener("input", () => recompute()));
  $("run").addEventListener("click", () => recompute());
  // initial render
  recompute();
</script>
{% endblock %}
