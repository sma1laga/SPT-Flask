
{% extends "base.html" %}
{% block content %}
<h1>Filter Demo</h1>
<p>This demo shows exemplary IIR/FIR filters from the exercises based on different input signals&nbsp;(audio and images).
Each filter can be analyzed by plotting its impulse response, pole-zero plot&nbsp;(z-plane), magnitude response, and phase response.</p>

<div class="demo">

<div class="row">
  <div class="card" style="margin-top:12px">
    <div class="kv">
      <div><strong>Input \(x[k]\)</strong></div>
      <div>
        <select id="x_type">
          {% for name in audio_options %}
            <option value="{{name}}" {% if name==defaults.x_type %}selected{% endif %}>{{name}}</option>
          {% endfor %}
        </select>
      </div>

      <div><strong>Filter Coefficients</strong></div>
      <div>
        <select id="ex">
          {% for name in ex_options %}
            <option value="{{name}}" {% if name==defaults.ex %}selected{% endif %}>{{name}}</option>
          {% endfor %}
        </select>
      </div>

      <div><strong>Plot</strong></div>
      <div>
        {% for p in plots %}
          <label class="hstack"><input type="radio" name="plot" value="{{p}}" {% if p==defaults.plot %}checked{% endif %}>{{p}}</label>
        {% endfor %}
      </div>
    </div>

    <div class="hstack" style="margin-top:12px">
      <button id="run">Recompute</button>
    </div>
  </div>
 <!-- TODO show H(z) in tex -->
  <div class="card">
    <img id="plot" alt="plot">
  </div>

  <div class="card">
    <div><strong>Audio</strong></div>
    <div class="hstack" style="margin-top:8px">
      <div style="flex:1">
        <div><small>Input \(x[k]\)</small></div>
        <audio style="width:100%" id="x_audio" controls></audio>
      </div>
      <div style="flex:1">
        <div><small>Filtered \(y[k]\)</small></div>
        <audio style="width:100%" id="y_audio" controls></audio>
      </div>
    </div>
  </div>
</div>
</div>

<script>
  const $ = (id) => document.getElementById(id);
  function currentPlot(){
    const r = document.querySelector('input[name="plot"]:checked');
    return r ? r.value : "{{ defaults.plot }}";
  }
  function payload(){
    return {
      x_type: $("x_type").value,
      ex: $("ex").value,
      plot: currentPlot(),
    };
  }

  async function recompute(){
    try{
      const res = await fetch("./compute", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload())
      });
      const data = await res.json();
      if(data.error){
        console.error(data.error);
        alert(data.error);
        return;
      }
      $("plot").src = data.image;
      $("x_audio").src = data.x_audio || "";
      $("y_audio").src = data.y_audio || "";
    }catch(e){
      console.error(e);
      alert(e);
    }
  }

  ["x_type","ex"].forEach(id => $(id).addEventListener("change", () => recompute()));
  document.querySelectorAll('input[name="plot"]').forEach(r =>
    r.addEventListener("change", () => recompute())
  );
  $("run").addEventListener("click", () => recompute());

  // initial draw
  recompute();
</script>
{% endblock %}
