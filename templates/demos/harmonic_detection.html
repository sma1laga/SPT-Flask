{% extends "base.html" %}
{% block content %}
<div class="container wide-container harmonic-layout">
  <div class="page-header">
    <div>
      <h1>Harmonic detection</h1>
      <p>
        Explore a sinusoid embedded in noise like the original MATLAB demo. Adjust the signal-to-noise ratio (SNR),
        change the number of samples used for statistics, and switch between autocorrelation and spectral views.
      </p>
    </div>
    <div class="chip-row">
      <div class="pill"><i class="fa fa-sliders"></i>Interactive shifters</div>
      <div class="pill pill-subtle"><i class="fa fa-line-chart"></i>Five synced plots</div>
    </div>
  </div>

  <style>
    :root { --hd-plot-height: clamp(190px, 25vh, 230px); }
    .harmonic-layout{max-width:min(1260px, calc(100vw - 28px));margin:0 auto;}
    .page-header{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start;margin-bottom:6px}
    .page-header h1{margin:0;font-size:1.7rem}
    .page-header p{margin:4px 0 0}
    .chip-row{display:flex;gap:6px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;background:#e0f2fe;color:#0f3b64;font-weight:700;font-size:0.9rem}
    .pill-subtle{background:#f3f4f6;color:#4b5563}
    .control-card{background:white;border:1px solid #d9dfe7;border-radius:12px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);margin-bottom:10px}
    .control-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;align-items:start}
    .kv-row{display:grid;grid-template-columns:140px 1fr 64px;gap:6px;align-items:center;margin:6px 0}
    .kv-row label{font-weight:700;font-size:0.92rem}
    .kv-row input[type="number"]{width:100%}
    .kv-row small{color:#6b7280}
    .mode-row{display:flex;gap:10px;flex-wrap:wrap;margin:4px 0}
    .mode-row label{font-weight:700;font-size:0.9rem}
    .stat-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;margin-top:6px}
    .stat-box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:8px}
    .stat-label{font-size:0.78rem;color:#6b7280;font-weight:800;letter-spacing:0.04em;text-transform:uppercase}
    .stat-value{font-size:1.02rem;font-weight:800;color:#0f172a}
    .plots-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px;align-items:start}
    .plot-box{border:1px solid #e5e7eb;border-radius:10px;padding:6px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.03)}
    .plot-box h4{margin:4px 6px;font-size:0.93rem;color:#111827;display:flex;align-items:center;gap:6px}
    .plot{width:100%;height:var(--hd-plot-height);min-height:185px}
    .btn-primary{background:#2563eb;color:white;border:none;border-radius:8px;padding:8px 11px;font-weight:700;cursor:pointer;box-shadow:0 2px 8px rgba(37,99,235,0.25)}
    body.statsip-sidebar-collapsed .harmonic-layout{max-width:min(1380px, calc(100vw - 16px))}
    body.statsip-sidebar-collapsed .plots-grid{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    body.statsip-sidebar-collapsed{--hd-plot-height: clamp(185px, 24vh, 215px)}
    body.statsip-sidebar-collapsed .control-grid{grid-template-columns:repeat(auto-fit,minmax(230px,1fr))}
    body.statsip-sidebar-collapsed .kv-row{grid-template-columns:128px 1fr 60px}
    body.dark-mode .control-card{background:#0b1628;border-color:#1f2937;box-shadow:0 8px 20px rgba(0,0,0,0.35)}
    body.dark-mode .plot-box{background:#0f172a;border-color:#27303f;box-shadow:0 8px 20px rgba(0,0,0,0.28)}
    body.dark-mode .plot-box h4{color:#e2e8f0}
    body.dark-mode .pill{background:rgba(59,130,246,0.14);color:#e0e7ff}
    body.dark-mode .pill-subtle{background:rgba(148,163,184,0.18);color:#e5e7eb}
    body.dark-mode .stat-box{background:#111827;border-color:#27303f}
    body.dark-mode .stat-label{color:#cbd5e1}
    body.dark-mode .stat-value{color:#f8fafc}
    body.dark-mode label, body.dark-mode p{color:#e2e8f0}
    body.dark-mode .btn-primary{background:#1d4ed8;box-shadow:0 2px 10px rgba(59,130,246,0.35)}  
  </style>

  <div class="control-card">
    <div class="pill" style="margin-bottom:8px"><i class="fa fa-sliders"></i>Controls</div>
    <div class="control-grid">
      <div>
        <div class="kv-row">
          <label for="snr-slider">SNR (dB)</label>
          <input type="range" id="snr-slider" min="-20" max="40" step="0.1" value="{{ defaults.snr }}">
          <input type="number" id="snr-input" step="0.1" value="{{ defaults.snr }}">
        </div>
        <div class="kv-row">
          <label for="sample-slider">Samples for stats</label>
          <input type="range" id="sample-slider" min="0" max="1" step="0.01">
          <input type="number" id="sample-input" min="100" max="100000" step="100" value="{{ defaults.sample_count }}">
        </div>
        <div class="mode-row" role="radiogroup" aria-label="View mode">
          <label><input type="radio" name="view-mode" value="autocorrelation" checked> Autocorrelation focus</label>
          <label><input type="radio" name="view-mode" value="psd"> PSD view</label>
        </div>
        <button id="update-btn" class="btn-primary"><i class="fa fa-refresh"></i> Update plots</button>
      </div>
      <div>
        <div class="stat-row">
          <div class="stat-box">
            <div class="stat-label">Signal variance</div>
            <div id="stat-svar" class="stat-value">—</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Noise variance</div>
            <div id="stat-nvar" class="stat-value">—</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">SNR</div>
            <div id="stat-snr" class="stat-value">—</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Samples</div>
            <div id="stat-samples" class="stat-value">—</div>
          </div>
        </div>
        <p style="color:#4b5563;margin-top:10px">Shifters and inputs live here above the plots, mirroring the MATLAB control box.</p>
      </div>
    </div>
  </div>

  <div class="plots-grid">
    <div class="plot-box"><h4>Harmonic (clean)</h4><div id="plot-harmonic" class="plot"></div></div>
    <div class="plot-box"><h4>Noise</h4><div id="plot-noise" class="plot"></div></div>
    <div class="plot-box"><h4>Harmonic in aperiodic noise</h4><div id="plot-combined" class="plot"></div></div>
    <div class="plot-box"><h4 id="plot4-title">Clipped autocorrelation</h4><div id="plot-4" class="plot"></div></div>
    <div class="plot-box"><h4 id="plot5-title">Normalised autocorrelation</h4><div id="plot-5" class="plot"></div></div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
  const defaults = {{ defaults | tojson }};
  const computeUrl = "{{ url_for('demos_harmonic_detection.compute') }}";
  const snrSlider = document.getElementById('snr-slider');
  const snrInput = document.getElementById('snr-input');
  const sampleSlider = document.getElementById('sample-slider');
  const sampleInput = document.getElementById('sample-input');
  const updateBtn = document.getElementById('update-btn');
  const modeRadios = document.querySelectorAll('input[name="view-mode"]');

  const statEls = {
    svar: document.getElementById('stat-svar'),
    nvar: document.getElementById('stat-nvar'),
    snr: document.getElementById('stat-snr'),
    samples: document.getElementById('stat-samples'),
  };
  let latestData = null;

  const plot4Title = document.getElementById('plot4-title');
  const plot5Title = document.getElementById('plot5-title');

  const SAMPLE_MIN = 100;
  const SAMPLE_MAX = 100000;

  function buildLayout(layout){
    const isDark = document.body.classList.contains('dark-mode');
    const axisColor = isDark ? '#e2e8f0' : '#111827';
    const gridColor = isDark ? '#334155' : '#e5e7eb';
    const merged = {
      paper_bgcolor: 'transparent',
      plot_bgcolor: 'transparent',
      font: { color: axisColor },
      ...layout,
    };
    const baseX = layout.xaxis || {};
    const baseY = layout.yaxis || {};
    merged.xaxis = { gridcolor: gridColor, zerolinecolor: gridColor, ...baseX, color: axisColor };
    merged.yaxis = { gridcolor: gridColor, zerolinecolor: gridColor, ...baseY, color: axisColor };
    return merged;
  }

  function sliderToSamples(v){
    const logMin = Math.log10(SAMPLE_MIN);
    const logMax = Math.log10(SAMPLE_MAX);
    const val = Math.pow(10, logMin + v * (logMax - logMin));
    return Math.round(val);
  }

  function samplesToSlider(count){
    const clamped = Math.min(Math.max(count, SAMPLE_MIN), SAMPLE_MAX);
    const logMin = Math.log10(SAMPLE_MIN);
    const logMax = Math.log10(SAMPLE_MAX);
    return (Math.log10(clamped) - logMin) / (logMax - logMin);
  }

  function syncSampleFromSlider(){
    const samples = sliderToSamples(parseFloat(sampleSlider.value));
    sampleInput.value = samples;
  }

  function syncSampleFromInput(){
    const samples = parseInt(sampleInput.value || defaults.sample_count, 10);
    sampleSlider.value = samplesToSlider(samples);
  }

  function syncSnrFromSlider(){
    snrInput.value = parseFloat(snrSlider.value).toFixed(1);
  }

  function syncSnrFromInput(){
    snrSlider.value = snrInput.value;
  }

  async function fetchData(){
    const snr = parseFloat(snrInput.value);
    const sampleCount = parseInt(sampleInput.value, 10) || defaults.sample_count;
    const response = await fetch(computeUrl, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ snr, sample_count: sampleCount })
    });
    if(!response.ok){
      throw new Error('Server error: ' + response.status);
    }
    return response.json();
  }
  function getPlotHeight(targetId){
    const el = document.getElementById(targetId);
    if(!el) return 240;
    const prev = el.style.height;
    el.style.height = '';
    const h = parseFloat(getComputedStyle(el).height || '0');
    el.style.height = prev;
    return Number.isFinite(h) && h > 0 ? h : 240;
  }

  function renderLine(target, x, y, title, xLabel, yLabel, yRange=null){
    const trace = {x, y, mode: 'lines', line: {color: '#2563eb', width: 2}};
    const plotHeight = getPlotHeight(target);
    const layout = buildLayout({
      margin: {l:50,r:10,b:45,t:10},
      xaxis: {title: xLabel},
      yaxis: {title: yLabel, range: yRange},
      height: plotHeight,
    });
    Plotly.newPlot(target, [trace], layout, {displaylogo:false, responsive:true});
  }

  function renderPlots(data){
    const mode = document.querySelector('input[name="view-mode"]:checked').value;

    renderLine('plot-harmonic', data.time_ms, data.harmonic, 'Harmonic', 't [ms]', 'Amplitude');
    renderLine('plot-noise', data.time_ms, data.noise, 'Noise', 't [ms]', 'Amplitude');
    renderLine('plot-combined', data.time_ms, data.combined, 'Combined', 't [ms]', 'Amplitude');

    if(mode === 'autocorrelation'){
      plot4Title.textContent = 'Clipped autocorrelation';
      plot5Title.textContent = 'Normalised autocorrelation';
      renderLine('plot-4', data.acorr.lags_ms, data.acorr.clipped, 'AC', 'τ [ms]', 'R_{xx}', [-1.5,1.5]);
      renderLine('plot-5', data.acorr.lags_ms, data.acorr.normalized, 'Norm AC', 'τ [ms]', 'R_{xx}');
    } else {
      plot4Title.textContent = 'Normalised autocorrelation';
      plot5Title.textContent = 'Power spectral density';
      renderLine('plot-4', data.acorr.lags_ms, data.acorr.normalized, 'Norm AC', 'τ [ms]', 'R_{xx}');
      Plotly.newPlot('plot-5', [{x: data.psd.freqs, y: data.psd.values_db, mode:'lines', line:{color:'#dc2626', width:2}}], buildLayout({
        margin:{l:50,r:10,b:45,t:10},
        xaxis:{title:'frequency [Hz]'},
        yaxis:{title:'10log_{10}(S_{xx})'},
        height:getPlotHeight('plot-5')
      }), {displaylogo:false, responsive:true});
    }

    statEls.svar.textContent = data.stats.signal_variance.toFixed(3);
    statEls.nvar.textContent = data.stats.noise_variance.toFixed(3);
    statEls.snr.textContent = data.stats.snr_db.toFixed(1) + ' dB';
    statEls.samples.textContent = data.stats.sample_count.toLocaleString();
  }

  async function update(){
    try{
      const data = await fetchData();
      latestData = data;
      renderPlots(data);
    }catch(err){
      console.error(err);
      alert(err.message);
    }
  }
  function rerenderPlots(){
    if(latestData){
      renderPlots(latestData);
    }
  }

  snrSlider.value = defaults.snr;
  snrInput.value = defaults.snr;
  sampleSlider.value = samplesToSlider(defaults.sample_count);
  syncSampleFromSlider();

  snrSlider.addEventListener('input', syncSnrFromSlider);
  snrInput.addEventListener('change', syncSnrFromInput);
  sampleSlider.addEventListener('input', syncSampleFromSlider);
  sampleInput.addEventListener('change', syncSampleFromInput);
  updateBtn.addEventListener('click', update);
  modeRadios.forEach(r => r.addEventListener('change', update));
  let resizeTimer = null;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(rerenderPlots, 140);
  });

  const statsipToggle = document.getElementById('statsip-sidebar-toggle');
  if(statsipToggle){
    statsipToggle.addEventListener('click', () => setTimeout(rerenderPlots, 180));
  }

  update();
</script>
{% endblock %}