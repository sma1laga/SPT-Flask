{% extends "base.html" %}
{% block content %}
<div class="container delay-layout">
  <div class="page-header delay-header">
    <div>
      <h1>Delay Estimation (time domain)</h1>
      <p class="lede">
        Two noisy observations of the same signal are shifted relative to each other.
        Adjust the SNR, choose the underlying signal (noise, speech, or sinusoid), and set a delay to see the
        cross-correlation peak move.
      </p>
    </div>
    <div class="chip-row">
      <div class="pill pill-primary"><i class="fa fa-sliders"></i>Shifters above plots</div>
      <div class="pill pill-muted"><i class="fa fa-random"></i>Independent noises</div>
      <div class="pill pill-outline"><i class="fa fa-bolt"></i>Cross-correlation peak</div>
    </div>
  </div>

  <style>
    .delay-layout{
      --plot-height:210px;
      --xcorr-height:250px;
      max-width:min(1180px, calc(100vw - 32px));
    }
    body.statsip-sidebar-collapsed .delay-layout{
      max-width:min(1320px, calc(100vw - 18px));
      --plot-height:200px;
      --xcorr-height:240px;
    }
    .delay-header{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-start;
      margin-bottom:10px;
    }
    .delay-header h1{margin-bottom:6px;}
    .delay-header p{margin-bottom:6px;max-width:880px;}
    .chip-row{display:flex;gap:8px;flex-wrap:wrap;}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:7px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:0.9rem;
    }
    .pill-primary{background:#e0f2fe;color:#0f3b64;}
    .pill-muted{background:#f3f4f6;color:#374151;}
    .pill-outline{background:#e5e7eb;color:#111827;}
    .control-card{
      background:white;
      border:1px solid #d9dfe7;
      border-radius:12px;
      padding:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
      margin-bottom:12px;
    }
    .controls-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
      gap:10px;
      align-items:end;
    }
    .range-pair{
      display:grid;
      grid-template-columns:1fr 88px;
      gap:8px;
      align-items:center;
    }
    .stat-cluster{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .stat-label{font-size:0.8rem;font-weight:800;color:#6b7280;text-transform:uppercase;margin-bottom:2px;}
    .stat-value{font-weight:800;color:#0f172a;}
    .plots-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
      gap:10px;
      align-items:start;
    }
    .plot-box{
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:8px;
      background:#fff;
      box-shadow:0 2px 8px rgba(0,0,0,0.03);
    }
    .plot-box h4{margin:0 0 4px;color:#0f172a;font-size:1rem;line-height:1.4;}
    .plot-target{height:var(--plot-height);}
    #plot-xcorr.plot-target{height:var(--xcorr-height);}
    .text-muted{margin-top:4px;display:block;}
    .lede{line-height:1.5;}
    body.dark-mode .control-card{background:#0b1628;border-color:#1f2937;box-shadow:0 8px 18px rgba(0,0,0,0.35);}
    body.dark-mode .plot-box{background:#0f172a;border-color:#27303f;box-shadow:0 8px 20px rgba(0,0,0,0.28);}
    body.dark-mode .plot-box h4{color:#e2e8f0;}
    body.dark-mode .pill-primary,
    body.dark-mode .pill-outline,
    body.dark-mode .pill-muted{
      background:rgba(59,130,246,0.14);
      color:#e0e7ff;
    }
    body.dark-mode .text-muted, body.dark-mode label{color:#cbd5e1!important;}
    body.dark-mode .stat-label{color:#cbd5e1;}
    body.dark-mode .stat-value{color:#f8fafc;}
    body.dark-mode .btn-primary{background:#1d4ed8;color:#fff;}
    @media(max-width:980px){
      .controls-grid{grid-template-columns:repeat(auto-fit,minmax(210px,1fr));}
      .plots-grid{grid-template-columns:repeat(auto-fit,minmax(280px,1fr));}
    }
    @media(max-height:900px){
      .delay-layout{--plot-height:190px;--xcorr-height:225px;}
    }
  </style>

  <div class="control-card">
    <div class="controls-grid">
      <div>
        <label for="signal-kind" style="font-weight:700;">Input signal</label>
        <select id="signal-kind" class="form-control">
          <option value="noise">White noise</option>
          <option value="speech">Speech (static audio)</option>
          <option value="sinusoid">Sinusoid 100 Hz</option>
        </select>
      </div>
      <div>
        <label for="snr-slider" style="font-weight:700;">SNR (dB)</label>
        <div class="range-pair">
          <input id="snr-slider" type="range" min="-10" max="40" step="0.1" value="{{ defaults.snr }}">
          <input id="snr-input" type="number" step="0.1" class="form-control" value="{{ defaults.snr }}">
        </div>
        <small class="text-muted">Noise realizations stay fixed; only the scaling changes with SNR.</small>
      </div>
      <div>
        <label for="delay-slider" style="font-weight:700;">Delay (ms)</label>
        <div class="range-pair">
          <input id="delay-slider" type="range" min="-50" max="50" step="1" value="{{ defaults.delay_ms }}">
          <input id="delay-input" type="number" step="1" class="form-control" value="{{ defaults.delay_ms }}">
        </div>
        <small class="text-muted">Positive values delay Y₂(t) relative to Y₁(t).</small>
      </div>
      <div class="stat-cluster">
        <div>
          <div class="stat-label">Signal variance</div>
          <div id="stat-svar" class="stat-value">—</div>
        </div>
        <div>
          <div class="stat-label">Noise variance</div>
          <div id="stat-nvar" class="stat-value">—</div>
        </div>
        <div>
          <div class="stat-label">Delay [ms]</div>
          <div id="stat-delay" class="stat-value">—</div>
        </div>
        <button id="update-btn" class="btn btn-primary" style="padding:10px 14px;font-weight:700;white-space:nowrap;">Update</button>
      </div>
    </div>
  </div>

  <div class="plots-grid">
    <div class="plot-box">
      <h4>Observation Y₁(t) = X(t) + N₁(t)</h4>
      <div id="plot-signal1" class="plot-target"></div>
    </div>
    <div class="plot-box">
      <h4>Observation Y₂(t) = X(t−τ₀) + N₂(t)</h4>
      <div id="plot-signal2" class="plot-target"></div>
    </div>
    <div class="plot-box" style="grid-column:1 / -1;">
      <h4>Cross-correlation R<sub>Y₁Y₂</sub>(τ)</h4>
      <div id="plot-xcorr" class="plot-target"></div>
    </div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
  const defaults = {{ defaults | tojson }};
  const computeUrl = "{{ url_for('demos_delay_estimation.compute') }}";

  const signalKind = document.getElementById('signal-kind');
  const snrSlider = document.getElementById('snr-slider');
  const snrInput = document.getElementById('snr-input');
  const delaySlider = document.getElementById('delay-slider');
  const delayInput = document.getElementById('delay-input');
  const updateBtn = document.getElementById('update-btn');

  const statEls = {
    svar: document.getElementById('stat-svar'),
    nvar: document.getElementById('stat-nvar'),
    delay: document.getElementById('stat-delay'),
  };

  function buildLayout(layout){
    const isDark = document.body.classList.contains('dark-mode');
    const axisColor = isDark ? '#e2e8f0' : '#111827';
    const gridColor = isDark ? '#334155' : '#e5e7eb';
    const merged = {
      paper_bgcolor: 'transparent',
      plot_bgcolor: 'transparent',
      font: { color: axisColor },
      ...layout,
    };
    const baseX = layout.xaxis || {};
    const baseY = layout.yaxis || {};
    merged.xaxis = { gridcolor: gridColor, zerolinecolor: gridColor, ...baseX, color: axisColor };
    merged.yaxis = { gridcolor: gridColor, zerolinecolor: gridColor, ...baseY, color: axisColor };
    return merged;
  }

  function syncSliderAndInput(slider, input) {
    slider.addEventListener('input', () => {
      input.value = slider.value;
    });
    input.addEventListener('change', () => {
      slider.value = input.value;
    });
  }

  syncSliderAndInput(snrSlider, snrInput);
  syncSliderAndInput(delaySlider, delayInput);

  async function fetchData() {
    const payload = {
      snr: parseFloat(snrInput.value),
      delay_ms: parseFloat(delayInput.value),
      signal_kind: signalKind.value,
    };

    const response = await fetch(computeUrl, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    if (!response.ok) {
      throw new Error('Server error: ' + response.status);
    }
    return response.json();
  }

  function getPlotHeight(kind){
    const layout = document.querySelector('.delay-layout');
    const styles = layout ? getComputedStyle(layout) : null;
    const raw = styles?.getPropertyValue(kind === 'xcorr' ? '--xcorr-height' : '--plot-height');
    const parsed = raw ? parseInt(raw, 10) : NaN;
    return Number.isFinite(parsed) ? parsed : (kind === 'xcorr' ? 240 : 200);
  }

  function renderLine(target, x, y, xLabel, yLabel, extras = {}) {
    const line = {
      x,
      y,
      mode: 'lines',
      line: {color: extras.color || '#2563eb', width: 2}
    };
    const layout = buildLayout({
      margin: {l: 52, r: 8, b: 40, t: 6},
      xaxis: {title: xLabel},
      yaxis: {title: yLabel, range: extras.yRange},
      height: extras.height || getPlotHeight(extras.kind),
    });
    Plotly.newPlot(target, [line], layout, {displaylogo: false, responsive: true});
  }

  function renderPlots(data) {
    renderLine('plot-signal1', data.time_ms, data.signal1, 't [ms]', 'Amplitude');
    renderLine('plot-signal2', data.time_ms, data.signal2, 't [ms]', 'Amplitude');
    renderLine('plot-xcorr', data.lags_ms, data.xcorr, 'τ [ms]', 'R_{Y₁Y₂}(τ)', {kind: 'xcorr'});

    statEls.svar.textContent = data.stats.signal_variance.toFixed(4);
    statEls.nvar.textContent = data.stats.noise_variance.toFixed(4);
    statEls.delay.textContent = data.stats.delay_ms.toFixed(1);
  }

  async function update() {
    updateBtn.disabled = true;
    updateBtn.textContent = 'Updating…';
    try {
      const data = await fetchData();
      renderPlots(data);
    } catch (err) {
      console.error(err);
      alert(err.message);
    } finally {
      updateBtn.disabled = false;
      updateBtn.textContent = 'Update';
    }
  }

  updateBtn.addEventListener('click', update);
  window.addEventListener('load', update);
</script>
{% endblock %}