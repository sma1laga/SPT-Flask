{% extends "base.html" %}
{% block content %}
<h1>Sampling (L&nbsp;11-18)</h1>
<p>
  This demo shows signals in the time and frequency domain before and after sampling with the sampling frequency&nbsp;\(\omega_\mathrm{a}\) as described in Chapter&nbsp;11.
  As an example, the input signal&nbsp;\(x(t)\) is
  \[
    x(t) = \frac{\omega_\mathrm{g}}{2\pi}\,\mathrm{si}^2\!\left(\frac{1}{2}\omega_\mathrm{g}t\right),
  \]
  with the spectrum&nbsp;\(X(\mathrm{j}\omega)\), calculated as
  \[
    X(\mathrm{j}\omega) = \Lambda\!\left(\frac{\omega}{\omega_\mathrm{g}}\right)
    = \frac{1}{\omega_\mathrm{g}}\cdot\mathrm{rect}\!\left(\frac{\omega}{\omega_\mathrm{g}}\right) \ast \mathrm{rect}\!\left(\frac{\omega}{\omega_\mathrm{g}}\right).
  \]
  The input signal&nbsp;\(x(t)\) is sampled, resulting in&nbsp;\(x_\mathrm{a}(t)\) (c.f. L&nbsp;11-13 to &nbsp;11-14), and reconstructed to obtain&nbsp;\(y(t)\) (c.f. &nbsp;11-16 to&nbsp;11-18).
  You can view&nbsp;\(x_\mathrm{a}(t)\) and&nbsp;\(y(t)\) and their respective spectra&nbsp;\(X_\mathrm{a}(\mathrm{j}\omega)\) and&nbsp;\(Y(\mathrm{j}\omega)\) in time and frequency domain, and optionally display the individual \(\mathrm{si}\)-functions that sum up to&nbsp;\(y(t)\).
  Adjust the sampling frequency&nbsp;\(\omega_\mathrm{a}\) and the cutoff frequency&nbsp;\(\omega_\mathrm{g}\) to see the effect of aliasing.
</p>


<div class="demo row">
  <div class="card">
    <div class="toolbar">
      <div>
        <label for="wg_over_pi">\(\omega_\mathrm{g} / \pi\)</label>
        <input id="wg_over_pi" type="number" step="{{ defaults.step }}"
              min="{{ defaults.min_wg }}" max="{{ defaults.max_wg }}"
              value="{{ defaults.w_g_over_pi }}">
      </div>
      <div>
        <label for="wa_over_pi">\(\omega_\mathrm{a} / \pi\)</label>
        <input id="wa_over_pi" type="number" step="{{ defaults.step }}"
              min="{{ defaults.min_wa }}" max="{{ defaults.max_wa }}"
              value="{{ defaults.w_a_over_pi }}">
      </div>
    </div>
    
    <div>
      Plot...
      <div class="toolbar" style="text-align: left;">
        <div>
          <input id="show_xt" type="checkbox" style="accent-color: black;"
            {% if defaults.show_xt %}checked{% endif %}><label for="show_xt">\(x(t)\)</label>
        </div>
        <div>
          <input id="show_xa" type="checkbox" style="accent-color: var(--tab-blue);"
            {% if defaults.show_xa %}checked{% endif %}><label for="show_xa">\(x_\mathrm{a}(t)\)</label>
        </div>
        <div>
          <input id="show_yt" type="checkbox" style="accent-color: var(--tab-red);"
            {% if defaults.show_yt %}checked{% endif %}><label for="show_yt">\(y(t)\)</label>
        </div>
        <div>
          <input id="show_partials" type="checkbox" style="accent-color: var(--tab-green);"
            {% if defaults.show_partials %}checked{% endif %}><label for="show_partials">partial sums of&nbsp;\(y(t)\)</label>
        </div>
        <div>
          <input id="show_X"  type="checkbox" style="accent-color: black;"
            {% if defaults.show_X %}checked{% endif %}><label for="show_X">\(X(\mathrm{j}\omega)\)</label>
        </div>
        <div>
          <input id="show_Xa" type="checkbox" style="accent-color: var(--tab-blue);"
            {% if defaults.show_Xa %}checked{% endif %}><label for="show_Xa">\(X_\mathrm{a}(\mathrm{j}\omega)\)</label>
        </div>
        <div>
          <input id="show_Y"  type="checkbox" style="accent-color: var(--tab-red);"
            {% if defaults.show_Y %}checked{% endif %}><label for="show_Y">\(Y(\mathrm{j}\omega)\)</label>
        </div>
      </div>
    </div>

    <div class="toolbar">
      <button id="run" type="button">Update</button>
      <button id="reset" type="button">Reset</button>
    </div>
  </div>

  <div class="card">
    <img id="plot" alt="Sampling: time and frequency-domain plots">
  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
  const $ = (id) => document.getElementById(id);

  let inFlight = null;
  let debounceTimer = null;
  let SEQ = 0;

  function payload() {
    return {
      w_g_over_pi: parseFloat($("wg_over_pi").value),
      w_a_over_pi: parseFloat($("wa_over_pi").value),
      show_xt: $("show_xt").checked,
      show_xa: $("show_xa").checked,
      show_yt: $("show_yt").checked,
      show_partials: $("show_partials").checked,
      show_X: $("show_X").checked,
      show_Xa: $("show_Xa").checked,
      show_Y: $("show_Y").checked,
      seq: ++SEQ
    };
  }

  async function recompute() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      if (inFlight) inFlight.abort();
      inFlight = new AbortController();

      const body = payload();

      try {
        const resp = await fetch("./compute", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(body),
          signal: inFlight.signal
        });
        if (!resp.ok) return;
        const data = await resp.json();
        if (data.seq !== undefined && data.seq < SEQ) return;
        if (data.image) $("plot").src = data.image;
      } catch(e) {
    
      } finally {
        inFlight = null;
      }
    }, 80);
  }

  ["wg_over_pi","wa_over_pi","show_xt","show_xa","show_yt","show_partials","show_X","show_Xa","show_Y"].forEach(id => {
    $(id).addEventListener("input",  recompute);
    $(id).addEventListener("change", recompute);
  });

  $("run").addEventListener("click", recompute);

  $("reset").addEventListener("click", () => {
    $("wg_over_pi").value = "{{ defaults.w_g_over_pi }}";
    $("wa_over_pi").value = "{{ defaults.w_a_over_pi }}";
    $("show_xt").checked = {{ 'true' if defaults.show_xt else 'false' }};
    $("show_xa").checked = {{ 'true' if defaults.show_xa else 'false' }};
    $("show_yt").checked = {{ 'true' if defaults.show_yt else 'false' }};
    $("show_partials").checked = {{ 'true' if defaults.show_partials else 'false' }};
    $("show_X").checked = {{ 'true' if defaults.show_X else 'false' }};
    $("show_Xa").checked = {{ 'true' if defaults.show_Xa else 'false' }};
    $("show_Y").checked = {{ 'true' if defaults.show_Y else 'false' }};
    recompute();
  });

  window.addEventListener("load", recompute);
</script>
{% endblock %}
