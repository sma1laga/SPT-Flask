{% extends "base.html" %}
{% block content %}
<h1>Chapter 11: Noise Analysis</h1>
<p>
  This demo shows the Autocorrelation Function&nbsp;(ACF) \(\varphi_{xx}[\kappa]\) and the Power Spectral Density&nbsp;(PSD) \(\Phi_{xx}(\mathrm e^{\mathrm j\Omega})\) of a random process \(x[k]\).  
  For a single realization \(x_i[k]\) of \(x[k]\), the ACF and PSD can be calculated as:

  $$\varphi_{xx}[\kappa] = \sum_{k=-\infty}^\infty x_i[k+\kappa]x_i^\ast[k]$$
  and
  $$\Phi_{xx}(\mathrm e^{\mathrm j\Omega}) = \mathcal F_\ast\{\varphi_{xx}[\kappa]\} = \sum_{\kappa=-\infty}^\infty \varphi_{xx}[\kappa]\mathrm e^{-\mathrm jk\Omega},$$

  with the normalized frequency \(\Omega=\omega T\) with sampling interval \(T=\frac{1}{f_\mathrm s}\).
</p>

<style>
  .row{display:flex;gap:24px;align-items:flex-start;flex-wrap:wrap}
  .card{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
  label{display:block;margin-top:8px}
  img{max-width:100%}
  select, .radio-group{width:100%}
  .radio-group label{display:inline-flex;align-items:center;gap:6px;margin-right:14px;margin-top:6px}
</style>

<div class="row">
  <div class="card" style="min-width:280px; margin-top:12px">
    <label>Input \(x[k]\)</label>
    <select id="x_type">
      {% for s in sig_options %}
        <option value="{{s}}" {% if s == defaults.x_type %}selected{% endif %}>{{s}}</option>
      {% endfor %}
    </select>

    <label style="margin-top:12px;">Visualization</label>
    <div class="radio-group">
      {% for title, key in plot_options %}
        <label><input type="radio" name="plt" value="{{key}}" {% if key == defaults.plt %}checked{% endif %}> {{title}}</label>
      {% endfor %}
    </div>

    <button id="run" style="margin-top:12px">Recompute</button>
  </div>

  <div class="card">
    <img id="plot" alt="plot">
  </div>

  <div class="card">
    <div><strong>Input \(x[k]\)</strong></div>
    <audio style="width:100%" id="x_audio" controls></audio>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  function currentPlot(){
    const r = document.querySelector('input[name="plt"]:checked');
    return r ? r.value : "{{defaults.plt}}";
  }

  async function recompute(){
    const body = { x_type: $("x_type").value, plt: currentPlot() };
    const resp = await fetch("./compute", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(body)
    });
    if(!resp.ok){ alert("Error: " + await resp.text()); return; }
    const data = await resp.json();
    $("plot").src = data.image;
    $("x_audio").src = data.x_audio;
  }

  $("x_type").addEventListener("change", () => recompute());
  document.querySelectorAll('input[name="plt"]').forEach(r => r.addEventListener("change", () => recompute()));
  $("run").addEventListener("click", () => recompute());
  recompute();
</script>
{% endblock %}
