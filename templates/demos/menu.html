{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/demos_menu.css') }}">

<div class="demo-library">
  <header class="library-hero" aria-label="Demo library overview">
    <div class="library-hero__text">
      <div class="library-eyebrow"><i class="fa-solid fa-bolt"></i> Interactive demo library</div>
      <h1>Signal Processing demos</h1>
        <p>Explore concise, guided simulations from Signals and Systems I &amp; II. Pick a lecture and launch the module you
          need in seconds. These demos are created and used at University of Erlangen-Nuremberg for lectures and tutorials, yet they're ready to support
          anyone curious about the topics.
        </p>
    </div>

    <div class="library-hero__meta">
      <div class="meta-pill" title="Shortcut: press / to focus the search">
        <kbd>/</kbd> Search
      </div>
      <div class="meta-pill" title="Shortcut: Esc clears the search">
        <kbd>Esc</kbd> Clear
      </div>
    </div>
  </header>

  <div class="library-controls" aria-label="Search and lecture jump">
    <div class="controls-row controls-row--primary">
      <div class="searchbox" role="search">
        <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
        <input id="demoSearch" type="text" placeholder="Search (Convolution, DFT, Transform…)" autocomplete="off">
        <button id="clearSearch" class="icon-btn" type="button" aria-label="Clear search">
          <i class="fa-solid fa-xmark" aria-hidden="true"></i>
          <span class="sr-only">Clear</span>
        </button>
      </div>

      <div class="results" aria-live="polite">
        <span class="results-label">Showing</span>
        <span class="results-strong" id="activeFilterLabel">All lectures</span>
        <span class="results-count" id="resultsCount">0 demos</span>
      </div>
    </div>

    <div class="controls-row controls-row--secondary" aria-label="Lecture jump pills">
      <div class="lecture-pills" id="lecturePills" role="list" aria-label="Click a lecture to jump">
        <button class="lecture-pill is-active" type="button" data-lecture="__all" data-lecture-label="All lectures">
          All <span class="pill-count" id="allLectureCount">0</span>
        </button>

        {% for lecture, sections in demos.items() %}
          {% set lecture_key = lecture | replace(' ', '-') | lower %}
          {% set ns = namespace(total=0) %}
          {% for section, demo_list in sections.items() %}
            {% if demo_list %}{% set ns.total = ns.total + (demo_list | length) %}{% endif %}
          {% endfor %}
          <button class="lecture-pill" type="button" data-lecture="{{ lecture_key }}" data-lecture-label="{{ lecture }}">
            <span class="pill-dot" aria-hidden="true"></span>
            {{ lecture }} <span class="pill-count">{{ ns.total }}</span>
          </button>
        {% endfor %}
      </div>
    </div>
  </div>

  <div id="resultsEmpty" class="empty-state" role="status" aria-live="polite">
    <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
    No demos match your search. Try a shorter keyword (e.g., "Convolution", "DFT" or "Transform”).
  </div>

  <!-- RESULTS -->
  <main class="library-main" aria-label="Demo results">
    <div class="lecture-groups">
      {% for lecture, sections in demos.items() %}
        {% set lecture_key = lecture | replace(' ', '-') | lower %}
        {% set ns = namespace(total=0) %}
        {% for section, demo_list in sections.items() %}
          {% if demo_list %}{% set ns.total = ns.total + (demo_list | length) %}{% endif %}
        {% endfor %}

        <section class="lecture-group" id="{{ lecture_key }}" data-lecture="{{ lecture_key }}">
          <header class="lecture-head">
            <h2>
              <span class="lecture-accent" aria-hidden="true"></span>
              {{ lecture }}
            </h2>
            <span class="lecture-count">{{ ns.total }} demos</span>
          </header>

          {% for section, demo_list in sections.items() %}
            {% if demo_list %}
              <div class="section-block" data-section="{{ section | replace(' ', '-') | lower }}">
                <div class="section-head">
                  <h3>{{ section }}</h3>
                  <span class="section-count">{{ demo_list | length }}</span>
                </div>

                <div class="demo-grid" aria-label="{{ lecture }} — {{ section }}">
                  {% set swap_titles = section == 'Lecture' %}
                  {% for d in demo_list %}
                    <article class="demo-card"
                      data-lecture="{{ lecture_key }}"
                      data-demo-search="{{ (lecture ~ ' ' ~ section ~ ' ' ~ d.title ~ ' ' ~ d.title_desc) | lower }}">
                      <div class="demo-main">
                        <div class="demo-icon" aria-hidden="true">
                          <i class="fa-solid fa-square-root-variable"></i>
                        </div>
                        <div class="demo-text">
                          <div class="demo-tags">
                            <span class="tag">{{ section }}</span>
                          </div>

                          <h4 class="demo-title">
                            {% if swap_titles %}
                              {{ d.title_desc }}
                            {% else %}
                              {{ d.title }}
                            {% endif %}
                          </h4>

                          <p class="demo-desc">
                            {% if swap_titles %}
                              {{ d.title }}
                            {% else %}
                              {{ d.title_desc }}
                            {% endif %}
                          </p>
                        </div>
                      </div>

                      <a class="demo-launch" href="{{ url_for(d.endpoint) }}">
                        Launch <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
                      </a>
                    </article>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </section>
      {% endfor %}
    </div>
  </main>
</div>

<script>
(() => {
  const root = document.querySelector('.demo-library');
  if (!root) return;

  const search = document.getElementById('demoSearch');
  const clearBtn = document.getElementById('clearSearch');

  const resultsCountEl = document.getElementById('resultsCount');
  const activeFilterLabel = document.getElementById('activeFilterLabel');
  const emptyState = document.getElementById('resultsEmpty');

  const lectureButtons = Array.from(document.querySelectorAll('.lecture-pill[data-lecture]'));
  const cards = Array.from(document.querySelectorAll('.demo-card[data-demo-search]'));
  const sectionBlocks = Array.from(document.querySelectorAll('.section-block'));
  const lectureGroups = Array.from(document.querySelectorAll('.lecture-group'));

  const allCountEl = document.getElementById('allLectureCount');
  const totalAll = cards.length;
  if (allCountEl) allCountEl.textContent = totalAll;

  let activeLecture = '__all';
  const norm = (s) => (s || '').toLowerCase().trim();

  const palette = [
    "#0B5ED7", // blue
    "#0284C7", // sky
    "#06B6D4", // cyan
    "#14B8A6", // teal
    "#10B981", // emerald
    "#2563EB", // blue
    "#4F46E5", // indigo
    "#7C3AED"  // purple
  ];

  function hashString(str){
    let h = 2166136261;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0);
  }

  function hexToRgba(hex, a){
    const m = (hex || "").replace("#","").match(/^([0-9a-f]{6})$/i);
    if (!m) return `rgba(0,0,0,${a})`;
    const n = parseInt(m[1], 16);
    const r = (n >> 16) & 255;
    const g = (n >> 8) & 255;
    const b = n & 255;
    return `rgba(${r},${g},${b},${a})`;
  }

  lectureGroups.forEach((g) => {
    const key = g.dataset.lecture || "";
    const color = palette[hashString(key) % palette.length];
    g.style.setProperty("--lecture-accent", color);
    g.style.setProperty("--lecture-accent-soft", hexToRgba(color, 0.16));
    g.style.setProperty("--lecture-accent-softer", hexToRgba(color, 0.10));
  });

  lectureButtons.forEach((btn) => {
    const key = btn.dataset.lecture || "";
    if (key === "__all") return;
    const color = palette[hashString(key) % palette.length];
    btn.style.setProperty("--pill-accent", color);
    btn.style.setProperty("--pill-accent-soft", hexToRgba(color, 0.14));
  });

  function jumpTo(lectureKey) {
    if (!lectureKey || lectureKey === "__all") return;
    const target = document.getElementById(lectureKey);
    if (!target) return;
    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function setActiveLecture(key, doJump=false) {
    activeLecture = key;
    lectureButtons.forEach(b => b.classList.toggle('is-active', b.dataset.lecture === key));

    const label = (key === '__all')
      ? 'All lectures'
      : (lectureButtons.find(b => b.dataset.lecture === key)?.dataset.lectureLabel || 'Filtered');

    activeFilterLabel.textContent = label || 'Filtered';
    applyFilters();

    if (doJump) jumpTo(key);
  }

  function applyFilters() {
    const q = norm(search.value);
    let visible = 0;

    for (const card of cards) {
      const lectureKey = card.dataset.lecture;
      const hay = card.dataset.demoSearch;

      const okLecture = (activeLecture === '__all') || (lectureKey === activeLecture);
      const okQuery = !q || hay.includes(q);

      const show = okLecture && okQuery;
      card.classList.toggle('is-hidden', !show);
      if (show) visible += 1;
    }

    for (const sec of sectionBlocks) {
      const anyVisible = sec.querySelector('.demo-card:not(.is-hidden)');
      sec.classList.toggle('is-hidden', !anyVisible);
    }

    for (const lec of lectureGroups) {
      const anySection = lec.querySelector('.section-block:not(.is-hidden)');
      lec.classList.toggle('is-hidden', !anySection);
    }

    resultsCountEl.textContent = `${visible} demo${visible === 1 ? '' : 's'}`;
    emptyState.classList.toggle('is-visible', visible === 0);
  }

  // Events
  search.addEventListener('input', applyFilters);
  clearBtn.addEventListener('click', () => { search.value = ''; search.focus(); applyFilters(); });

  lectureButtons.forEach(btn => btn.addEventListener('click', () => {
    const key = btn.dataset.lecture;
    setActiveLecture(key, key !== "__all");
  }));

  document.addEventListener('keydown', (e) => {
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
    const typing = (tag === 'input' || tag === 'textarea' || e.target?.isContentEditable);

    if (!typing && e.key === '/') {
      e.preventDefault();
      search.focus();
    }
    if (e.key === 'Escape') {
      if (document.activeElement === search || norm(search.value)) {
        search.value = '';
        search.blur();
        applyFilters();
      }
    }
  });

  applyFilters();
})();
</script>

{% endblock %}
