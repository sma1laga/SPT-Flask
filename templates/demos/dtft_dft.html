{% extends "base.html" %}
{% block content %}
<h1>DTFT & DFT: Discrete Cosine</h1>
<p>
  This demo shows the Discrete-Time Fourier Transformation&nbsp;(DTFT) \(X(\mathrm{e}^{\mathrm{j}\Omega})\) as well as the Discrete Fourier Transformation&nbsp;(DFT) \(X[\mu]\) of a cosine signal \(x[k]=\cos(\omega k)\) with the adjustable frequency \(\omega\in[0,\pi]\) and DFT-length \(M\in[2,1024]\).
</p>
<form action="javascript:void(0)" style="display:flex;gap:18px;flex-wrap:wrap;margin-bottom:1rem;margin-top:12px;">
  <div style="display:flex;align-items:center;gap:10px;width:60%;">
    <label for="freq">Frequency \(\omega / \pi\)</label>
    <input type="range" id="freq" min="{{ ui.min_freq }}" max="{{ ui.max_freq }}"
           step="{{ ui.step }}" value="{{ ui.value }}"
           oninput="readout.textContent=Number(this.value).toFixed(2); scheduleRedraw();" style="width:360px;">
    <span id="readout">{{ '%.2f'|format(ui.value) }}</span>
  </div>
  <div style="display:flex;align-items:center;gap:10px;width:30%;">
    <label for="mSel">DFT-Length \(M\)</label>
    <input id="mSel" list="mOptions" type="number" value="{{ ui.m }}" oninput="scheduleRedraw();" style="width:110px;">
    <datalist id="mOptions"><!-- TODO drop-down not working -->
      {% for opt in ui.m_options %}
        <option value="{{ opt }}">{{ opt }}</option>
        {% endfor %}
    </datalist>
  </div>

  <button type="button" onclick="redrawNow()" class="btn">Recompute</button>
</form>

<div>
  <img id="plotImg" src="{{ ui.img_url }}" alt="DTFT/DFT Demo" style="display:block;max-width:100%;height:auto;">
</div>

<script>
  const imgEl = document.getElementById('plotImg');
  const freqEl = document.getElementById('freq');
  const mEl    = document.getElementById('mSel');
  const readout= document.getElementById('readout');

  let pending=null, raf=null;
  function scheduleRedraw(){
    if(pending) clearTimeout(pending);
    pending = setTimeout(()=> {
      if(raf) cancelAnimationFrame(raf);
      raf = requestAnimationFrame(redrawNow);
      pending=null;
    }, 80);
  }

  function clamp(v, lo, hi){ v = Number(v); if(isNaN(v)) v=0; return Math.max(lo, Math.min(hi, v)); }

  function redrawNow(){
    const f = clamp(freqEl.value, {{ ui.min_freq }}, {{ ui.max_freq }});
    const m = Math.max(2, parseInt(mEl.value||"16", 10));
    const url = new URL("{{ url_for('dtft_dft.image') }}", window.location.origin);
    url.searchParams.set("freq", f.toString());
    url.searchParams.set("m", m.toString());
    url.searchParams.set("_", Date.now().toString()); // cache-bust while scrubbing
    imgEl.src = url.toString();
  }
</script>
{% endblock %}
