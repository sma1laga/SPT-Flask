{% extends "base.html" %}
{% block title %}IIR Echo Demo{% endblock %}
{% block content %}

<h1 style="text-align:center;margin-bottom:18px;">IIR Echo Demo</h1>
<p style="max-width:960px;margin:0 auto 18px auto;text-align:center;">
  This demo shows the convolution of an input signal \(x[k]\) (audio) with an Infinite Impulse Response&nbsp;(IIR) filter
  $$h[k] = \sum_{i=0}^{\infty}a^{i}\delta[k-i\cdot K]=a^{\frac k K}\varepsilon\left[\frac k K\right],\quad H(z)=\frac{1}{1-az^{-K}}.$$
  The resulting output signal is calculated as \(y[k] = \sum_{i=0}^{\infty}a^{i}x[k-i\cdot K]\).
  Adjust the delay \(K\) and attenuation \(a\) of the echo and plot the input \(x[k]\), impulse response \(h[k]\), and output \(y[k]\).
</p>

<div class="demo">
  <div class="row" style="max-width:1200px;margin:0 auto;">
    <div class="card" style="flex:1;min-width:280px;">
      <label>Input signal \(x[k]\)</label>
      <select id="x_type" style="width:100%;">
        {% for name in audio_choices %}
          <option value="{{name}}" {% if name==defaults.x_type %}selected{% endif %}>{{name}}</option>
        {% endfor %}
      </select>

      <label style="display:block;margin-top:8px;">Delay \(K\) [s]: <span id="delay_val">{{defaults.delay}}</span></label>
      <input id="delay" type="range" min="0.05" max="1.5" step="0.05" value="{{defaults.delay}}">

      <label style="display:block;margin-top:8px;">Attenuation \(a\): <span id="a_val">{{defaults.a}}</span></label>
      <input id="a" type="range" min="0" max="1" step="0.05" value="{{defaults.a}}">

      <button id="run" style="margin-top:12px">Recompute</button>

      <div style="margin-top:12px">
        <div>Input:</div>
        <audio id="x_audio" controls preload="metadata" playsinline style="width:100%;"></audio>
        <div>Output:</div>
        <audio id="y_audio" controls preload="metadata" playsinline style="width:100%;"></audio>
      </div>
    </div>

    <div class="card" style="flex:2;min-width:400px;">
      <div id="plot" style="width:100%;height:720px;"></div>
    </div>
  </div>

  <div class="card" style="width:100%;margin:24px auto;">
    <h3>Audio Files</h3>
    <ul>
      <li><a href="https://commons.wikimedia.org/wiki/File:Fur_Elise.ogg">Fur&nbsp;Elise.ogg</a></li>
      <li><a href="https://commons.wikimedia.org/wiki/File:Neil_Armstrong_small_step.wav">Neil Armstrong small step.wav</a></li>
      <li><a href="https://commons.wikimedia.org/wiki/File:Snare_drum_rim.ogg">Snare drum rim.ogg</a></li>
    </ul>
  </div>
</div>
  <script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
  <script>
window.AUDIO_URLS = {{ audio_map|tojson }};
(function(){
  const $ = (id) => document.getElementById(id);

  function quant05(v){
    // 0.05 steps 
    return Math.round(parseFloat(v) * 20) / 20;
  }
  function syncLabels(){
    $("delay_val").textContent = quant05($("delay").value).toFixed(2);
    $("a_val").textContent     = quant05($("a").value).toFixed(2);
  }

  // Figure scaff
  const layoutBase = {
    grid: {rows:3, columns:1, pattern:'independent', roworder:'top to bottom'},
    margin:{l:60,r:20,t:30,b:40},
    showlegend:false,
    hovermode:false,
    xaxis:  {title:{text:'k'}, autorange:false},
    yaxis:  {title:{text:'x[k]'}, autorange:false},
    xaxis2: {title:{text:'k'}, autorange:false},
    yaxis2: {title:{text:'h[k]'}, autorange:false},
    xaxis3: {title:{text:'k'}, autorange:false},
    yaxis3: {title:{text:'y[k]'}, autorange:false},
    shapes: []
  };

  const traces = [
    {name:'x', x:[], y:[], mode:'lines',   type:'scattergl', xaxis:'x',  yaxis:'y', line:{width:10,color:"#1f77b4"}},
    {name:'h stems',   x:[], y:[], mode:'lines', type:'scattergl', xaxis:'x2', yaxis:'y2', hoverinfo:'skip', line:{width:3,color:"#1f77b4"}},
    {name:'h markers', x:[], y:[], mode:'markers', type:'scattergl', xaxis:'x2', yaxis:'y2', marker:{size:10,color:"#1f77b4"}},
    {name:'y', x:[], y:[], mode:'lines',   type:'scattergl', xaxis:'x3', yaxis:'y3', line:{width:10,color:"#1f77b4"}},
  ];
  {# plotly usage, right now set to static plot #}

  Plotly.newPlot("plot", traces, layoutBase, {responsive:true, staticPlot:true});

  let inflight = null;
  let latestSeq = 0;

  async function callUpdate(){
    if (inflight) inflight.abort();
    inflight = new AbortController();
    const seq = ++latestSeq;

    const body = {
      x_type: $("x_type").value,
      delay:  quant05($("delay").value),
      a:      quant05($("a").value),
    };

    try {
      const resp = await fetch("{{ url_for('demos_iir.update') }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body),
        signal: inflight.signal
      });
      if (!resp.ok) return;
      const d = await resp.json();
      if (seq !== latestSeq) return;

    const hx = [], hy = [];
    for (let i = 0; i < (d.h_k?.length || 0); i++) {
    const kx = d.h_k[i], a = d.h_amp[i];
    hx.push(kx, kx, null);
    hy.push(0,  a,  null);
    }

    const data = [
    {name:'x', x:d.k,   y:d.x,   mode:'lines', type:'scattergl', xaxis:'x',  yaxis:'y', line:{width:1,color:"#1f77b4"}},
    {name:'h stems',   x:hx, y:hy, mode:'lines', type:'scattergl', xaxis:'x2', yaxis:'y2', hoverinfo:'skip', line:{width:3,color:"#1f77b4"}},
    {name:'h markers', x:d.h_k, y:d.h_amp, mode:'markers', type:'scattergl', xaxis:'x2', yaxis:'y2', marker:{size:10,color:"#1f77b4"}},
    {name:'y', x:d.k_y, y:d.y,   mode:'lines', type:'scattergl', xaxis:'x3', yaxis:'y3', line:{width:1,color:"#1f77b4"}}
    ];

    const layout = {
    ...layoutBase,
    yaxis:  {...layoutBase.yaxis,  range:d.x_ylim},
    yaxis2: {...layoutBase.yaxis2, range:d.h_ylim},
    yaxis3: {...layoutBase.yaxis3, range:d.y_ylim},
    xaxis:  {...layoutBase.xaxis, range:d.xrange},
    xaxis2: {...layoutBase.xaxis2, range:d.xrange},
    xaxis3: {...layoutBase.xaxis3, range:d.xrange},
    // no shapes
    };

    await Plotly.react("plot", data, layout);

    if (d.y_audio) { const ya = $("y_audio"); ya.src = d.y_audio; ya.load(); }
    } catch(e) {
    }
  }
  (function initInputAudio(){
    const xa = $("x_audio");
    xa.preload = "metadata";
    const src = AUDIO_URLS[$("x_type").value];
    if (src) { xa.src = src; xa.load(); }
  })();

  $("delay").addEventListener("input",  syncLabels);
  $("a").addEventListener("input",      syncLabels);
  
  // update labels & compute while dragging
  ["delay","a"].forEach(id => {
    $(id).addEventListener("input",    syncLabels);
    $(id).addEventListener("input",    callUpdate);
  });

$("x_type").addEventListener("change", () => {
  const xa = $("x_audio");
  xa.preload = "metadata";
  const src = AUDIO_URLS[$("x_type").value];
  if (src && xa.src !== src) { xa.src = src; xa.load(); }

  callUpdate(false);                                
});

  $("run").addEventListener("click",     callUpdate);

  // initial render
  syncLabels();
  callUpdate();
})();
</script>

{% endblock %}
