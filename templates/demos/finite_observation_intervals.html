{% extends "base.html" %}
{% block content %}
<div class="container wide-container">
  <div class="page-header" style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start;">
    <div>
      <h1>Finite Observation intervals</h1>
      <p>
        Recreate the MATLAB time-frequency relation demo: choose a signal (sinusoid, white/coloured noise, or speech),
        adjust the observation length, and compare real measurements against the theoretical autocorrelation and power
        spectral density.
      </p>
    </div>
    <div class="chip-row">
      <div class="pill"><i class="fa fa-sliders"></i>Shifters above the plots</div>
      <div class="pill pill-subtle"><i class="fa fa-signal"></i>Speech-friendly option included</div>
    </div>
  </div>

  <style>
    .wide-container{max-width:1200px}
    .chip-row{display:flex;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#e0f2fe;color:#0f3b64;font-weight:700;font-size:0.9rem}
    .pill-subtle{background:#f3f4f6;color:#4b5563}
    .control-card{background:#fff;border:1px solid #d9dfe7;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 4px 10px rgba(0,0,0,0.05)}
    .control-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .kv-row{display:grid;grid-template-columns:150px 1fr 80px;gap:10px;align-items:center;margin:8px 0}
    .kv-row label{font-weight:700;font-size:0.95rem}
    .kv-row input[type="number"]{width:100%}
    .kv-row small{color:#6b7280}
    .select-row{display:grid;grid-template-columns:200px 1fr;gap:10px;align-items:center;margin:8px 0}
    .select-row label{font-weight:700;font-size:0.95rem}
    .plots-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:12px}
    .plot-box{border:1px solid #e5e7eb;border-radius:10px;padding:6px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.03)}
    .plot-box h4{margin:4px 8px;font-size:0.95rem;color:#111827;display:flex;align-items:center;gap:6px}
    .plot{width:100%;height:260px}
    .btn-primary{background:#2563eb;color:white;border:none;border-radius:8px;padding:9px 12px;font-weight:700;cursor:pointer;box-shadow:0 2px 8px rgba(37,99,235,0.25)}
  </style>

  <div class="control-card">
    <div class="pill" style="margin-bottom:8px"><i class="fa fa-sliders"></i>Controls above plots</div>
    <div class="control-grid">
      <div>
        <div class="kv-row">
          <label for="freq-slider">Sinusoid frequency (Hz)</label>
          <input type="range" id="freq-slider" min="10" max="3500" step="1" value="{{ defaults.frequency }}">
          <input type="number" id="freq-input" min="10" max="3500" step="1" value="{{ defaults.frequency }}">
        </div>
        <div class="kv-row">
          <label for="samples-slider">Observation samples</label>
          <input type="range" id="samples-slider" min="0" max="1" step="0.01">
          <input type="number" id="samples-input" min="200" max="16000" step="100" value="{{ defaults.sample_count }}">
        </div>
        <div class="select-row">
          <label for="signal-select">Signal type</label>
          <select id="signal-select" class="form-control">
            <option value="sinusoid">Sinusoid</option>
            <option value="white_noise">White noise</option>
            <option value="colored_noise">Coloured noise (LP filtered)</option>
            <option value="speech">Speech (static sample)</option>
          </select>
        </div>
        <div class="select-row">
          <label for="mode-select">Observation mode</label>
          <select id="mode-select" class="form-control">
            <option value="real">Real (finite, biased)</option>
            <option value="ideal">Ideal (theoretical)</option>
          </select>
        </div>
        <button id="update-btn" class="btn-primary"><i class="fa fa-refresh"></i> Update plots</button>
      </div>
      <div>
        <p style="color:#4b5563;margin:0 0 6px">The shifters and inputs sit above the plots, mirroring the MATLAB layout.</p>
        <p style="color:#4b5563;margin:0 0 6px">Speech uses the existing 8 kHz sample; in ideal mode it falls back to real measurements to stay meaningful.</p>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:10px">
          <div class="plot-box" style="box-shadow:none;padding:10px">
            <div class="plot-box" style="box-shadow:none;padding:0;border:none">
              <h4 style="margin:0;font-size:0.85rem;color:#6b7280">Frequency</h4>
              <div id="stat-freq" class="stat-value" style="font-weight:800;font-size:1.1rem">—</div>
            </div>
          </div>
          <div class="plot-box" style="box-shadow:none;padding:10px">
            <div class="plot-box" style="box-shadow:none;padding:0;border:none">
              <h4 style="margin:0;font-size:0.85rem;color:#6b7280">Samples</h4>
              <div id="stat-samples" class="stat-value" style="font-weight:800;font-size:1.1rem">—</div>
            </div>
          </div>
          <div class="plot-box" style="box-shadow:none;padding:10px">
            <div class="plot-box" style="box-shadow:none;padding:0;border:none">
              <h4 style="margin:0;font-size:0.85rem;color:#6b7280">Mode</h4>
              <div id="stat-mode" class="stat-value" style="font-weight:800;font-size:1.1rem">—</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="plots-grid">
    <div class="plot-box"><h4><i class="fa fa-wave-square"></i> Signal</h4><div id="plot-signal" class="plot"></div></div>
    <div class="plot-box"><h4><i class="fa fa-random"></i> Normalised autocorrelation</h4><div id="plot-acorr" class="plot"></div></div>
    <div class="plot-box"><h4><i class="fa fa-line-chart"></i> Power spectral density</h4><div id="plot-psd" class="plot"></div></div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
  const defaults = {{ defaults | tojson }};
  const computeUrl = "{{ url_for('demos_finite_observation_intervals.compute') }}";
  const freqSlider = document.getElementById('freq-slider');
  const freqInput = document.getElementById('freq-input');
  const samplesSlider = document.getElementById('samples-slider');
  const samplesInput = document.getElementById('samples-input');
  const signalSelect = document.getElementById('signal-select');
  const modeSelect = document.getElementById('mode-select');
  const updateBtn = document.getElementById('update-btn');

  const statEls = {
    freq: document.getElementById('stat-freq'),
    samples: document.getElementById('stat-samples'),
    mode: document.getElementById('stat-mode'),
  };

  const SAMPLE_MIN = 200;
  const SAMPLE_MAX = 16000;

  function sliderToSamples(v){
    const logMin = Math.log10(SAMPLE_MIN);
    const logMax = Math.log10(SAMPLE_MAX);
    const val = Math.pow(10, logMin + v * (logMax - logMin));
    return Math.round(val);
  }

  function samplesToSlider(count){
    const clamped = Math.min(Math.max(count, SAMPLE_MIN), SAMPLE_MAX);
    const logMin = Math.log10(SAMPLE_MIN);
    const logMax = Math.log10(SAMPLE_MAX);
    return (Math.log10(clamped) - logMin) / (logMax - logMin);
  }

  function syncSamplesFromSlider(){
    const samples = sliderToSamples(parseFloat(samplesSlider.value));
    samplesInput.value = samples;
  }

  function syncSamplesFromInput(){
    const samples = parseInt(samplesInput.value || defaults.sample_count, 10);
    samplesSlider.value = samplesToSlider(samples);
  }

  function syncFreqFromSlider(){
    freqInput.value = parseFloat(freqSlider.value);
  }

  function syncFreqFromInput(){
    freqSlider.value = freqInput.value;
  }

  async function fetchData(){
    const payload = {
      frequency: parseFloat(freqInput.value),
      sample_count: parseInt(samplesInput.value, 10) || defaults.sample_count,
      signal_kind: signalSelect.value,
      mode: modeSelect.value,
    };

    const response = await fetch(computeUrl, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    if(!response.ok){
      throw new Error('Server error: ' + response.status);
    }
    return response.json();
  }

  function renderLine(target, x, y, xLabel, yLabel, color='#2563eb'){
    const trace = {x, y, mode: 'lines', line: {color, width: 2}};
    const layout = {
      margin:{l:50,r:10,b:45,t:10},
      xaxis:{title:xLabel},
      yaxis:{title:yLabel},
      height:260
    };
    Plotly.newPlot(target, [trace], layout, {displaylogo:false, responsive:true});
  }

  function renderPsd(target, x, y){
    const trace = {x, y, mode:'lines', line:{color:'#dc2626', width:2}};
    const layout = {
      margin:{l:50,r:10,b:45,t:10},
      xaxis:{title:'frequency [Hz]'},
      yaxis:{title:'10log_{10}(S_{xx})'},
      height:260
    };
    Plotly.newPlot(target, [trace], layout, {displaylogo:false, responsive:true});
  }

  function render(data){
    renderLine('plot-signal', data.time_ms, data.signal, 't [ms]', 'Amplitude');
    renderLine('plot-acorr', data.acorr.lags, data.acorr.values, 'Time lag τ [#samples]', 'R_{xx}', '#0f766e');
    renderPsd('plot-psd', data.psd.freqs, data.psd.values_db);

    statEls.freq.textContent = `${data.meta.frequency.toFixed(0)} Hz`;
    statEls.samples.textContent = `${data.meta.sample_count}`;
    statEls.mode.textContent = data.meta.mode === 'ideal' ? 'Ideal (theoretical)' : 'Real (finite)';
  }

  async function update(){
    syncFreqFromInput();
    syncSamplesFromInput();
    const data = await fetchData();
    render(data);
  }

  freqSlider.addEventListener('input', syncFreqFromSlider);
  freqInput.addEventListener('change', syncFreqFromInput);
  samplesSlider.addEventListener('input', syncSamplesFromSlider);
  samplesInput.addEventListener('change', syncSamplesFromInput);
  updateBtn.addEventListener('click', update);

  samplesSlider.value = samplesToSlider(parseInt(samplesInput.value, 10));
  update();
</script>
{% endblock %}