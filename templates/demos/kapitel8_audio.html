{% extends "base.html" %}
{% block content %}
<h1>Chapter 8: Low-Pass</h1>
<p>
  This demo shows the filtering of an input signal \(x[k]\) with a discrete low-pass filter of the form:
  $$h_\mathrm{LP}[k] = \begin{cases}
  \frac{\Omega_\mathrm g}{\pi}\cdot\mathrm{si}[(k-k_0)\Omega_\mathrm g] & 0\leq k\leq L-1\\
  0 & \mathrm{otherwise}
  \end{cases},$$
  with the cut-off frequency \(\Omega_\mathrm g\in[0,\pi]\), length \(L\), and shift \(k_0=\left\lfloor\frac{L}{2}\right\rfloor\).
</p>
<p>
  For smoothing the overshoot, a Hann-window (raised cosine) of length \(L\) can be used, which is defined as:
  $$\begin{align}
  w_\mathrm{Hann}[k] &= \frac{1}{2}\left[1-\cos\left(\frac{2\pi}{L-1}k\right)\right] \\
  &= \sin^2\left(\frac{\pi}{L-1}k\right),
  \end{align}$$
  for \(k=\{0,\dots,L-1\}\). The resulting low-pass signal is denoted as \(x_\mathrm{LP}[k]=x[k]\ast (h_\mathrm{LP}[k]\cdot w[k])\).
</p>

<style>
  .row{display:flex;gap:24px;align-items:flex-start;flex-wrap:wrap}
  .card{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;box-shadow:0 1px 5px rgba(0,0,0,.05)}
  label{display:block;margin-top:8px}
  input[type=range]{width:100%}
  img{max-width:100%}
  .radio-group label{display:inline-flex;align-items:center;gap:6px;margin-right:14px;margin-top:6px}
</style>

<div class="row">
  <div style="margin-top:12px" class="card">
    <label>Input \(x[k]\)</label>
    <select id="x_type">
      {% for o in audio_options %}
        <option value="{{o}}" {% if o == defaults.x_type %}selected{% endif %}>{{o}}</option>
      {% endfor %}
    </select>

    <label>Cut-Off Frequency \(\Omega_\mathrm g/\pi\) : <span id="fg_val">{{defaults.fg}}</span></label>
    <input width="100%" id="fg" type="range" min="0" max="1.00" step="0.05" value="{{defaults.fg}}">

    <label style="margin-top:12px;">Length \(L\)</label>
    <div id="L_group" class="radio-group">
      {% for L in L_options %}
        <label><input type="radio" name="L" value="{{L}}" {% if L == defaults.L %}checked{% endif %}> {{L}}</label>
      {% endfor %}
    </div>

    <label style="margin-top:8px;">
      <input id="win" type="checkbox" {% if defaults.win %}checked{% endif %}>
      Windowing (Hann-Window)
    </label>

    <button id="run" style="margin-top:12px">Recompute</button>
  </div>

  <div class="card">
    <img id="plot" alt="plot">
  </div>

  <div class="card">
    <div><strong>Original</strong></div>
    <audio style="width:100%" id="x_audio" controls></audio>
    <div style="height:8px"></div>
    <div><strong>Filtered</strong></div>
    <audio style="width:100%" id="y_audio" controls></audio>
  </div>
</div>
<div class="card">
  <h3>Sources</h3>
  <ul>
    <li>Wikimedia Commons: <a href="https://commons.wikimedia.org/wiki/File:Fur_Elise.ogg">Fur Elise.ogg</a></li>
  </ul>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  function currentL(){
    const r = document.querySelector('input[name="L"]:checked');
    return r ? parseInt(r.value) : {{ defaults.L|int }};
  }
  function syncLabels(){
    $("fg_val").textContent = $("fg").value;
  }

  async function recompute(){
    syncLabels();
    const body = {
      x_type: $("x_type").value,
      fg: parseFloat($("fg").value),
      L: currentL(),
      win: document.getElementById("win").checked
    };
    const resp = await fetch("./compute", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    if(!resp.ok){ alert("Error: " + await resp.text()); return; }
    const data = await resp.json();
    $("plot").src = data.image;
    $("x_audio").src = data.x_audio;
    $("y_audio").src = data.y_audio;
  }

  ["x_type","fg","win"].forEach(id => $(id).addEventListener("input", () => recompute()));
  document.querySelectorAll('input[name="L"]').forEach(r => r.addEventListener("change", () => recompute()));
  $("run").addEventListener("click", () => recompute());
  recompute();
</script>
{% endblock %}
