{% extends "base.html" %}
{% block content %}
<h1>Fourier Transform (L3)</h1>
<p>This demo shows the Fourier&nbsp;transform \(\mathcal{F}\{x(t)\}=X(\mathrm{j}\omega)\) of a signal \(x(t)\), split up into magnitude \(|X(\mathrm{j}\omega)|\) and phase \(\varphi(\mathrm{j}\omega)\). Choose the signal type, shift, width, and amplitude.</p>

<div class="demo row">
  <div class="card">
    <div class="toolbar">
      <div>
        <label for="x_type">\(x(t)\)</label>
        <select id="x_type">
          <option value="rect" {% if defaults.x_type=='rect' %}selected{% endif %}>rect</option>
          <option value="si" {% if defaults.x_type=='si' %}selected{% endif %}>si</option>
          <option value="triangle" {% if defaults.x_type=='triangle' %}selected{% endif %}>triangle</option>
          <option value="si squared" {% if defaults.x_type=='si squared' %}selected{% endif %}>siÂ²</option>
        </select>
      </div>

      <div>
        <label for="x_displacement">Shift</label>
        <input id="x_displacement" type="number"
               step="{{ defaults.step_displacement }}"
               min="{{ defaults.min_displacement }}" max="{{ defaults.max_displacement }}"
               value="{{ defaults.x_displacement }}">
      </div>

      <div>
        <label for="x_width">Width</label>
        <input id="x_width" type="number"
               step="{{ defaults.step_width }}"
               min="{{ defaults.min_width }}" max="{{ defaults.max_width }}"
               value="{{ defaults.x_width }}">
      </div>

      <div>
        <label for="x_height">Amplitude</label>
        <input id="x_height" type="number"
               step="{{ defaults.step_height }}"
               min="{{ defaults.min_height }}" max="{{ defaults.max_height }}"
               value="{{ defaults.x_height }}">
      </div>
    </div>

    <div class="toolbar">
      <button id="run">Update</button>
      <button id="reset" type="button">Reset</button>
    </div>
  </div>

  <div class="card">
    <img id="plot" alt="Fourier transform plots">
  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
  const $ = (id) => document.getElementById(id);
  let debounceTimer = null;
  let controller = null;

  function clampDisplacement(minD, maxD){
    const s = $("x_displacement");
    const v = parseFloat(s.value);
    s.min = minD;
    s.max = maxD;
    if (v < minD) s.value = minD;
    if (v > maxD) s.value = maxD;
  }

  async function recompute(){
    if (controller) controller.abort();
    controller = new AbortController();
    const body = {
      x_type: $("x_type").value,
      x_displacement: parseFloat($("x_displacement").value),
      x_width: parseFloat($("x_width").value),
      x_height: parseFloat($("x_height").value),
    };
    try {
      const resp = await fetch("./compute", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body),
        signal: controller.signal
      });
      if (!resp.ok) {
        alert("Error: " + await resp.text());
        return;
      }
      const data = await resp.json();
      $("plot").src = data.image;
      clampDisplacement(data.min_displacement, data.max_displacement);
    } catch(e){
      if (e.name !== 'AbortError') console.error(e);
    }
  }

  function schedule(){
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(recompute, 150);
  }

  ["x_type","x_displacement","x_width","x_height"].forEach(id => {
    $(id).addEventListener("input", schedule);
    $(id).addEventListener("change", schedule);
    $(id).addEventListener("keyup", (e) => { if (e.key === "Enter") recompute(); });
  });
  $("run").addEventListener("click", recompute);
  $("reset").addEventListener("click", () => {
    $("x_type").value = "{{ defaults.x_type }}";
    $("x_displacement").value = "{{ defaults.x_displacement }}";
    $("x_width").value = "{{ defaults.x_width }}";
    $("x_height").value = "{{ defaults.x_height }}";
    clampDisplacement({{ defaults.min_displacement }}, {{ defaults.max_displacement }});
    recompute();
  });

  window.addEventListener("load", () => recompute());
</script>
{% endblock %}