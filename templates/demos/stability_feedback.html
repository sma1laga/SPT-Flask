{% extends "base.html" %}
{% block content %}
<h1>Stability and Feedback Systems (L&nbsp;10-12)</h1>
<p>
  This demo shows the pole diagrams of a transfer function
  $$ H(s)=\frac{b}{s-a}, $$
  and the transfer function of the feedback system
  $$ Q(s)=\frac{H(s)}{1+K\,H(s)}=\frac{b}{\,s-a+K\,b\,}. $$
  The background indicates a stable system: green for stable, red for unstable.
</p>

<div class="demo row">
  <div class="card">
    <div class="toolbar">
      <div>
        <label for="a">\(a\)</label>
        <input id="a" type="number" step="{{ defaults.step }}"
              min="{{ defaults.min_a }}" max="{{ defaults.max_a }}"
              value="{{ defaults.a }}">
      </div>
      <div>
        <label for="b">\(b\)</label>
        <input id="b" type="number" step="{{ defaults.step }}"
              min="{{ defaults.min_b }}" max="{{ defaults.max_b }}"
              value="{{ defaults.b }}">
      </div>
      <div>
        <label for="K">\(K\)</label>
        <input id="K" type="number" step="{{ defaults.step }}"
              min="{{ defaults.min_K }}" max="{{ defaults.max_K }}"
              value="{{ defaults.K }}">
      </div>
    </div>

    <div class="toolbar">
      <button id="run">Update</button>
      <button id="reset">Reset</button>
    </div>
  </div>

  <div class="card">
    <img id="plot" alt="Pole diagrams of H(s) and Q(s)" decoding="async" loading="eager">
  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
  const DEFAULTS = {{ defaults | tojson }};
  const $ = (id) => document.getElementById(id);

  let inFlight = null;
  let debounceTimer = null;
  let SEQ = 0; 

  function send() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      if (inFlight) inFlight.abort();
      inFlight = new AbortController();

      const mySeq = ++SEQ;  
      const body = {
        a: parseFloat($("a").value),
        b: parseFloat($("b").value),
        K: parseFloat($("K").value),
        seq: mySeq
      };

      try {
        const resp = await fetch("./compute", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(body),
          signal: inFlight.signal
        });
        if (!resp.ok) return;
        const data = await resp.json();

        if (data.seq !== undefined && data.seq < SEQ) return;

        if (data.image) $("plot").src = data.image;
      } catch (e) {
        /* aborted â€“ ignr */
      } finally {
        inFlight = null;
      }
    }, 80); 
  }

  ["a","b","K"].forEach(id => {
    $(id).addEventListener("input", send);
    $(id).addEventListener("change", send);
    $(id).addEventListener("keyup", e => { if (e.key === "Enter") send(); });
  });

  window.addEventListener("load", send);

  $("run").addEventListener("click", send);

  $("reset").addEventListener("click", () => {
    ["a","b","K"].forEach(id => { $(id).value = DEFAULTS[id]; });
    send();
  });
</script>

{% endblock %}
