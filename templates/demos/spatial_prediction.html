{% extends "base.html" %}
{% block content %}
<div class="demo">
  <div class="card control-card">
    <div class="card-title">Spatial Prediction 1</div>
    <p class="control-subtitle">Switch between linear predictors and see how prediction error impacts entropy and compression.</p>
    <div class="mode-buttons">
      {% for key, data in predictions.items() %}
        <button class="mode-button" data-key="{{ key }}">{{ data.label }}</button>
      {% endfor %}
    </div>
  </div>

  <div class="image-row">
    <div class="card image-card">
      <div class="card-title">Original image</div>
      <div class="image-shell">
        <img src="{{ original_src }}" alt="Original Lenna" class="demo-image">
      </div>
      <p class="variant-desc">Grayscale reference ({{ '%.2f'|format(base_entropy) }} bit/pixel entropy).</p>
    </div>
    <div class="card image-card">
      <div class="card-title" id="prediction-label">Prediction error</div>
      <p class="variant-desc" id="prediction-description"></p>
      <div class="image-shell">
        <img id="error-image" src="" alt="Prediction error" class="demo-image">
      </div>
    </div>
  </div>

  <div class="below-row">
    <div class="card weights-card">
      <div class="card-title">Predictor weights</div>
      <p class="variant-desc">Values applied to already-known neighbours (S marks the current pixel).</p>
      <div class="weights-grid">
        {% for row in range(3) %}
          {% for col in range(3) %}
            <div class="mask-cell" data-row="{{ row }}" data-col="{{ col }}">0</div>
          {% endfor %}
        {% endfor %}
      </div>
    </div>

    <div class="card stats-card">
      <div class="card-title">Statistics</div>
      <p class="variant-desc">Entropy reduction and ideal compression ratio per predictor.</p>
      <div class="metric-grid">
        <div>Entropy</div><div id="entropy-value"></div>
        <div>Compression</div><div id="compression-value"></div>
      </div>
    </div>
  </div>
</div>

  <style>
    .demo { display: flex; flex-direction: column; gap: 16px; }
    .demo .card { transition: none; }
    .demo .card:hover { transform: none; box-shadow: var(--demo-card-shadow, 0 12px 26px rgba(15,35,95,0.06)); }
    .card-title { font-weight: 700; color: #0e1a2b; margin-bottom: 6px; }
    body.dark-mode .card-title { color: #eaf2ff; }
    .control-card { margin-bottom: 4px; }
    .control-subtitle, .variant-desc { margin: 0 0 8px 0; color: var(--demo-description-color, #465063); }
    body.dark-mode .control-subtitle, body.dark-mode .variant-desc { color: #c9d5eb; }
    .mode-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
    .mode-button { padding: 10px 14px; border-radius: 10px; border: 1px solid var(--demo-button-color, #0b5ebd); background: var(--demo-button-bg, rgba(11,94,189,0.12)); color: var(--demo-button-color, #0b5ebd); font-weight: 600; cursor: pointer; }
    .mode-button.active { background: var(--demo-button-hover-bg, rgba(11,94,189,0.2)); color: var(--demo-button-hover-color, #073b75); }
    body.dark-mode .mode-button { border-color: rgba(158,203,255,0.55); background: rgba(158,203,255,0.08); color: #d7e8ff; }
    body.dark-mode .mode-button.active { background: rgba(158,203,255,0.14); color: #eaf2ff; }
    .image-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; }
    .below-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; align-items: start; }
    .image-shell { display: flex; justify-content: center; align-items: center; padding: 12px; }
    .demo-image { width: 100%; max-width: 520px; border-radius: 12px; border: 1px solid var(--demo-card-border, rgba(13,53,109,0.1)); box-shadow: var(--demo-card-shadow, 0 12px 26px rgba(15,35,95,0.06)); object-fit: contain; }
    body.dark-mode .demo-image { border-color: rgba(158,203,255,0.18); box-shadow: 0 10px 28px rgba(0,0,0,0.35); }
    .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 6px 10px; font-size: 0.95rem; }
    .metric-grid div:nth-child(odd) { color: var(--demo-description-color, #465063); }
    body.dark-mode .metric-grid div:nth-child(odd) { color: #c6d4ea; }
    .weights-card { max-width: 480px; }
    .weights-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap: 6px; width: 240px; }
    .mask-cell { border: 1px solid var(--demo-card-border, rgba(13,53,109,0.16)); border-radius: 8px; padding: 12px; display: flex; justify-content: center; align-items: center; font-weight: 700; color: #0e1a2b; background: #f7f9fc; }
    .mask-cell.is-source { background: rgba(11,94,189,0.12); color: #0b3d78; border-color: rgba(11,94,189,0.35); }
    body.dark-mode .mask-cell { color: #e8f1ff; background: rgba(28, 40, 65, 0.7); border-color: rgba(158,203,255,0.3); }
    body.dark-mode .mask-cell.is-source { background: rgba(93,171,255,0.26); color: #0a1323; border-color: rgba(158,203,255,0.6); }
  </style>

<script>
  const predictions = {{ predictions | tojson }};

  function setPrediction(key) {
    const data = predictions[key];
    if (!data) return;

    document.getElementById('prediction-label').textContent = `Prediction error â€“ ${data.label}`;
    document.getElementById('prediction-description').textContent = data.description;
    document.getElementById('error-image').src = data.error_src;
    document.getElementById('entropy-value').textContent = `${data.entropy.toFixed(2)} bit/pixel`;
    document.getElementById('compression-value').textContent = `${data.compression_factor.toFixed(2)}`;

    document.querySelectorAll('.mask-cell').forEach((cell) => {
      const row = Number(cell.dataset.row);
      const col = Number(cell.dataset.col);
      const value = data.weights_grid[row][col];
      cell.textContent = value;
      cell.classList.toggle('is-source', value === 'S');
    });

    document.querySelectorAll('.mode-button').forEach((btn) => {
      btn.classList.toggle('active', btn.dataset.key === key);
    });
  }

  document.querySelectorAll('.mode-button').forEach((btn) => {
    btn.addEventListener('click', () => setPrediction(btn.dataset.key));
  });

  const defaultKey = Object.keys(predictions)[0];
  setPrediction(defaultKey);
</script>
{% endblock %}