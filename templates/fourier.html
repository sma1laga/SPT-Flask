{% extends "base.html" %}
{% block content %}
<div class="page-header" style="margin-bottom:30px; text-align:center;">
  <h1 style="font-size:2.5em;">Fourier Transform Visualizer</h1>
  <p style="font-size:1.1em;color:var(--subtext-color); max-width:600px; margin:0 auto;">
    Enter a time function, shift the phase, and visualize the result interactively.
    $$ X(\mathrm{j}\omega)=\mathcal{F}\{x(t)\}=\int_{-\infty}^{\infty} x(t)\,e^{-\mathrm{j}\omega t}\,dt $$
  </p>
  <a href="{{ url_for('static', filename='docs/continuous_fourier.pdf') }}" target="_blank" class="subtle-btn">Fourier Correspondence Table</a>
</div>

<p id="errorMsg" style="max-width:700px;margin:0 auto 16px auto;color:#d00;text-align:center;font-weight:bold;"></p>

<form id="fourierForm" style="max-width:700px; margin:0 auto; text-align:center;">
  <div class="function-group" style="margin-bottom:20px;">
    <label style="font-weight:bold;">Function:</label>
    <input type="text" id="func" placeholder="e.g., sin(pi*t) + 3*rect(t)" onfocus="setActiveField(this)">
    <div class="quick-buttons functions" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:15px;">
      <button type="button" onclick="insertOperand('rect(t)')">\(\mathrm{rect}\)</button>
      <button type="button" onclick="insertOperand('tri(t)')">\(\mathrm{tri}\)</button>
      <button type="button" onclick="insertOperand('sin(pi*t)')">\(\mathrm{sin}\)</button>
      <button type="button" onclick="insertOperand('cos(pi*t)')">\(\mathrm{cos}\)</button>
      <button type="button" onclick="insertOperand('step(t)')">\(\mathrm{step}\)</button>
      <button type="button" onclick="insertOperand('delta(t)')">\(\delta\)</button>
      <button type="button" onclick="insertOperand('sign(t)')">\(\mathrm{sign}\)</button>
      <button type="button" onclick="insertOperand('inv_t(t)')">\(\frac{1}{t}\)</button>
      <button type="button" onclick="insertOperand('si(pi*t)')">\(\mathrm{si}\)</button>
      <button type="button" onclick="insertOperand('si(pi*t)**2')">\(\mathrm{si}^2\)</button>
      <button type="button" onclick="insertOperand('exp_iwt(t)')">\(\mathrm{e}^{\mathrm{j}\omega t}\)</button>
      <button type="button" onclick="insertOperand('exp(t)')">\(\mathrm{e}^t\)</button>
    </div>
    <div class="quick-buttons operators" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:10px;">
      <button type="button" onclick="insertOperand('+')">\(+\)</button>
      <button type="button" onclick="insertOperand('-')">\(-\)</button>
      <button type="button" onclick="insertOperand('*')">\(\cdot\)</button>
      <button type="button" onclick="insertOperand('/')">\(/\)</button>
    </div>
  </div>

  <div class="options-group" style="display:flex; gap:20px; justify-content:center; margin-bottom:30px;">
    <div>
      <label style="font-weight:bold;">Global complex phase (°):</label>
      <input type="number" id="phase" value="0">
    </div>
  </div>

  <div style="margin-bottom:30px;">
    <button type="button" id="computeBtn" class="action-btn">Compute</button>
    <button type="button" id="clearBtn" class="action-btn">Clear</button>
  </div>
</form>

<div id="plotly-container" style="max-width:1200px; margin:0 auto;">
  <div id="timePlot" style="height:220px;"></div>
  <div id="magPlot" style="height:250px;"></div>
  <div id="phasePlot" style="height:250px; margin-top:-20px;"></div>
</div>

<p id="fourier_transformation_label" style="text-align:center; margin-top:20px; font-weight:bold;"></p>

<script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/fft.js') }}"></script>
<script src="{{ url_for('static', filename='js/fourier_compute.js') }}"></script>
<script>
let activeField = document.getElementById("func");
function setActiveField(f){ activeField = f; }
document.getElementById("func").addEventListener("focus", e=>activeField=e.target);

const errorMsg = document.getElementById("errorMsg");
const funcInput = document.getElementById("func");

function clearErrors(){
  funcInput.classList.remove('input-error');
  if(errorMsg) errorMsg.textContent = "";
}

function insertOperand(op) {
  if (!activeField) {
    alert("Klicke zuerst in das Textfeld!");
    return;
  }
  const start = activeField.selectionStart;
  const end   = activeField.selectionEnd;
  const val   = activeField.value;

  activeField.value =
    val.slice(0, start) +
    op +
    val.slice(end);

  activeField.selectionStart = activeField.selectionEnd = start + op.length;
  activeField.focus();
}

function getValues(){
  return {
    func: document.getElementById("func").value,
    phase: document.getElementById("phase").value
  };
}

const omegaLimit = 5 * Math.PI;

const omegaTicks = [];
const omegaTickText = [];
for(let k=-5; k<=5; k++){
  omegaTicks.push(k * Math.PI);
  if(k === 0) omegaTickText.push("0");
  else if(k === 1) omegaTickText.push("π");
  else if(k === -1) omegaTickText.push("-π");
  else omegaTickText.push(`${k}π`);
}

const baseLayout = {
  template: "plotly_white",
  margin: {t: 40, r: 24, l: 60, b: 50},
  xaxis: {
    title: {text: "ω"},
    range: [-omegaLimit, omegaLimit],
    tickvals: omegaTicks,
    ticktext: omegaTickText,
    zeroline: false,
    gridcolor: "rgba(0,0,0,0.12)",
  },
  yaxis: {
    gridcolor: "rgba(0,0,0,0.12)",
    zeroline: false,
  },
};

const plotConfig = {displayModeBar: false, responsive: true};

function renderPlot(target, data, layout) {
  const el = document.getElementById(target);
  if (el && el.data) {
    Plotly.react(el, data, layout, plotConfig);
  } else {
    Plotly.newPlot(target, data, layout, plotConfig);
  }
}

let lastFunc = null;
let omegaIdx = null;
let omegaPlotX = null;
let magPlotY = null;

function rebuildOmegaCache(data){
  const omega = data.omega;
  const idx = [];
  const x = [];
  const mag = [];
  for(let i=0;i<omega.length;i++){
    if(Math.abs(omega[i]) <= omegaLimit){
      idx.push(i);
      x.push(omega[i]);
      mag.push(data.magnitude[i]);
    }
  }
  omegaIdx = idx;
  omegaPlotX = x;
  magPlotY = mag;
}

function buildPhaseSubset(fullPhase){
  const out = new Array(omegaIdx.length);
  for(let k=0;k<omegaIdx.length;k++){
    out[k] = fullPhase[omegaIdx[k]];
  }
  return out;
}

function updatePlots(){
  clearErrors();

  const vals = getValues();
  const func = (vals.func || "").trim();
  const phase = parseFloat(vals.phase);

  if(!func){
    if(errorMsg) errorMsg.textContent = "Please enter a function.";
    funcInput.classList.add('input-error');
    return;
  }

  const data = compute_fourier(func, phase);
  if(data.error){
    if(errorMsg) errorMsg.textContent = data.error;
    funcInput.classList.add('input-error');
    console.error(data.error);
    return;
  }

  const timeEl = document.getElementById("timePlot");
  const plotsExist = !!(timeEl && timeEl.data);
  const funcChanged = (!plotsExist) || (func !== lastFunc);

  if (funcChanged) {
    lastFunc = func;
    rebuildOmegaCache(data);

    const phasePlotY = buildPhaseSubset(data.phase);

    renderPlot("timePlot", [
      {x: data.t, y: data.y_real, type: "scatter", mode: "lines", name: "Re", line: { color: "#1f77b4", width: 2 }},
      {x: data.t, y: data.y_imag, type: "scatter", mode: "lines", name: "Im", line: { dash: "dot", color: "#6c757d" }}
    ], {
      template: "plotly_white",
      margin: {t: 40, r: 24, l: 60, b: 50},
      xaxis: {title: {text: "t"}, autorange: "reversed", gridcolor: "rgba(0,0,0,0.12)", zeroline: false},
      yaxis: {title: {text: "x(t)"}, gridcolor: "rgba(0,0,0,0.12)", zeroline: false},
      title: {text: "Time signal"},
    });

    renderPlot("magPlot", [
      {x: omegaPlotX, y: magPlotY, type: "scatter", mode: "lines", name: "|X|", line: { color: "#1f77b4", width: 2 }}
    ], {
      ...baseLayout,
      showlegend: false,
      title: {text: "Magnitude"},
      yaxis: {...baseLayout.yaxis, title: {text: "|X(jω)|"}, range: [0, 1.15]}
    });

    renderPlot("phasePlot", [
      {x: omegaPlotX, y: phasePlotY, type: "scatter", mode: "lines", name: "Phase", line: { color: "#2ca02c", width: 2 }}
    ], {
      ...baseLayout,
      showlegend: false,
      title: {text: "Phase"},
      yaxis: {
        ...baseLayout.yaxis,
        title: {text: "φ(jω)"},
        range: [-Math.PI, Math.PI],
        tickvals: [-Math.PI, -Math.PI/2, 0, Math.PI/2, Math.PI],
        ticktext: ["-π", "-π/2", "0", "π/2", "π"],
      },
    });
  } else {
    const phasePlotY = buildPhaseSubset(data.phase);

    Plotly.restyle("timePlot", {y: [data.y_real, data.y_imag]}, [0, 1]);
    Plotly.restyle("phasePlot", {y: [phasePlotY]}, [0]);
  }

  const label = document.getElementById("fourier_transformation_label");
  label.textContent = data.transformation_label;
}
document.getElementById("computeBtn").addEventListener("click", updatePlots);
const fourierForm = document.getElementById("fourierForm");
if (fourierForm) {
  fourierForm.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      updatePlots();
    }
  });
}
let phaseUpdateTimer;
document.getElementById("phase").addEventListener("input", () => {
  window.clearTimeout(phaseUpdateTimer);
  phaseUpdateTimer = window.setTimeout(updatePlots, 120);
});
document.getElementById("clearBtn").addEventListener("click", ()=>{
  document.getElementById("func").value="";
  document.getElementById("phase").value=0;
  Plotly.purge("timePlot"); Plotly.purge("magPlot"); Plotly.purge("phasePlot");
  document.getElementById("fourier_transformation_label").innerHTML="";
  clearErrors();

});
</script>

<style>
  .subtle-btn {
    display:inline-block;
    margin-top:10px;
    padding:6px 12px;
    font-size:0.9em;
    border-radius:4px;
    border:1px solid var(--primary-color);
    color:var(--primary-color);
    background-color:rgba(0,122,204,0.08);
    text-decoration:none;
    transition:background-color 0.2s ease,color 0.2s ease;
  }
  .subtle-btn:hover {
    background-color:var(--primary-color);
    color:#fff;
  }
  /* Quick-Buttons (Functions & Operators) – moderat vergrößert */
  .quick-buttons.functions button,
  .quick-buttons.operators button {
    padding: 12px 18px;       /* moderater Innenabstand */
    font-size: 1.1em;         /* leicht größere Schrift */
    min-width: 80px;          /* Mindestbreite */
    border-radius: 5px;
    background-color: var(--primary-color);
    color: #fff;
    border: none;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  .quick-buttons.functions button:hover,
  .quick-buttons.operators button:hover {
    background-color: var(--primary-color-darker);
  }

  /* Action-Buttons (Compute / Clear) – moderat vergrößert */
  .action-btn {
    padding: 12px 28px;       /* moderater Innenabstand */
    font-size: 1.1em;         /* leicht größere Schrift */
    border-radius: 5px;
    border: none;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  #computeBtn {
    background-color: var(--lms-green-darker);
    color: #fff;
    margin-right: 8px;
  }
  #computeBtn:hover {
    background-color: var(--lms-green-dark);
  }
  #clearBtn {
    background-color: var(--lms-red);
    color: #fff;
  }
  #clearBtn:hover {
    background-color: var(--lms-red-darker);
  }
  input.input-error{
    border-color: var(--lms-red);
  }

</style>

{% endblock %}
