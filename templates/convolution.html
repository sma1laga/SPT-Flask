{% extends "base.html" %}
{% block content %}
<div class="page-header" style="margin-bottom:30px; text-align:center;">
  <h1 style="font-size:2.5em;">Convolution Calculator</h1>
  <p style="font-size:1.1em; color:var(--subtext-color); max-width:600px; margin:0 auto;">
    Enter \(x(t)\) and \(h(t)\) to compute their convolution
    $$ y(t)=\int_{-\infty}^{\infty} x(\tau)h(t-\tau)\mathrm d\tau $$
  </p>
</div>

<p id="errorMsg" style="max-width:700px;margin:0 auto 16px auto;color:#d00;text-align:center;font-weight:bold;"></p>

<form id="convForm" style="max-width:800px; margin:0 auto; text-align:center;">
  <!-- Zwei Inputs nebeneinander mit leicht erhöhtem Sternchen -->
  <div class="function-group"
       style="display:flex; justify-content:center; align-items:center; gap:8px; margin-bottom:20px;">
    <input type="text" id="func1" placeholder="x(t)"
           onfocus="setActiveField(this)"
           style="width:45%; padding:8px; border:1px solid #ccd0d5; border-radius:4px; font-size:1em;" />
    <span style="font-size:1.5em; font-weight:bold; position:relative; top:-4px;">*</span>
    <input type="text" id="func2" placeholder="h(t)"
           onfocus="setActiveField(this)"
           style="width:45%; padding:8px; border:1px solid #ccd0d5; border-radius:4px; font-size:1em;" />
  </div>

  <!-- Funktions-Buttons in einer Zeile -->
  <div class="quick-buttons functions"
       style="display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin-bottom:10px;">
    <button type="button" onclick="insertOperand('rect(t)')">\(\mathrm{rect}\)</button>
    <button type="button" onclick="insertOperand('tri(t)')">\(\mathrm{tri}\)</button>
    <button type="button" onclick="insertOperand('sin(pi*t)')">\(\sin\)</button>
    <button type="button" onclick="insertOperand('cos(pi*t)')">\(\cos\)</button>
    <button type="button" onclick="insertOperand('delta(t)')">\(\delta\)</button>
    <button type="button" onclick="insertOperand('step(t)')">\(\mathrm{step}\)</button>
    <button type="button" onclick="insertOperand('sign(t)')">\(\mathrm{sign}\)</button>
    <button type="button" onclick="insertOperand('exp_iwt(t)')">\(\mathrm{e}^{\mathrm{j}\omega t}\)</button>
    <button type="button" onclick="insertOperand('exp(t)*step(-t)')">\(\mathrm{e}^t\)</button>
    <button type="button" onclick="insertOperand('exp(-t)*step(t)')">\(\mathrm{e}^{-t}\)</button>
    <button type="button" onclick="insertOperand('inv_t(t)')">\(\frac{1}{t}\)</button>
    <button type="button" onclick="insertOperand('si(pi*t)')">\(\mathrm{si}\)</button>
    <button type="button" onclick="insertOperand('si(pi*t)**2')">\(\mathrm{si}^2\)</button>
  </div>
  <!-- Operator-Buttons in der nächsten Zeile -->
  <div class="quick-buttons operators"
       style="display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin-bottom:20px;">
    <button type="button" onclick="insertOperand('+')">\(+\)</button>
    <button type="button" onclick="insertOperand('-')">\(-\)</button>
    <button type="button" onclick="insertOperand('*')">\(\cdot\)</button>
    <button type="button" onclick="insertOperand('/')">\(/\)</button>
  </div>

  <!-- Compute / Clear -->
  <div style="margin-bottom:30px;">
    <button type="button" id="computeBtn" class="action-btn">Compute</button>
    <button type="button" id="clearBtn"   class="action-btn">Clear</button>
  </div>
</form>

<!-- Plotly-Container -->
<div id="plotly-container" style="max-width:1200px; margin:0 auto;">
  <div id="plot1"      style="height:250px;"></div>
  <div id="plot2"      style="height:250px; margin-top:-20px;"></div>
  <div id="plotConv"   style="height:250px; margin-top:-20px;"></div>
</div>

<script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/convolution_compute.js') }}"></script>
<script>
  let activeField = document.getElementById("func1");
  function setActiveField(f) { activeField = f; }
  document.getElementById("func1").addEventListener("focus", e => activeField = e.target);
  document.getElementById("func2").addEventListener("focus", e => activeField = e.target);

  const errorMsg = document.getElementById("errorMsg");
  const func1 = document.getElementById("func1");
  const func2 = document.getElementById("func2");

  function clearErrors(){
    [func1, func2].forEach(el => el.classList.remove('input-error'));
    if(errorMsg) errorMsg.textContent = "";
  }

  function insertOperand(op) {
    if (!activeField) return alert("Click in an input field first.");
    const s = activeField.selectionStart, e = activeField.selectionEnd, v = activeField.value;
    activeField.value = v.slice(0, s) + op + v.slice(e);
    activeField.selectionStart = activeField.selectionEnd = s + op.length;
    activeField.focus();
  }

  function getValues() {
    return {
      func1: func1.value,
      func2: func2.value
    };
  }

  function updatePlots() {
    clearErrors();
    const vals = getValues();
    const data = compute_convolution(vals.func1, vals.func2);
    if (data.error){
      if(errorMsg) errorMsg.textContent = data.error;
      if(/Function 1/.test(data.error)) func1.classList.add('input-error');
      if(/Function 2/.test(data.error)) func2.classList.add('input-error');
      console.error(data.error);
      return;
    }
      const lc = { margin: { t: 30 } };

      Plotly.newPlot("plot1", [{
        x: data.t1, y: data.y1,
        type: "scatter", mode: "lines", name: "x(t)",
        line: { width: 3, color: "#1f77b4" }
      }], { ...lc, xaxis: { title: {text:"t"} }, yaxis: { title: {text:"x(t)"}} });

      Plotly.newPlot("plot2", [{
        x: data.t2, y: data.y2,
        type: "scatter", mode: "lines", name: "h(t)",
        line: { width: 3, color: "#ff7f0e" }
      }], { ...lc, xaxis: { title: {text:"t"} }, yaxis: { title: {text:"h(t)"} } });

      Plotly.newPlot("plotConv", [{
        x: data.t_conv, y: data.y_conv,
        type: "scatter", mode: "lines", name: "Convolution",
        line: { width: 3, color: "#2ca02c" }
      }], { ...lc, xaxis: { title: {text:"t"} }, yaxis: { title: {text:"y(t)"} } });

  }

  document.getElementById("computeBtn").addEventListener("click", updatePlots);
  const convForm = document.getElementById("convForm");
  if (convForm) {
    convForm.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        updatePlots();
      }
    });
  }
  document.getElementById("clearBtn").addEventListener("click", () => {
    func1.value = "";
    func2.value = "";
    clearErrors();
    Plotly.purge("plot1");
    Plotly.purge("plot2");
    Plotly.purge("plotConv");
  });
</script>

<style>
  /* Quick-Buttons (Functions & Operators) – etwas kompakter */
  .quick-buttons.functions button,
  .quick-buttons.operators button {
    padding: 8px 12px;        /* etwas weniger Innenabstand */
    font-size: 0.9em;         /* kleinere Schrift */
    min-width: 60px;          /* geringere Mindestbreite */
    border-radius: 4px;
    background-color: var(--primary-color);
    color: #fff;
    border: none;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  .quick-buttons.functions button:hover,
  .quick-buttons.operators button:hover {
    background-color: var(--primary-color-darker);
  }

  /* Action-Buttons (Compute / Clear) – etwas kompakter */
  .action-btn {
    padding: 8px 20px;        /* weniger Innenabstand */
    font-size: 0.9em;         /* kleinere Schrift */
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  #computeBtn {
    background-color: var(--lms-green-darker);
    color: #fff;
    margin-right: 6px;
  }
  #computeBtn:hover {
    background-color: var(--lms-green-dark);
  }
  #clearBtn {
    background-color: var(--lms-red);
    color: #fff;
  }
  #clearBtn:hover {
    background-color: var(--lms-red-darker);
  }

  input.input-error {
    border-color: var(--lms-red);
  }
</style>
{% endblock %}
