{% extends "base.html" %}
{% block content %}
  <div class="page-header" style="margin-bottom:30px; text-align:center;">
    <h1 style="font-size:2.5em;">Autocorrelation Calculator</h1>
  <p style="font-size:1.1em; color:var(--subtext-color); max-width:600px; margin:0 auto;">
    Insert an energy signal \(x(t)\) and plot its autocorrelation according to
    $$ \begin{align}
    \varphi_{xx}^\mathrm E(\tau) &= \int_{-\infty}^{\infty} x(t+\tau)x^\ast(t)\mathrm dt \\
    &= x(\tau)\ast x^\ast(-\tau).
    \end{align} $$
  </p>
</div>

<p id="errorMsg" style="max-width:700px;margin:0 auto 16px auto;color:#d00;text-align:center;font-weight:bold;"></p>

<form id="acorrForm" style="max-width:800px; margin:0 auto; text-align:center;">
  <div class="function-group" style="display:flex; justify-content:center; align-items:center; gap:8px; margin-bottom:20px;">
    <input type="text" id="func" placeholder="x(t)" onfocus="setActiveField(this)" style="width:90%; padding:8px; border:1px solid #ccd0d5; border-radius:4px; font-size:1em;" />
  </div>

  <div class="quick-buttons functions" style="display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin-bottom:10px;">
    <button type="button" onclick="insertOperand('rect(t)')">\(\mathrm{rect}\)</button>
    <button type="button" onclick="insertOperand('tri(t)')">\(\mathrm{tri}\)</button>
    <button type="button" onclick="insertOperand('sin(pi*t)*rect(t/4)')">\(\sin\)</button>
    <button type="button" onclick="insertOperand('cos(pi*t)*rect(t/4)')">\(\cos\)</button>
    <button type="button" onclick="insertOperand('exp_iwt(pi*t)*rect(t/4)')">\(\mathrm e^{\mathrm{j}\omega t}\)</button>
    <button type="button" onclick="insertOperand('exp(t)*step(-t)')">\(\mathrm e^{t}\)</button>
    <button type="button" onclick="insertOperand('exp(-t)*step(t)')">\(\mathrm e^{-t}\)</button>
    <button type="button" onclick="insertOperand('inv_t(t)*step(t)')">\(\frac{1}{t}\)</button>
    <button type="button" onclick="insertOperand('si(pi*t)')">\(\mathrm{si}\)</button>
    <button type="button" onclick="insertOperand('(si(pi*t))**2')">\(\mathrm{si}^2\)</button>
  </div>

  <div class="quick-buttons operators" style="display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin-bottom:20px;">
    <button type="button" onclick="insertOperand('+')">\(+\)</button>
    <button type="button" onclick="insertOperand('-')">\(-\)</button>
    <button type="button" onclick="insertOperand('*')">\(\cdot\)</button>
    <button type="button" onclick="insertOperand('/')">\(/\)</button>
  </div>

  <div style="margin-bottom:30px;">
    <button type="button" id="computeBtn" class="action-btn">Compute</button>
    <button type="button" id="clearBtn"   class="action-btn">Clear</button>
  </div>
</form>

<div id="plotly-container" style="max-width:1200px; margin:0 auto;">
  <div id="plotSignal" style="height:220px;"></div>
  <div id="plotAuto"   style="height:220px; margin-top:-20px;"></div>
</div>

<script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/convolution_compute.js') }}"></script>
  <script src="{{ url_for('static', filename='js/autocorrelation_compute.js') }}"></script>
  <script>
    let activeField = document.getElementById("func");
    const errorMsg = document.getElementById("errorMsg");
    const funcInput = document.getElementById("func");

    function setActiveField(f){ activeField = f; }
    document.getElementById("func").addEventListener("focus", e => activeField = e.target);

    function clearErrors(){
      funcInput.classList.remove('input-error');
      if(errorMsg) errorMsg.textContent = "";
    }

    function insertOperand(op){
      if(!activeField) return alert("Click in an input field first.");
      const s = activeField.selectionStart, e = activeField.selectionEnd, v = activeField.value;
      activeField.value = v.slice(0, s) + op + v.slice(e);
      activeField.selectionStart = activeField.selectionEnd = s + op.length;
      activeField.focus();
    }

    function getValues(){
      return { func: document.getElementById("func").value };
    }

    function updatePlots(){
      clearErrors();
      const vals = getValues();
      const data = compute_autocorrelation(vals.func);
      if(data.error){
        if(errorMsg) errorMsg.textContent = data.error;
        funcInput.classList.add('input-error');
        console.error(data.error);
        return;
      }

      const lc = { margin:{ t:30 } };

      Plotly.newPlot("plotSignal", [
        { x: data.t,   y: data.y_re, mode: "lines", name: "Re{x(t)}",
          line: { width:2, color: "#1f77b4" } },
        { x: data.t,   y: data.y_im, mode: "lines", name: "Im{x(t)}",
          line: { width:2, color: "#d62728", dash: "dot" } }
      ], { ...lc, xaxis:{ title:{text:"t"} }, yaxis:{ title:{text:"x(t)"} } });

      Plotly.newPlot("plotAuto", [
      { x: data.tau, y: data.r_re, mode: "lines", name: "Re{φₓₓ(τ)}",
        line: { width:2, color: "#2ca02c" } },
      { x: data.tau, y: data.r_im, mode: "lines", name: "Im{φₓₓ(τ)}",
        line: { width:2, color: "#ff7f0e", dash: "dot" } }
    ], { ...lc, xaxis:{ title:{text:"τ"} }, yaxis:{ title:{text:"φₓₓ(τ)"} } });
    }

    document.getElementById("computeBtn").addEventListener("click", updatePlots);
    const acorrForm = document.getElementById("acorrForm");
    if (acorrForm) {
      acorrForm.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          updatePlots();
        }
      });
    }
    document.getElementById("clearBtn").addEventListener("click", () => {
      document.getElementById("func").value = "";
      Plotly.purge("plotSignal");
      Plotly.purge("plotAuto");
      clearErrors();
    });
  </script>

<style>
  .quick-buttons.functions button,
  .quick-buttons.operators button {
    padding: 8px 12px;
    font-size: 0.9em;
    min-width: 60px;
    border-radius: 4px;
    background-color: #007acc;
    color: #fff;
    border: none;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  .quick-buttons.functions button:hover,
  .quick-buttons.operators button:hover {
    background-color: #005fa3;
  }
  .action-btn {
    padding: 8px 20px;
    font-size: 0.9em;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  #computeBtn {
    background-color: #28a745;
    color: #fff;
    margin-right: 6px;
  }
  #computeBtn:hover {
    background-color: #218838;
  }
  #clearBtn {
    background-color: #dc3545;
    color: #fff;
  }
  #clearBtn:hover {
    background-color: #c82333;
  }
input.input-error{border-color:#d00;}

</style>
{% endblock %}