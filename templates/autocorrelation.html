{% extends "base.html" %}
{% block content %}
<div class="page-header" style="margin-bottom:30px; text-align:center;">
  <h1 style="font-size:2.5em;">Autocorrelation Calculator</h1>
  <p style="font-size:1.1em; color:var(--subtext-color); max-width:600px; margin:0 auto;">
    Enter <strong>x(t)</strong> to compute its autocorrelation
    $$ \phi_{xx}(\tau)=\int_{-\infty}^{\infty} x(t)\,x^*(\tau-t)\,dt $$
  </p>
</div>

<form id="acorrForm" style="max-width:800px; margin:0 auto; text-align:center;">
  <div class="function-group" style="display:flex; justify-content:center; align-items:center; gap:8px; margin-bottom:20px;">
    <input type="text" id="func" placeholder="x(t)" onfocus="setActiveField(this)" style="width:90%; padding:8px; border:1px solid #ccd0d5; border-radius:4px; font-size:1em;" />
  </div>

  <div class="quick-buttons functions" style="display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin-bottom:10px;">
    <button type="button" onclick="insertOperand('rect(t)')">Rect</button>
    <button type="button" onclick="insertOperand('tri(t)')">Tri</button>
    <button type="button" onclick="insertOperand('sin(t)')">Sin</button>
    <button type="button" onclick="insertOperand('cos(t)')">Cos</button>
    <button type="button" onclick="insertOperand('step(t)')">Step</button>
    <button type="button" onclick="insertOperand('delta(t)')">Delta</button>
    <button type="button" onclick="insertOperand('sign(t)')">Sign</button>
    <button type="button" onclick="insertOperand('exp_iwt(t)')">e^(iωt)</button>
    <button type="button" onclick="insertOperand('exp(t)')">Exp</button>
    <button type="button" onclick="insertOperand('inv_t(t)')">1/t</button>
    <button type="button" onclick="insertOperand('si(t)')">Si</button>
    <button type="button" onclick="insertOperand('si(t)**2')">Si²</button>
  </div>

  <div class="quick-buttons operators" style="display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin-bottom:20px;">
    <button type="button" onclick="insertOperand('+')">+</button>
    <button type="button" onclick="insertOperand('-')">-</button>
    <button type="button" onclick="insertOperand('*')">*</button>
    <button type="button" onclick="insertOperand('/')">/</button>
  </div>

  <div style="margin-bottom:30px;">
    <button type="button" id="computeBtn" class="action-btn">Compute</button>
    <button type="button" id="clearBtn"   class="action-btn">Clear</button>
  </div>
</form>

<div id="plotly-container" style="max-width:1200px; margin:0 auto;">
  <div id="plotSignal" style="height:350px;"></div>
  <div id="plotAuto"   style="height:350px; margin-top:20px;"></div>
</div>

<script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/convolution_compute.js') }}"></script>
<script src="{{ url_for('static', filename='js/autocorrelation_compute.js') }}"></script>
<script>
  let activeField = document.getElementById("func");
  function setActiveField(f){ activeField = f; }
  document.getElementById("func").addEventListener("focus", e => activeField = e.target);

  function insertOperand(op){
    if(!activeField) return alert("Click in an input field first.");
    const s = activeField.selectionStart, e = activeField.selectionEnd, v = activeField.value;
    activeField.value = v.slice(0, s) + op + v.slice(e);
    activeField.selectionStart = activeField.selectionEnd = s + op.length;
    activeField.focus();
  }

  function getValues(){
    return { func: document.getElementById("func").value };
  }

  function updatePlots(){
    const vals = getValues();
    const data = compute_autocorrelation(vals.func);
    if(data.error) return console.error(data.error);
    const lc = { margin:{ t:30 }, showlegend:true };

    Plotly.newPlot("plotSignal", [{
      x: data.t, y: data.y1,
      type: "scatter", mode: "lines", name: "x(t)",
      line: { width:3, color: "#1f77b4" }
    }], { ...lc, title:"x(t)", xaxis:{ title:"t" }, yaxis:{ title:"x(t)" } });

    Plotly.newPlot("plotAuto", [{
      x: data.t, y: data.y_conv,
      type: "scatter", mode: "lines", name: "Autocorrelation",
      line: { width:3, color: "#2ca02c" }
    }], { ...lc, title:"φ_xx(τ)", xaxis:{ title:"τ" }, yaxis:{ title:"φ_xx(τ)" } });
  }

  document.getElementById("computeBtn").addEventListener("click", updatePlots);
  document.getElementById("clearBtn").addEventListener("click", () => {
    document.getElementById("func").value = "";
    Plotly.purge("plotSignal");
    Plotly.purge("plotAuto");
  });
</script>

<style>
  .quick-buttons.functions button,
  .quick-buttons.operators button {
    padding: 8px 12px;
    font-size: 0.9em;
    min-width: 60px;
    border-radius: 4px;
    background-color: #007acc;
    color: #fff;
    border: none;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  .quick-buttons.functions button:hover,
  .quick-buttons.operators button:hover {
    background-color: #005fa3;
  }
  .action-btn {
    padding: 8px 20px;
    font-size: 0.9em;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  #computeBtn {
    background-color: #28a745;
    color: #fff;
    margin-right: 6px;
  }
  #computeBtn:hover {
    background-color: #218838;
  }
  #clearBtn {
    background-color: #dc3545;
    color: #fff;
  }
  #clearBtn:hover {
    background-color: #c82333;
  }
</style>
{% endblock %}