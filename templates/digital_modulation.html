{% extends "base.html" %}
{% block title %}Digital Modulation Lab{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Digital Modulation Lab</h1>
  <p class="text-muted">Experiment with pulse and sampled modulation schemes (PAM/PWM/PPM/PCM) separate from the analog toolbox.</p>
</div>

<style>
  /* Shared module layout */
  .module-wrap { display: grid; grid-template-columns: 1fr; gap: 16px; }
  .card { border: 1px solid var(--border-color, #ddd); border-radius: 10px; padding: 12px; background: var(--surface, #fff); }
  .intro-card { margin-bottom: 8px; }
  .section-title { margin: 0 0 8px; font-size: 1.15rem; font-weight: 600; color: var(--text-strong, #222); }
  .section-list { margin: 0; padding-left: 20px; }
  .section-subtitle { margin: 8px 0 0; color: var(--text-muted, #666); font-size: 0.9rem; }
  .h { font-weight: 700; margin: 8px 0; }
  .muted { color: #666; font-size: .9rem; }
  .pad { padding: 4px 0; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; color: #666; }
  .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; align-items: end; }
  .plots { display: grid; grid-template-columns: 1fr; gap: 16px; }
  .plot-block { display: flex; flex-direction: column; }
  .plot-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--text-strong, #222); }
  .plot { min-height: 340px; }
  label { display:flex; flex-direction: column; gap: 4px; font-size: 0.9rem; }
  select,
  input[type="range"] { font-size: 0.9rem; }
  select { padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border-color, #ccc); max-width: 220px; }
  input[type="range"] { width: 100%; height: 22px; }
  .row small { font-size: 0.75rem; }
  .intro-card dl { margin: 12px 0 0; }
  .intro-card dt { font-weight: 600; }
  .intro-card dd { margin: 0 0 8px; color: var(--text, #333); font-size: 0.92rem; }
  .pam-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; align-items: end; }
  .pam-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
  .pam-plots { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
  .pam-facts { margin-top: 8px; font-size: 0.88rem; color: var(--text-muted, #666); }
  .passband-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; align-items: end; }
  .passband-plots { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; }
  .passband-facts { margin-top: 8px; font-size: 0.88rem; color: var(--text-muted, #666); }
  @media (max-width: 768px) {
    .row { grid-template-columns: 1fr 1fr; }
    .pam-plots { grid-template-columns: 1fr; }
    .passband-plots { grid-template-columns: 1fr; }
    select { max-width: 100%; }
  }
  @media (max-width: 540px) {
    .row { grid-template-columns: 1fr; }
  }
</style>

<div class="module-wrap">
  <div class="card intro-card">
    <h2 class="section-title">How the digital modulation lab fits together</h2>
    <p>
      The page generates discrete message samples \(m[k]\) and maps them to pulses \(s(t)\) using the modulation
      scheme you choose.  The sampling frequency must satisfy \(f_s \ge 2 f_m\) to avoid aliasing, while the pulse
      repetition frequency sets the symbol spacing \(T_p = 1/\mathrm{PRF}\).  Additive white Gaussian noise models the
      channel with a signal-to-noise ratio
      \(\mathrm{SNR} = 10 \log_{10}\!\left(\tfrac{P_s}{P_n}\right)\,\text{dB}\), which you can sweep below.
    </p>
    <dl>
      <dt>PAM/PWM/PPM</dt>
      <dd>Encode the amplitude, width, or timing of each pulse in proportion to the sample \(m[k]\).</dd>
      <dt>PCM</dt>
      <dd>Quantises samples into \(L\) discrete levels before line coding, showing quantisation noise in the spectra.</dd>
      <dt>Spectra</dt>
      <dd>Toggle the spectral plots to compare transmitted and recovered signals after demodulation.</dd>
    </dl>
  </div>
  <div class="card">
    <div class="h">Digital modulation controls</div>

    <div class="row">
      <label>Preset:
        <select id="dig_preset">
          <option value="">— choose preset —</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label>Type (mod):
        <select id="dig_mod_type">
          <option>PAM</option><option>PWM</option><option>PPM</option><option>PCM</option>
        </select>
      </label>
      <label>Type (demod):
        <select id="dig_demod_type">
          <option>PAM</option><option>PWM</option><option>PPM</option><option>PCM</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label>fs [Hz]
        <input id="dig_fs" type="range" min="500" max="20000" step="100" value="2000">
        <div><small id="dig_fs_val">2000</small></div>
      </label>
      <label>Duration [s]
        <input id="dig_t_end" type="range" min="0.2" max="3.0" step="0.1" value="1.0">
        <div><small id="dig_t_end_val">1.0</small></div>
      </label>
    </div>

    <div id="dig_pulse_controls" class="card">
      <div class="h">Pulse parameters</div>
      <div class="row">
        <label>PRF [Hz]
          <input id="dig_prf" type="range" min="5" max="200" step="1" value="40">
          <div><small id="dig_prf_val">40</small></div>
        </label>
        <label>fm [Hz]
          <input id="dig_fm" type="range" min="1" max="50" step="1" value="4">
          <div><small id="dig_fm_val">4</small></div>
        </label>
      </div>
      <div id="dig_pcm_levels_group">
        <label>PCM levels
          <input id="dig_levels" type="range" min="2" max="64" step="1" value="8">
          <div><small id="dig_levels_val">8</small></div>
        </label>
      </div>
    </div>


    <div class="card">
      <div class="h">Noise &amp; Spectrum</div>
      <div class="row">
        <label><input type="checkbox" id="dig_snr_toggle" checked> Add AWGN</label>
        <label>SNR [dB]
          <input id="dig_snr_db" type="range" min="0" max="50" step="1" value="30">
          <div><small id="dig_snr_db_val">30</small></div>
        </label>
      </div>
      <label class="pad"><input type="checkbox" id="dig_show_spectrum" checked> Show spectra</label>
    </div>

    <div class="muted" id="dig_facts"></div>
  </div>

  <div class="card">
    <div class="plots">
      <div class="plot-block">
        <div class="plot-title">Modulation &mdash; time domain</div>
        <div id="dig_mod_plot" class="plot"></div>
      </div>
      <div class="plot-block">
        <div class="plot-title">Demodulation &mdash; time domain</div>
        <div id="dig_demod_plot" class="plot"></div>
      </div>
      <div class="plot-block">
        <div class="plot-title">Modulation spectrum</div>
        <div id="dig_mod_spec" class="plot"></div>
      </div>
      <div class="plot-block">
        <div class="plot-title">Demodulation spectrum</div>
        <div id="dig_demod_spec" class="plot"></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="h">Coherent passband link (carrier-modulated digital)</div>
    <p class="muted">
      Compare how BPSK, QPSK, and 16-QAM behave when an RF carrier suffers frequency and phase errors.
      Toggle the Costas loop to mimic a carrier recovery stage and watch the constellation collapse back into place.
    </p>

    <div class="passband-controls">
      <label>Scheme
        <select id="pass_scheme">
          <option value="BPSK">BPSK</option>
          <option value="QPSK">QPSK</option>
          <option value="16QAM">16-QAM</option>
        </select>
      </label>
      <label>Carrier [Hz]
        <input id="pass_carrier" type="range" min="500" max="6000" step="100" value="2000">
        <div><small id="pass_carrier_val">2000</small></div>
      </label>
      <label>Symbol rate [baud]
        <input id="pass_symbol_rate" type="range" min="50" max="1500" step="50" value="400">
        <div><small id="pass_symbol_rate_val">400</small></div>
      </label>
      <label>Carrier offset [Hz]
        <input id="pass_offset" type="range" min="-400" max="400" step="10" value="80">
        <div><small id="pass_offset_val">80</small></div>
      </label>
      <label>Phase offset [deg]
        <input id="pass_phase" type="range" min="-180" max="180" step="5" value="45">
        <div><small id="pass_phase_val">45</small></div>
      </label>
      <label>Samples / symbol
        <input id="pass_sps" type="range" min="4" max="32" step="2" value="16">
        <div><small id="pass_sps_val">16</small></div>
      </label>
      <label style="flex-direction: row; align-items: center; gap: 8px;">
        <input type="checkbox" id="pass_costas" checked>
        Costas loop on
      </label>
    </div>

    <div id="passband_info" class="passband-facts"></div>
  </div>

  <div class="card">
    <div class="passband-plots">
      <div class="plot-block">
        <div class="plot-title">Passband waveforms</div>
        <div id="passband_wave_plot" class="plot"></div>
      </div>
      <div class="plot-block">
        <div class="plot-title">Baseband I/Q vs. time</div>
        <div id="passband_iq_plot" class="plot"></div>
      </div>
      <div class="plot-block">
        <div class="plot-title">Constellation at symbol sampling</div>
        <div id="passband_constellation_plot" class="plot"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="h">Digital PAM (M-PAM) simulation</div>
    <p class="muted">Shape baseband symbols with a root-raised cosine pulse, add AWGN, and recover with a matched filter. Toggle the TX/RX pulse shaping to explore inter-symbol interference.</p>

    <div class="pam-controls">
      <label>Order (M)
        <select id="pam_m">
          <option value="2">2 (BPSK)</option>
          <option value="4" selected>4</option>
          <option value="8">8</option>
          <option value="16">16</option>
        </select>
      </label>
      <label>Rolloff α
        <input id="pam_rolloff" type="range" min="0" max="1" step="0.05" value="0.35">
        <div><small id="pam_rolloff_val">0.35</small></div>
      </label>
      <label>Samples / symbol
        <input id="pam_sps" type="range" min="2" max="16" step="1" value="8">
        <div><small id="pam_sps_val">8</small></div>
      </label>
      <label>Filter span [symbols]
        <input id="pam_span" type="range" min="4" max="12" step="1" value="8">
        <div><small id="pam_span_val">8</small></div>
      </label>
      <label>Eb/N<sub>0</sub> [dB]
        <input id="pam_snr" type="range" min="0" max="20" step="1" value="12">
        <div><small id="pam_snr_val">12</small></div>
      </label>
      <label>Symbols simulated
        <input id="pam_symbols" type="range" min="400" max="4000" step="200" value="2000">
        <div><small id="pam_symbols_val">2000</small></div>
      </label>
    </div>

    <div class="pam-controls" style="margin-top:12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
      <label style="flex-direction: row; align-items: center; gap: 8px;">
        <input type="checkbox" id="pam_disable_tx">
        Disable TX RRC (introduce ISI)
      </label>
      <label style="flex-direction: row; align-items: center; gap: 8px;">
        <input type="checkbox" id="pam_disable_rx">
        Disable RX matched filter
      </label>
    </div>

    <div id="pam_facts" class="pam-facts"></div>
  </div>

  <div class="card">
    <div class="pam-grid">
      <div class="plot-block">
        <div class="plot-title">Constellation after matched filter</div>
        <div id="pam_constellation_plot" class="plot"></div>
      </div>
      <div class="plot-block">
        <div class="plot-title">Eye diagram</div>
        <div id="pam_eye_plot" class="plot"></div>
      </div>
      <div class="plot-block">
        <div class="plot-title">BER vs. theory</div>
        <div id="pam_ber_plot" class="plot"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script>
    (function () {
      const root = "{{ request.script_root }}";
      window.DIG_URLS = {
        presets: root + "/digital_modulation/api/presets",
        modulate: root + "/digital_modulation/api/modulate",
        demod: root + "/digital_modulation/api/demodulate",
        mpam: root + "/digital_modulation/api/m_pam",
        passband: root + "/digital_modulation/api/passband"
      };
    })();
  </script>

  <script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/digital_modulation.js') }}"></script>
{% endblock %}
